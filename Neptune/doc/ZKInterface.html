<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class ZKInterface - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>Neptune/lib/zkinterface.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="Object.html">Object</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-add_app_entry">::add_app_entry</a>
    
    <li><a href="#method-c-add_app_instance">::add_app_instance</a>
    
    <li><a href="#method-c-add_ip_to_ip_list">::add_ip_to_ip_list</a>
    
    <li><a href="#method-c-add_roles_to_node">::add_roles_to_node</a>
    
    <li><a href="#method-c-find_open_nodes_in_cloud">::find_open_nodes_in_cloud</a>
    
    <li><a href="#method-c-get_app_hosters">::get_app_hosters</a>
    
    <li><a href="#method-c-get_app_instances_for_ip">::get_app_instances_for_ip</a>
    
    <li><a href="#method-c-get_appcontroller_lock">::get_appcontroller_lock</a>
    
    <li><a href="#method-c-get_appcontroller_state">::get_appcontroller_state</a>
    
    <li><a href="#method-c-get_failed_nodes">::get_failed_nodes</a>
    
    <li><a href="#method-c-get_ip_info">::get_ip_info</a>
    
    <li><a href="#method-c-get_job_data_for_ip">::get_job_data_for_ip</a>
    
    <li><a href="#method-c-get_max_machines_for_babel_slaves">::get_max_machines_for_babel_slaves</a>
    
    <li><a href="#method-c-init">::init</a>
    
    <li><a href="#method-c-init_to_ip">::init_to_ip</a>
    
    <li><a href="#method-c-is_node_done_loading-3F">::is_node_done_loading?</a>
    
    <li><a href="#method-c-is_node_live-3F">::is_node_live?</a>
    
    <li><a href="#method-c-lock_and_run">::lock_and_run</a>
    
    <li><a href="#method-c-reinitialize">::reinitialize</a>
    
    <li><a href="#method-c-release_appcontroller_lock">::release_appcontroller_lock</a>
    
    <li><a href="#method-c-remove_app_entry">::remove_app_entry</a>
    
    <li><a href="#method-c-remove_ip_from_ip_list">::remove_ip_from_ip_list</a>
    
    <li><a href="#method-c-remove_node_information">::remove_node_information</a>
    
    <li><a href="#method-c-remove_roles_from_node">::remove_roles_from_node</a>
    
    <li><a href="#method-c-set_done_loading">::set_done_loading</a>
    
    <li><a href="#method-c-set_job_data_for_ip">::set_job_data_for_ip</a>
    
    <li><a href="#method-c-set_live_node_ephemeral_link">::set_live_node_ephemeral_link</a>
    
    <li><a href="#method-c-set_max_machines_for_babel_slaves">::set_max_machines_for_babel_slaves</a>
    
    <li><a href="#method-c-update_ips_timestamp">::update_ips_timestamp</a>
    
    <li><a href="#method-c-write_appcontroller_state">::write_appcontroller_state</a>
    
    <li><a href="#method-c-write_node_information">::write_node_information</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./Datastore.html">Datastore</a>
  
    <li><a href="./DatastoreFactory.html">DatastoreFactory</a>
  
    <li><a href="./DatastoreRepo.html">DatastoreRepo</a>
  
    <li><a href="./DatastoreRepoOnAppEngine.html">DatastoreRepoOnAppEngine</a>
  
    <li><a href="./DatastoreRepoOnAppScale.html">DatastoreRepoOnAppScale</a>
  
    <li><a href="./DatastoreS3.html">DatastoreS3</a>
  
    <li><a href="./DatastoreWAZStorage.html">DatastoreWAZStorage</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./EngineFactory.html">EngineFactory</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GoogleAppEnginePullQueue.html">GoogleAppEnginePullQueue</a>
  
    <li><a href="./GoogleAppEnginePushQueue.html">GoogleAppEnginePushQueue</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./NeptuneJobData.html">NeptuneJobData</a>
  
    <li><a href="./NeptuneManager.html">NeptuneManager</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./NeptuneManagerServer.html">NeptuneManagerServer</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./QueueFactory.html">QueueFactory</a>
  
    <li><a href="./TaskEngine.html">TaskEngine</a>
  
    <li><a href="./TaskEngineAppScale.html">TaskEngineAppScale</a>
  
    <li><a href="./TaskEngineGoogleAppEngine.html">TaskEngineGoogleAppEngine</a>
  
    <li><a href="./TaskQueue.html">TaskQueue</a>
  
    <li><a href="./TaskQueueAzureQueue.html">TaskQueueAzureQueue</a>
  
    <li><a href="./TaskQueueGoogleAppEngine.html">TaskQueueGoogleAppEngine</a>
  
    <li><a href="./TaskQueueRabbitMQ.html">TaskQueueRabbitMQ</a>
  
    <li><a href="./TaskQueueSQS.html">TaskQueueSQS</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
    <li><a href="./ZooKeeperLockException.html">ZooKeeperLockException</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class ZKInterface</h1>

  <div id="description" class="description">
    
<p>The AppController employs the open source software ZooKeeper as a highly
available naming service, to store and retrieve information about the
status of applications hosted within AppScale. This class provides methods
to communicate with ZooKeeper, and automates commonly performed functions
by the AppController.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="APPCONTROLLER_LOCK_PATH">APPCONTROLLER_LOCK_PATH
        
        <dd class="description"><p>The location in ZooKeeper that nodes will try to acquire an ephemeral node
for, to use as a lock.</p>
        
      
        <dt id="APPCONTROLLER_NODE_PATH">APPCONTROLLER_NODE_PATH
        
        <dd class="description"><p>The location in ZooKeeper that AppControllers write information about their
node to, so that others can poll to see if they are alive and what roles
they’ve taken on.</p>
        
      
        <dt id="APPCONTROLLER_PATH">APPCONTROLLER_PATH
        
        <dd class="description"><p>The location in ZooKeeper where AppControllers can read and write data to.</p>
        
      
        <dt id="APPCONTROLLER_STATE_PATH">APPCONTROLLER_STATE_PATH
        
        <dd class="description"><p>The location in ZooKeeper where the Shadow node will back up its state to,
and where other nodes will recover that state from.</p>
        
      
        <dt id="APP_INSTANCE">APP_INSTANCE
        
        <dd class="description"><p>The name of the file that nodes use to store the list of Google App Engine
instances that the given node runs.</p>
        
      
        <dt id="BABEL_MAX_MACHINES_PATH">BABEL_MAX_MACHINES_PATH
        
        <dd class="description"><p>The location in ZooKeeper that the Babel Master’s threads read and write
to, to determine the maximum number of machines that should be used to run
Babel tasks.</p>
        
      
        <dt id="BABEL_PATH">BABEL_PATH
        
        <dd class="description"><p>The location in ZooKeeper that the Babel Master and Slaves will read and
write data to that should be globally accessible or fault-tolerant.</p>
        
      
        <dt id="DUMMY_DATA">DUMMY_DATA
        
        <dd class="description"><p>The contents of files in ZooKeeper whose contents we don’t care about
(e.g., where we care that’s an ephemeral file or needed just to provide a
hierarchical filesystem-like interface).</p>
        
      
        <dt id="EPHEMERAL">EPHEMERAL
        
        <dd class="description">
        
      
        <dt id="IP_LIST">IP_LIST
        
        <dd class="description"><p>The location in ZooKeeper that contains a list of the IP addresses that are
currently running within AppScale.</p>
        
      
        <dt id="NOT_EPHEMERAL">NOT_EPHEMERAL
        
        <dd class="description">
        
      
        <dt id="ROOT_APP_PATH">ROOT_APP_PATH
        
        <dd class="description">
        
      
        <dt id="SERVER_PORT">SERVER_PORT
        
        <dd class="description"><p>The port that ZooKeeper runs on in AppScale deployments.</p>
        
      
        <dt id="ZK_OPERATION_TIMEOUT">ZK_OPERATION_TIMEOUT
        
        <dd class="description"><p>The maximum amount of time that we should wait for an arbitrary ZooKeeper
call to take before we believe it’s timed out.</p>
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-add_app_entry" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_app_entry</span><span
            class="method-args">(appname, ip, location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="add_app_entry-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 144</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">add_app_entry</span>(<span class="ruby-identifier">appname</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">location</span>)
  <span class="ruby-identifier">appname_path</span> = <span class="ruby-constant">ROOT_APP_PATH</span> <span class="ruby-operator">+</span> <span class="ruby-node">&quot;/#{appname}&quot;</span>
  <span class="ruby-identifier">full_path</span> = <span class="ruby-identifier">appname_path</span> <span class="ruby-operator">+</span> <span class="ruby-node">&quot;/#{ip}&quot;</span>

  <span class="ruby-comment"># can't just create path in ZK</span>
  <span class="ruby-comment"># need to do create the nodes at each level</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">ROOT_APP_PATH</span>, <span class="ruby-constant">DUMMY_DATA</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">appname_path</span>, <span class="ruby-constant">DUMMY_DATA</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">full_path</span>, <span class="ruby-identifier">location</span>, <span class="ruby-constant">EPHEMERAL</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_app_entry-source -->
          
        </div>

        

        
      </div><!-- add_app_entry-method -->

    
      <div id="method-c-add_app_instance" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_app_instance</span><span
            class="method-args">(app_name, ip, port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Adds an entry to ZooKeeper for the given IP, storing information about the
Google App engine application it is hosting that can be used to update the
AppLoadBalancer should that node fail.</p>
          

          
          <div class="method-source-code" id="add_app_instance-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 525</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">add_app_instance</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>)
  <span class="ruby-identifier">app_instance_file</span> = <span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/#{APP_INSTANCE}&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">app_instance_file</span>)
    <span class="ruby-identifier">json_instances</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">app_instance_file</span>)
    <span class="ruby-identifier">instances</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">json_instances</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">instances</span> = []
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">instances</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-string">'app_name'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_name</span>, <span class="ruby-string">'ip'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ip</span>, <span class="ruby-string">'port'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">port</span>}
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">app_instance_file</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">instances</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_app_instance-source -->
          
        </div>

        

        
      </div><!-- add_app_instance-method -->

    
      <div id="method-c-add_ip_to_ip_list" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_ip_to_ip_list</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Add the given IP to the list of IPs that we store in ZooKeeper. If the IPs
file doesn’t exist in ZooKeeper, create it and add in the given IP
address. We also update the timestamp associated with this list so that
others know to update it as needed.</p>
          

          
          <div class="method-source-code" id="add_ip_to_ip_list-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 309</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">add_ip_to_ip_list</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Adding IP #{ip} to IP list in ZooKeeper&quot;</span>)

  <span class="ruby-identifier">new_timestamp</span> = <span class="ruby-value">0.0</span>

  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">IP_LIST</span>)
    <span class="ruby-comment"># See if our IP is in the list of IPs that are up, and if not,</span>
    <span class="ruby-comment"># append it to the list and update the timestamp so that everyone</span>
    <span class="ruby-comment"># else will update their local copies.</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">IP_LIST</span>))
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>[<span class="ruby-string">'ips'</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ip</span>)
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;IPs file does not include our IP - adding it in&quot;</span>)
      <span class="ruby-identifier">data</span>[<span class="ruby-string">'ips'</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ip</span>
      <span class="ruby-identifier">new_timestamp</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">data</span>[<span class="ruby-string">'last_updated'</span>] = <span class="ruby-identifier">new_timestamp</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">IP_LIST</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">data</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Updated timestamp in ips list to &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;#{data['last_updated']}&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;IPs file already includes our IP - skipping&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;IPs file does not exist - creating it&quot;</span>)
    <span class="ruby-identifier">new_timestamp</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">data</span> = {<span class="ruby-string">'ips'</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">ip</span>], <span class="ruby-string">'last_updated'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">new_timestamp</span>}
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">IP_LIST</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">data</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Updated timestamp in ips list to &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{data['last_updated']}&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_timestamp</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_ip_to_ip_list-source -->
          
        </div>

        

        
      </div><!-- add_ip_to_ip_list-method -->

    
      <div id="method-c-add_roles_to_node" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_roles_to_node</span><span
            class="method-args">(roles, node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Adds the specified role to the given node in ZooKeeper. A node can call
this function to add a role to another node, and the other node should take
on this role, or a node can call this function to let others know that it
is taking on a new role. Callers should acquire the ZK Lock before calling
this function. roles should be an Array of Strings, where each String is a
role to add node should be a <a href="DjinnJobData.html">DjinnJobData</a>
representing the node that we want to add the roles to</p>
          

          
          <div class="method-source-code" id="add_roles_to_node-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 561</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">add_roles_to_node</span>(<span class="ruby-identifier">roles</span>, <span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">old_job_data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_job_data_for_ip</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>)
  <span class="ruby-identifier">new_node</span> = <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">old_job_data</span>)
  <span class="ruby-identifier">new_node</span>.<span class="ruby-identifier">add_roles</span>(<span class="ruby-identifier">roles</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;:&quot;</span>))
  <span class="ruby-identifier">new_job_data</span> = <span class="ruby-identifier">new_node</span>.<span class="ruby-identifier">serialize</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_job_data_for_ip</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">new_job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_done_loading</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-keyword">false</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_ips_timestamp</span>()
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_roles_to_node-source -->
          
        </div>

        

        
      </div><!-- add_roles_to_node-method -->

    
      <div id="method-c-find_open_nodes_in_cloud" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_open_nodes_in_cloud</span><span
            class="method-args">(number_of_nodes_needed, cloud_num)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="find_open_nodes_in_cloud-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 591</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_open_nodes_in_cloud</span>(<span class="ruby-identifier">number_of_nodes_needed</span>, <span class="ruby-identifier">cloud_num</span>)
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Trying to find #{number_of_nodes_needed} nodes in&quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot; cloud #{cloud_num}&quot;</span>)

  <span class="ruby-identifier">nodes_to_use</span> = []
  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">lock_and_run</span> {
    <span class="ruby-identifier">ip_info</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_ip_info</span>()
    <span class="ruby-identifier">all_ips</span> = <span class="ruby-identifier">ip_info</span>[<span class="ruby-string">'ips'</span>]
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;All IPs currently in use are #{all_ips.join(', ')}&quot;</span>)

    <span class="ruby-identifier">all_ips</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">job_data</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_job_data_for_ip</span>(<span class="ruby-identifier">ip</span>)
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Job data for IP #{ip} is #{job_data}&quot;</span>)
      <span class="ruby-identifier">node</span> = <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">job_data</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_open?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">cloud</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cloud_num</span>
        <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Using node with data #{job_data}&quot;</span>)
        <span class="ruby-identifier">nodes_to_use</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Not using node with data #{job_data}&quot;</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">nodes_to_use</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">number_of_nodes_needed</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">nodes_to_use</span>
      <span class="ruby-keyword">end</span>
    }
  }

  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;#{number_of_nodes_needed} open nodes were &quot;</span> <span class="ruby-operator">+</span> 
    <span class="ruby-node">&quot;requested, but we were only able to procure #{nodes_to_use.length} &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot;nodes&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">nodes_to_use</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_open_nodes_in_cloud-source -->
          
        </div>

        

        
      </div><!-- find_open_nodes_in_cloud-method -->

    
      <div id="method-c-get_app_hosters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_app_hosters</span><span
            class="method-args">(appname)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_app_hosters-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_app_hosters</span>(<span class="ruby-identifier">appname</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">defined?</span>(<span class="ruby-identifier">@@zk</span>)
    <span class="ruby-keyword">return</span> []
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">appname_path</span> = <span class="ruby-constant">ROOT_APP_PATH</span> <span class="ruby-operator">+</span> <span class="ruby-node">&quot;/#{appname}&quot;</span>
  <span class="ruby-identifier">app_hosters</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_children</span>(<span class="ruby-identifier">appname_path</span>)
  <span class="ruby-identifier">converted</span> = []
  <span class="ruby-identifier">app_hosters</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">serialized</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">converted</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">serialized</span>)
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">converted</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_app_hosters-source -->
          
        </div>

        

        
      </div><!-- get_app_hosters-method -->

    
      <div id="method-c-get_app_instances_for_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_app_instances_for_ip</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns an Array of Hashes that correspond to the App Engine applications
hosted on the given ip address. Each hash contains the application’s
name, the IP address (which should be the same as the given IP), and the
nginx port that the app is hosted on.</p>
          

          
          <div class="method-source-code" id="get_app_instances_for_ip-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 511</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_app_instances_for_ip</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-identifier">app_instance_file</span> = <span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/#{APP_INSTANCE}&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">app_instance_file</span>)
    <span class="ruby-keyword">return</span> []
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">json_instances</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">app_instance_file</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">json_instances</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_app_instances_for_ip-source -->
          
        </div>

        

        
      </div><!-- get_app_instances_for_ip-method -->

    
      <div id="method-c-get_appcontroller_lock" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_appcontroller_lock</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Gets a lock that AppControllers can use to have exclusive write access
(between other AppControllers) to the ZooKeeper hierarchy located at <a
href="ZKInterface.html#APPCONTROLLER_PATH">APPCONTROLLER_PATH</a>. It
returns a boolean that indicates whether or not it was able to acquire the
lock or not.</p>
          

          
          <div class="method-source-code" id="get_appcontroller_lock-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 195</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_appcontroller_lock</span>()
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Getting the AppController lock&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">APPCONTROLLER_PATH</span>)
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Creating AppController path in ZooKeeper&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">APPCONTROLLER_PATH</span>, <span class="ruby-constant">DUMMY_DATA</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Trying to get AppController lock&quot;</span>)
  <span class="ruby-identifier">info</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_zookeeper_operation</span> {
    <span class="ruby-identifier">@@zk</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">APPCONTROLLER_LOCK_PATH</span>, 
      <span class="ruby-value">:ephemeral</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">EPHEMERAL</span>, <span class="ruby-value">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">@@client_ip</span>))
  }
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">info</span>[<span class="ruby-value">:rc</span>].<span class="ruby-identifier">zero?</span> 
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Got the AppController lock&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># we couldn't get the lock for some reason</span>
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Couldn't get the AppController lock, saw info &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{info.inspect}&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_appcontroller_lock-source -->
          
        </div>

        

        
      </div><!-- get_appcontroller_lock-method -->

    
      <div id="method-c-get_appcontroller_state" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_appcontroller_state</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_appcontroller_state-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 178</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_appcontroller_state</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">APPCONTROLLER_STATE_PATH</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_appcontroller_state-source -->
          
        </div>

        

        
      </div><!-- get_appcontroller_state-method -->

    
      <div id="method-c-get_failed_nodes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_failed_nodes</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Queries ZooKeeper for a list of all IPs that are currently up, and then
checks if each of those IPs has an ephemeral link indicating that they are
alive. Returns an Array of IPs corresponding to failed nodes.</p>
          

          
          <div class="method-source-code" id="get_failed_nodes-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 374</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_failed_nodes</span>
  <span class="ruby-identifier">failed_nodes</span> = []

  <span class="ruby-identifier">ips</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_ip_info</span>[<span class="ruby-string">'ips'</span>]
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;All IPs are [#{ips.join(', ')}]&quot;</span>)

  <span class="ruby-identifier">ips</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/live&quot;</span>)
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Node at #{ip} is alive&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Node at #{ip} has failed&quot;</span>)
      <span class="ruby-identifier">failed_nodes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ip</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Failed nodes are [#{failed_nodes.join(', ')}]&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">failed_nodes</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_failed_nodes-source -->
          
        </div>

        

        
      </div><!-- get_failed_nodes-method -->

    
      <div id="method-c-get_ip_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_ip_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns a Hash containing the list of the IPs that are currently running
within AppScale as well as a timestamp corresponding to the time when the
latest node updated this information.</p>
          

          
          <div class="method-source-code" id="get_ip_info-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 299</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_ip_info</span>()
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Getting IP info from ZooKeeper&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">IP_LIST</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_ip_info-source -->
          
        </div>

        

        
      </div><!-- get_ip_info-method -->

    
      <div id="method-c-get_job_data_for_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_job_data_for_ip</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns a serialized <a href="DjinnJobData.html">DjinnJobData</a> string
that we store in ZooKeeper for the given IP address, which callers can
deserialize to get a <a href="DjinnJobData.html">DjinnJobData</a> object.</p>
          

          
          <div class="method-source-code" id="get_job_data_for_ip-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 542</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_job_data_for_ip</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/job_data&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_job_data_for_ip-source -->
          
        </div>

        

        
      </div><!-- get_job_data_for_ip-method -->

    
      <div id="method-c-get_max_machines_for_babel_slaves" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_max_machines_for_babel_slaves</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns the maximum number of nodes that should be used to run Babel jobs
(not including the Babel Master).</p>
          

          
          <div class="method-source-code" id="get_max_machines_for_babel_slaves-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 498</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_max_machines_for_babel_slaves</span>()
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">BABEL_MAX_MACHINES_PATH</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">BABEL_MAX_MACHINES_PATH</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_max_machines_for_babel_slaves-source -->
          
        </div>

        

        
      </div><!-- get_max_machines_for_babel_slaves-method -->

    
      <div id="method-c-init" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">init</span><span
            class="method-args">(my_node, all_nodes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Initializes a new ZooKeeper connection to the “closest” node in the
system. “Closeness” is defined as either “this node” (if it runs
ZooKeeper), or an arbitrary node that runs ZooKeeper. Callers should use
this method when they don’t want to determine on their own which
ZooKeeper box to connect to.</p>
          

          
          <div class="method-source-code" id="init-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 128</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">init</span>(<span class="ruby-identifier">my_node</span>, <span class="ruby-identifier">all_nodes</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">init_to_ip</span>(<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_zk_location</span>(<span class="ruby-identifier">my_node</span>, 
    <span class="ruby-identifier">all_nodes</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- init-source -->
          
        </div>

        

        
      </div><!-- init-method -->

    
      <div id="method-c-init_to_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">init_to_ip</span><span
            class="method-args">(client_ip, ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Initializes a new ZooKeeper connection to the IP address specified. Callers
should use this when they know exactly which node hosts ZooKeeper.</p>
          

          
          <div class="method-source-code" id="init_to_ip-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 106</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">init_to_ip</span>(<span class="ruby-identifier">client_ip</span>, <span class="ruby-identifier">ip</span>)
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Waiting for #{ip}:#{SERVER_PORT} to open&quot;</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-constant">SERVER_PORT</span>)

  <span class="ruby-identifier">@@client_ip</span> = <span class="ruby-identifier">client_ip</span>
  <span class="ruby-identifier">@@ip</span> = <span class="ruby-identifier">ip</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">defined?</span>(<span class="ruby-identifier">@@lock</span>)
    <span class="ruby-identifier">@@lock</span> = <span class="ruby-constant">Monitor</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">@@lock</span>.<span class="ruby-identifier">synchronize</span> {
    <span class="ruby-identifier">@@zk</span> = <span class="ruby-constant">Zookeeper</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{ip}:#{SERVER_PORT}&quot;</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- init_to_ip-source -->
          
        </div>

        

        
      </div><!-- init_to_ip-method -->

    
      <div id="method-c-is_node_done_loading-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_node_done_loading?</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks ZooKeeper to see if the given node has finished loading its roles,
which it indicates via a file in a particular path.</p>
          

          
          <div class="method-source-code" id="is_node_done_loading-3F-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 438</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_node_done_loading?</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">APPCONTROLLER_NODE_PATH</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">loading_file</span> = <span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/done_loading&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">loading_file</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">json_contents</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">loading_file</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">json_contents</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">FailedZooKeeperOperationException</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_node_done_loading-3F-source -->
          
        </div>

        

        
      </div><!-- is_node_done_loading-3F-method -->

    
      <div id="method-c-is_node_live-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_node_live?</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks ZooKeeper to see if the given node is alive, by checking if the
ephemeral file it has created is still present.</p>
          

          
          <div class="method-source-code" id="is_node_live-3F-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 479</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_node_live?</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/live&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_node_live-3F-source -->
          
        </div>

        

        
      </div><!-- is_node_live-3F-method -->

    
      <div id="method-c-lock_and_run" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lock_and_run</span><span
            class="method-args">() { || ... }</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method provides callers with an easier way to read and write to
AppController data in ZooKeeper. This is useful for methods that aren’t
sure if they already have the ZooKeeper lock or not, but definitely need it
and don’t want to accidentally cause a deadlock (grabbing the lock when
they already have it).</p>
          

          
          <div class="method-source-code" id="lock_and_run-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 232</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lock_and_run</span>(&amp;<span class="ruby-identifier">block</span>)
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Getting AppController lock to run caller's block&quot;</span>)

  <span class="ruby-comment"># Create the ZK lock path if it doesn't exist.</span>
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Checking to see if AppController path exists&quot;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">APPCONTROLLER_PATH</span>)
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Creating AppController path in ZooKeeper&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">APPCONTROLLER_PATH</span>, <span class="ruby-constant">DUMMY_DATA</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Try to get the lock, and if we can't get it, see if we already have</span>
  <span class="ruby-comment"># it. If we do, move on (but don't release it later since this block</span>
  <span class="ruby-comment"># didn't grab it), and if we don't have it, try again.</span>
  <span class="ruby-identifier">got_lock</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Getting AppController lock&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_appcontroller_lock</span>()
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Got AppController lock successfully&quot;</span>)
      <span class="ruby-identifier">got_lock</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">else</span>  <span class="ruby-comment"># it may be that we already have the lock</span>
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Couldn't get the AppController lock - checking &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;if we already have it.&quot;</span>)
      <span class="ruby-identifier">info</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_zookeeper_operation</span> {
        <span class="ruby-identifier">@@zk</span>.<span class="ruby-identifier">get</span>(<span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">APPCONTROLLER_LOCK_PATH</span>)
      }
      <span class="ruby-identifier">owner</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">info</span>[<span class="ruby-value">:data</span>])
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">@@client_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">owner</span>
        <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Tried to get the lock, but we already have it. &quot;</span> <span class="ruby-operator">+</span>
          <span class="ruby-string">&quot;Not grabbing/releasing lock again.&quot;</span>)
        <span class="ruby-identifier">got_lock</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">else</span> 
        <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Tried to get the lock, but it's currently owned &quot;</span> <span class="ruby-operator">+</span>
          <span class="ruby-node">&quot;by #{owner}. Will try again later.&quot;</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ZooKeeperLockException</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ZooKeeperLockException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">trace</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
    <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Saw an exception of class #{e.class}, with &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;trace info: #{trace}&quot;</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
    <span class="ruby-keyword">retry</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Got the AppController lock - running the caller's &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot;block&quot;</span>)
  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">yield</span>  <span class="ruby-comment"># invoke the user's block, and catch any uncaught exceptions</span>
  <span class="ruby-comment">#rescue Exception =&gt; except</span>
  <span class="ruby-comment">#  NeptuneManager.log(&quot;Ran caller's block but saw an Exception of class &quot; +</span>
  <span class="ruby-comment">#    &quot;#{except.class}&quot;)</span>
  <span class="ruby-comment">#  raise except</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">got_lock</span>
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Grabbed lock, so now releasing it.&quot;</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">release_appcontroller_lock</span>()
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Released lock successfully&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Didn't grab lock, so not releasing it.&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- lock_and_run-source -->
          
        </div>

        

        
      </div><!-- lock_and_run-method -->

    
      <div id="method-c-reinitialize" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reinitialize</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new connection to use with ZooKeeper. Useful for scenarios where
the ZooKeeper library has terminated our connection but we still need it.
Also recreates any ephemeral links that were lost when the connection was
disconnected.</p>
          

          
          <div class="method-source-code" id="reinitialize-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reinitialize</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">init_to_ip</span>(<span class="ruby-identifier">@@client_ip</span>, <span class="ruby-identifier">@@ip</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_live_node_ephemeral_link</span>(<span class="ruby-identifier">@@client_ip</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- reinitialize-source -->
          
        </div>

        

        
      </div><!-- reinitialize-method -->

    
      <div id="method-c-release_appcontroller_lock" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">release_appcontroller_lock</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Releases the lock that AppControllers use to have exclusive write access,
which was acquired via self.get_appcontroller_lock().</p>
          

          
          <div class="method-source-code" id="release_appcontroller_lock-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 221</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">release_appcontroller_lock</span>()
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-string">&quot;Releasing AppController lock&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-constant">APPCONTROLLER_LOCK_PATH</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- release_appcontroller_lock-source -->
          
        </div>

        

        
      </div><!-- release_appcontroller_lock-method -->

    
      <div id="method-c-remove_app_entry" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_app_entry</span><span
            class="method-args">(appname)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_app_entry-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 157</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_app_entry</span>(<span class="ruby-identifier">appname</span>)
  <span class="ruby-identifier">appname_path</span> = <span class="ruby-constant">ROOT_APP_PATH</span> <span class="ruby-operator">+</span> <span class="ruby-node">&quot;/#{appname}&quot;</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">appname_path</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_app_entry-source -->
          
        </div>

        

        
      </div><!-- remove_app_entry-method -->

    
      <div id="method-c-remove_ip_from_ip_list" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_ip_from_ip_list</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Accesses the list of IP addresses stored in ZooKeeper and removes the given
IP address from that list.</p>
          

          
          <div class="method-source-code" id="remove_ip_from_ip_list-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 345</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_ip_from_ip_list</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">IP_LIST</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">data</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">IP_LIST</span>))
  <span class="ruby-identifier">data</span>[<span class="ruby-string">'ips'</span>].<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-identifier">new_timestamp</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">data</span>[<span class="ruby-string">'last_updated'</span>] = <span class="ruby-identifier">new_timestamp</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">IP_LIST</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">data</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_timestamp</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_ip_from_ip_list-source -->
          
        </div>

        

        
      </div><!-- remove_ip_from_ip_list-method -->

    
      <div id="method-c-remove_node_information" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_node_information</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Deletes all information for a given node, whose data is stored in
ZooKeeper.</p>
          

          
          <div class="method-source-code" id="remove_node_information-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 431</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_node_information</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">recursive_delete</span>(<span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_node_information-source -->
          
        </div>

        

        
      </div><!-- remove_node_information-method -->

    
      <div id="method-c-remove_roles_from_node" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_roles_from_node</span><span
            class="method-args">(roles, node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Removes the specified roles from the given node in ZooKeeper. A node can 
call this function to remove roles from another node, and the other node 
should take on this role, or a node can call this function to let others 
know that it is stopping existing roles. Callers should acquire the ZK Lock
before calling this function. roles should be an Array of Strings, where
each String is a role to remove node should be a <a
href="DjinnJobData.html">DjinnJobData</a> representing the node that we
want to remove the roles from</p>
          

          
          <div class="method-source-code" id="remove_roles_from_node-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 580</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_roles_from_node</span>(<span class="ruby-identifier">roles</span>, <span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">old_job_data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_job_data_for_ip</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>)
  <span class="ruby-identifier">new_node</span> = <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">old_job_data</span>)
  <span class="ruby-identifier">new_node</span>.<span class="ruby-identifier">remove_roles</span>(<span class="ruby-identifier">roles</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;:&quot;</span>))
  <span class="ruby-identifier">new_job_data</span> = <span class="ruby-identifier">new_node</span>.<span class="ruby-identifier">serialize</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_job_data_for_ip</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">new_job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_done_loading</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-keyword">false</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_ips_timestamp</span>()
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_roles_from_node-source -->
          
        </div>

        

        
      </div><!-- remove_roles_from_node-method -->

    
      <div id="method-c-set_done_loading" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_done_loading</span><span
            class="method-args">(ip, val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Provides a convenience function that callers can use to indicate that their
node is done loading (if they have finished starting/stopping roles), or is
not done loading (if they have roles they need to start or stop).</p>
          

          
          <div class="method-source-code" id="set_done_loading-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 471</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_done_loading</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">val</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/done_loading&quot;</span>, 
    <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">val</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_done_loading-source -->
          
        </div>

        

        
      </div><!-- set_done_loading-method -->

    
      <div id="method-c-set_job_data_for_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_job_data_for_ip</span><span
            class="method-args">(ip, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="set_job_data_for_ip-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 547</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_job_data_for_ip</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/job_data&quot;</span>, 
    <span class="ruby-identifier">job_data</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_job_data_for_ip-source -->
          
        </div>

        

        
      </div><!-- set_job_data_for_ip-method -->

    
      <div id="method-c-set_live_node_ephemeral_link" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_live_node_ephemeral_link</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Writes the ephemeral link in ZooKeeper that represents a given node being
alive. Callers should only use this method to indicate that their own node
is alive, and not do it on behalf of other nodes.</p>
          

          
          <div class="method-source-code" id="set_live_node_ephemeral_link-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 460</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_live_node_ephemeral_link</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_zookeeper_operation</span> {
    <span class="ruby-identifier">@@zk</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{ip}/live&quot;</span>, 
      <span class="ruby-value">:ephemeral</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">EPHEMERAL</span>, <span class="ruby-value">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">DUMMY_DATA</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_live_node_ephemeral_link-source -->
          
        </div>

        

        
      </div><!-- set_live_node_ephemeral_link-method -->

    
      <div id="method-c-set_max_machines_for_babel_slaves" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_max_machines_for_babel_slaves</span><span
            class="method-args">(maximum)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Writes the integer corresponding to the maximum number of nodes that should
be acquired (whether they be already running open nodes or newly spawned
virtual machines) to become Babel slaves (workers).</p>
          

          
          <div class="method-source-code" id="set_max_machines_for_babel_slaves-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 487</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_max_machines_for_babel_slaves</span>(<span class="ruby-identifier">maximum</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">BABEL_PATH</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">BABEL_PATH</span>, <span class="ruby-constant">DUMMY_DATA</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">BABEL_MAX_MACHINES_PATH</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">maximum</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_max_machines_for_babel_slaves-source -->
          
        </div>

        

        
      </div><!-- set_max_machines_for_babel_slaves-method -->

    
      <div id="method-c-update_ips_timestamp" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_ips_timestamp</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Updates the timestamp in the <a href="ZKInterface.html#IP_LIST">IP_LIST</a>
file, to let other nodes know that an update has been made and that they
should update their local @nodes</p>
          

          
          <div class="method-source-code" id="update_ips_timestamp-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 361</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_ips_timestamp</span>()
  <span class="ruby-identifier">data</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">IP_LIST</span>))
  <span class="ruby-identifier">new_timestamp</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">data</span>[<span class="ruby-string">'last_updated'</span>] = <span class="ruby-identifier">new_timestamp</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">IP_LIST</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">data</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-constant">NeptuneManager</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Updated timestamp in ips list to #{data['last_updated']}&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_timestamp</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_ips_timestamp-source -->
          
        </div>

        

        
      </div><!-- update_ips_timestamp-method -->

    
      <div id="method-c-write_appcontroller_state" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_appcontroller_state</span><span
            class="method-args">(state)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_appcontroller_state-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 183</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_appcontroller_state</span>(<span class="ruby-identifier">state</span>)
  <span class="ruby-comment"># Create the top-level AC dir, then the actual node that stores</span>
  <span class="ruby-comment"># our data</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">APPCONTROLLER_PATH</span>, <span class="ruby-constant">DUMMY_DATA</span>, <span class="ruby-constant">NOT_EPHEMERAL</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set</span>(<span class="ruby-constant">APPCONTROLLER_STATE_PATH</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">state</span>), <span class="ruby-constant">NOT_EPHEMERAL</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_appcontroller_state-source -->
          
        </div>

        

        
      </div><!-- write_appcontroller_state-method -->

    
      <div id="method-c-write_node_information" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_node_information</span><span
            class="method-args">(node, done_loading)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates files in ZooKeeper that relate to a given AppController’s role
information, so that other AppControllers can detect if it has failed, and
if so, what functionality it was providing at the time.</p>
          

          
          <div class="method-source-code" id="write_node_information-source">
            <pre><span class="ruby-comment"># File Neptune/lib/zkinterface.rb, line 397</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_node_information</span>(<span class="ruby-identifier">node</span>, <span class="ruby-identifier">done_loading</span>)
  <span class="ruby-comment"># Create the folder for all nodes if it doesn't exist.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">APPCONTROLLER_NODE_PATH</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_zookeeper_operation</span> {
      <span class="ruby-identifier">@@zk</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">APPCONTROLLER_NODE_PATH</span>, 
        <span class="ruby-value">:ephemeral</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">NOT_EPHEMERAL</span>, <span class="ruby-value">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">DUMMY_DATA</span>)
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Create the folder for this node.</span>
  <span class="ruby-identifier">my_ip_path</span> = <span class="ruby-node">&quot;#{APPCONTROLLER_NODE_PATH}/#{node.public_ip}&quot;</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_zookeeper_operation</span> {
    <span class="ruby-identifier">@@zk</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">my_ip_path</span>, <span class="ruby-value">:ephemeral</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">NOT_EPHEMERAL</span>, 
      <span class="ruby-value">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">DUMMY_DATA</span>)
  }

  <span class="ruby-comment"># Create an ephemeral link associated with this node, which other</span>
  <span class="ruby-comment"># AppControllers can use to quickly detect dead nodes.</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_live_node_ephemeral_link</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>)


  <span class="ruby-comment"># Since we're reporting on the roles we've started, we are done loading</span>
  <span class="ruby-comment"># roles right now, so write that information for others to read and act on.</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_done_loading</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">done_loading</span>)

  <span class="ruby-comment"># Finally, dump the data from this node to ZK, so that other nodes can</span>
  <span class="ruby-comment"># reconstruct it as needed.</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_job_data_for_ip</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">node</span>.<span class="ruby-identifier">serialize</span>())

  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_node_information-source -->
          
        </div>

        

        
      </div><!-- write_node_information-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

