<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Neptune/lib/job_types/babel_helper.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Appscale C0 Coverage Information - RCov</h1>
    <h2>Neptune/lib/job_types/babel_helper.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="Neptune-lib-job_types-babel_helper_rb.html">Neptune/lib/job_types/babel_helper.rb</a></td>
            <td class='right_align'><tt>742</tt></td>
            <td class='right_align'><tt>446</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>69.14%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:69px"></div>
            <div class="uncovered" style="width:31px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>58.52%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:59px"></div>
            <div class="uncovered" style="width:41px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1">1</a> # Programmer: Chris Bunch</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line2">2</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line3">3</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line4">4</a> # Imports for RubyGems</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line5">5</a> require 'rubygems'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line6">6</a> require 'json'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line7">7</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line8">8</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line9">9</a> # Imports for other AppController libraries</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line10">10</a> $:.unshift File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;..&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line11">11</a> require 'neptune_manager'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line12">12</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line13">13</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line14">14</a> $:.unshift File.join(File.dirname(__FILE__), &quot;..&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line15">15</a> require 'zkinterface'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line16">16</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line17">17</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line18">18</a> $:.unshift File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;task_queues&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line19">19</a> require 'queue_factory'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line20">20</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line21">21</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line22">22</a> $:.unshift File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;task_engines&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line23">23</a> require 'engine_factory'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line24">24</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line25">25</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line26">26</a> $:.unshift File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;datastores&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line27">27</a> require 'datastore_factory'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line28">28</a> require 'datastore_s3'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line29">29</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line30">30</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line31">31</a> # The name of the queue to use when storing or receiving tasks. Since some</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line32">32</a> # providers use it as part of a FQDN, don't put underscores or other non-FQDN</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line33">33</a> # characters in it.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line34">34</a> TASK_QUEUE_NAME = &quot;neptune&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line35">35</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line36">36</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line37">37</a> class NeptuneManager</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line38">38</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line39">39</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line40">40</a>   # When executing over AppScale resources only, we can utilize RabbitMQ as a</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line41">41</a>   # queue and use Executor, our task engine, or we can make the app into an</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line42">42</a>   # App Engine app and exeucte it via the App Engine Task Queue API.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line43">43</a>   INTERNAL_ENGINES = [TaskQueueRabbitMQ::NAME, TaskEngineAppScale::NAME]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line44">44</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line45">45</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line46">46</a>   # When executing over AppScale with Amazon credentials, we can utilize </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line47">47</a>   # Amazon SQS (Simple Queue Service) as a queue and use Executor to execute</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line48">48</a>   # tasks.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line49">49</a>   AMAZON_CREDENTIALS = [&quot;@EC2_SECRET_KEY&quot;, &quot;@EC2_ACCESS_KEY&quot;, &quot;@S3_URL&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line50">50</a>   AMAZON_ENGINES = [TaskQueueSQS::NAME]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line51">51</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line52">52</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line53">53</a>   # When executing over AppScale with Google credentials, we can utilize</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line54">54</a>   # Google App Engine's push queues as the queue and task engine or</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line55">55</a>   # Google App Engine's pull queues as the queue and Executor to execute tasks.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line56">56</a>   # Since our pull queue support is done via an App Engine app, the same</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line57">57</a>   # credentials will work for pull queues as for push queues (minus @function).</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line58">58</a>   GOOGLE_CREDENTIALS = [&quot;@appid&quot;, &quot;@appcfg_cookies&quot;, &quot;@function&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line59">59</a>   GOOGLE_ENGINES = [TaskEngineGoogleAppEngine::NAME, TaskQueueGoogleAppEngine::NAME]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line60">60</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line61">61</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line62">62</a>   # When executing over AppScale with Azure credentials, we can utilize</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line63">63</a>   # the Windows Azure Queue Service as a queue and use Executor to execute</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line64">64</a>   # tasks.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line65">65</a>   AZURE_CREDENTIALS = [&quot;@AZURE_STORAGE_ACCOUNT_NAME&quot;, &quot;@AZURE_STORAGE_ACCESS_KEY&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line66">66</a>   AZURE_ENGINES = [TaskQueueAzureQueue::NAME]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line67">67</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line68">68</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line69">69</a>   # Files stored in remote datastores are referenced in a POSIX-like fashion:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line70">70</a>   # /bucket/file refers to a file stored in S3, with the named bucket and</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line71">71</a>   # file.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line72">72</a>   STORAGE_PARAM_REGEX = /\A\/(.*)\/(.*)\Z/</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line73">73</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line74">74</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line75">75</a>   # Constants that are used to indicate which engine runs a task.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line76">76</a>   RUN_LOCALLY = &quot;OK: run locally&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line77">77</a>   RUN_VIA_EXECUTOR = &quot;OK: run via Executor&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line78">78</a>   RUN_VIA_REMOTE_ENGINE = &quot;OK: run via a remote engine&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line79">79</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line80">80</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line81">81</a>   # Constants that are used to indicate how long a babel_master node should</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line82">82</a>   # sleep for if there are no tasks to schedule, and how long to sleep for</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line83">83</a>   # if new babel_slaves have been spawned and need time to fetch tasks off</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line84">84</a>   # of queues.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line85">85</a>   TIME_TO_WAIT_FOR_NEW_TASKS = 10</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line86">86</a>   TIME_FOR_NEW_NODES_TO_GET_TASKS = 30</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line87">87</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line88">88</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line89">89</a>   # The amount of time that we should hold the babel_slave role for, even if we</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line90">90</a>   # receive no tasks. Dynamically adding and removing this role frees it up to</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line91">91</a>   # take on other roles for fault tolerance purposes, and we keep the value </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line92">92</a>   # non-trivially high because starting and stopping RabbitMQ (which we always</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line93">93</a>   # start for babel_slave since rabbitmq is one of the possible backends) can</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line94">94</a>   # take a while.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line95">95</a>   # TODO(cgb): Maybe only start rabbitmq if we get an item from the queue that</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line96">96</a>   # specifies it should be used?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line97">97</a>   MAX_IDLE_TIME = 300</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line98">98</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line99">99</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line100">100</a>   # A mapping of Amazon EC2 instance types that maps instance types to</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line101">101</a>   # the number of cores they have.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line102">102</a>   # TODO(cgb): Should we eventually include memory / disk info here?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line103">103</a>   INSTANCE_CPU_INFO = {</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line104">104</a>     # Standard instances</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line105">105</a>     &quot;m1.small&quot; =&gt; 1,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line106">106</a>     &quot;m1.medium&quot; =&gt; 1,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line107">107</a>     &quot;m1.large&quot; =&gt; 2,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line108">108</a>     &quot;m1.xlarge&quot; =&gt; 4,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line109">109</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line110">110</a>     # Micro instances</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line111">111</a>     &quot;t1.micro&quot; =&gt; 1,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line112">112</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line113">113</a>     # High-Memory instances</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line114">114</a>     &quot;m2.xlarge&quot; =&gt; 2,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line115">115</a>     &quot;m2.2xlarge&quot; =&gt; 4,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line116">116</a>     &quot;m2.4xlarge&quot; =&gt; 8,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line117">117</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line118">118</a>     # High-CPU instances</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line119">119</a>     &quot;c1.medium&quot; =&gt; 2,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line120">120</a>     &quot;c1.xlarge&quot; =&gt; 8,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line121">121</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line122">122</a>     # Cluster Compute instances</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line123">123</a>     &quot;cc1.4xlarge&quot; =&gt; 8,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line124">124</a>     &quot;cc1.8xlarge&quot; =&gt; 16,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line125">125</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line126">126</a>     # Cluster GPU instances</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line127">127</a>     &quot;cg1.4xlarge&quot; =&gt; 8</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line128">128</a>   }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line129">129</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line130">130</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line131">131</a>   # This debug flag is used to keep the user's code on the local filesystem,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line132">132</a>   # which can be useful to debug why code did not run successfully.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line133">133</a>   DEBUG = true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line134">134</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line135">135</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line136">136</a>   public</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line137">137</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line138">138</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line139">139</a>   # Tasks can execute over a number of different engines (a queue and an</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line140">140</a>   # executor). From the credentials the user has given us (job_data), determine</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line141">141</a>   # which engines can be used.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line142">142</a>   def get_supported_babel_engines(job_data, secret)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line143">143</a>     return BAD_SECRET_MSG if !valid_secret?(secret)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line144">144</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line145">145</a>     NeptuneManager.log(&quot;checking supported engines for job data &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line146">146</a>       &quot;#{job_data.inspect}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line147">147</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line148">148</a>     # all jobs can use the internal engines</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line149">149</a>     engines = INTERNAL_ENGINES</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line150">150</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line151">151</a>     # but not necessarily the others, so check them one by one</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line152">152</a>     engines &lt;&lt; get_engines_for_creds(job_data, AMAZON_CREDENTIALS, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line153">153</a>       AMAZON_ENGINES)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line154">154</a>     engines &lt;&lt; get_engines_for_creds(job_data, AZURE_CREDENTIALS, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line155">155</a>       AZURE_ENGINES)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line156">156</a>     engines &lt;&lt; get_engines_for_creds(job_data, GOOGLE_CREDENTIALS, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line157">157</a>       GOOGLE_ENGINES)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line158">158</a>    </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line159">159</a>     # since we're appending arrays to arrays but want it to be a 1D array</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line160">160</a>     engines.flatten!.uniq!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line161">161</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line162">162</a>     NeptuneManager.log(&quot;supported engines for job data #{job_data.inspect} &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line163">163</a>       &quot;are [#{engines.join(', ')}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line164">164</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line165">165</a>     return engines</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line166">166</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line167">167</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line168">168</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line169">169</a>   # Checks the credentials that the user has given us (job_data) to see if</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line170">170</a>   # they match up to the credentials needed for the given engine. If so, we</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line171">171</a>   # return the list of engines that can be safely added.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line172">172</a>   def get_engines_for_creds(job_data, credentials, engines_to_add)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line173">173</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line174">174</a>     credentials.each { |cred|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line175">175</a>       if !job_data.include?(cred)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line176">176</a>         NeptuneManager.log(&quot;credentials did not have #{cred}, so not &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line177">177</a>           &quot;#{engines_to_add.join(', ')}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line178">178</a>         return []</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line179">179</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line180">180</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line181">181</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line182">182</a>     NeptuneManager.log(&quot;adding engines #{engines_to_add.join(', ')}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line183">183</a>     return engines_to_add</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line184">184</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line185">185</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line186">186</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line187">187</a>   # This method is the spawning service for Babel - that is, it decides where </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line188">188</a>   # tasks should be spawned. For now, we don't intelligently decide where to</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line189">189</a>   # run tasks - we just run tasks where the user tells us to run them. Since</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line190">190</a>   # this method is accessible via SOAP, it has a time limit on its execution,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line191">191</a>   # so as soon as we can, we spawn off a new thread to do the real work and</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line192">192</a>   # return.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line193">193</a>   def babel_run_job(nodes, jobs, secret)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line194">194</a>     return BAD_SECRET_MSG if !valid_secret?(secret)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line195">195</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line196">196</a>     if jobs.class == Hash</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line197">197</a>       jobs = [jobs]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line198">198</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line199">199</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line200">200</a>     Thread.new {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line201">201</a>       run_or_delegate_tasks(jobs)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line202">202</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line203">203</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line204">204</a>     return &quot;OK&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line205">205</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line206">206</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line207">207</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line208">208</a>   def run_or_delegate_tasks(jobs)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line209">209</a>     where_tasks_were_run = []</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line210">210</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line211">211</a>     jobs.each { |job|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line212">212</a>       NeptuneManager.log(&quot;prejob - this job's data is #{job.inspect}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line213">213</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line214">214</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line215">215</a>     threads = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line216">216</a>     jobs.each { |job|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line217">217</a>       threads &lt;&lt; Thread.new {</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line218">218</a>       job_data = job.dup</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line219">219</a>       NeptuneManager.log(&quot;This job's data is #{job_data.inspect}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line220">220</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line221">221</a>       # Add in a metadata hash so that any method can add in profiling info,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line222">222</a>       # with an initial piece of data - when we received the task to run.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line223">223</a>       if !job_data['@metadata_info']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line224">224</a>         job_data['@metadata_info'] = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line225">225</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line226">226</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line227">227</a>       job_data['@metadata_info']['received_task_at'] = Time.now.to_f</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line228">228</a>       job_data['@metadata_info']['queue_pop_time'] = 0.0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line229">229</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line230">230</a>       if job_data['@run_local']</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line231">231</a>         NeptuneManager.log(&quot;running job with data #{job_data.inspect} locally&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line232">232</a>         run_task(job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line233">233</a>         where_tasks_were_run &lt;&lt; RUN_LOCALLY</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line234">234</a>         next</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line235">235</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line236">236</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line237">237</a>       engine = job_data['@engine']</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line238">238</a>       if engine.include?(&quot;executor&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line239">239</a>         run_via_executor(engine, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line240">240</a>         where_tasks_were_run &lt;&lt; RUN_VIA_EXECUTOR</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line241">241</a>         next</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line242">242</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line243">243</a>         run_via_engine(engine, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line244">244</a>         where_tasks_were_run &lt;&lt; RUN_VIA_REMOTE_ENGINE</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line245">245</a>         next</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line246">246</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line247">247</a>       }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line248">248</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line249">249</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line250">250</a>     threads.each { |t| t.join }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line251">251</a>     return where_tasks_were_run</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line252">252</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line253">253</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line254">254</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line255">255</a>   # Tasks can be run via our task executor, which will run tasks within AppScale</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line256">256</a>   # and store task data in a queue service, which may not be local to AppScale.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line257">257</a>   def run_via_executor(engine, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line258">258</a>     NeptuneManager.log(&quot;running job with data #{job_data.inspect} via executor&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line259">259</a>     q = QueueFactory.get_queue(engine, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line260">260</a>     credentials = q.get_creds()</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line261">261</a>     queue_and_creds = {engine =&gt; credentials}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line262">262</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line263">263</a>     # the user has to tell us the maximum number of machines that can be used</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line264">264</a>     # for babel slaves, so update that info in ZooKeeper</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line265">265</a>     ZKInterface.set_max_machines_for_babel_slaves(job_data['@global_max_nodes'])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line266">266</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line267">267</a>     # since the same queue / credentials can be used repeatedly, don't keep</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line268">268</a>     # adding the same queue info over and over again</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line269">269</a>     if @queues_to_read.include?(queue_and_creds)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line270">270</a>       NeptuneManager.log(&quot;not adding queue and creds #{queue_and_creds.inspect} &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line271">271</a>         &quot;to @queues_to_read - it's already in the list&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line272">272</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line273">273</a>       NeptuneManager.log(&quot;adding queue and creds #{queue_and_creds.inspect} to &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line274">274</a>         &quot;@queues_to_read&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line275">275</a>       @queues_to_read &lt;&lt; queue_and_creds</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line276">276</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line277">277</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line278">278</a>     NeptuneManager.log(&quot;@queues_to_read now contains &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line279">279</a>       &quot;[#{@queues_to_read.join(', ')}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line280">280</a>     q.push(job_data)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line281">281</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line282">282</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line283">283</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line284">284</a>   # Tasks may also be run via remote engines - that is, they may have an internal</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line285">285</a>   # queue but definitely have a remote executor that we can blindly push the task</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line286">286</a>   # to and let it take care of.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line287">287</a>   def run_via_engine(engine, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line288">288</a>     NeptuneManager.log(&quot;running job with data #{job_data.inspect} via a remote engine&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line289">289</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line290">290</a>     # When pushing jobs to AppScale's push queues, we need to know where the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line291">291</a>     # app is located (via the login node's IP address) and the UserAppServer's</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line292">292</a>     # IP address, so pass that info along.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line293">293</a>     if engine == &quot;appscale-push-q&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line294">294</a>       job_data['@login_ip'] = get_login.public_ip</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line295">295</a>       job_data['@uaserver_ip'] = @userappserver_public_ip</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line296">296</a>       job_data['@secret'] = HelperFunctions.get_secret()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line297">297</a>       NeptuneManager.log(&quot;Adding info for AppScale push queues - &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line298">298</a>         &quot;job data is now #{job_data.inspect}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line299">299</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line300">300</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line301">301</a>     e = EngineFactory.get_engine(engine, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line302">302</a>     e.push(job_data)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line303">303</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line304">304</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line305">305</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line306">306</a>   # Tasks can be stored in multiple queues concurrently, so this method provides</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line307">307</a>   # workers (babel_slaves) with the way to learn what queues are currently in use</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line308">308</a>   # and the credentials needed to access them.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line309">309</a>   def get_queues_in_use(secret)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line310">310</a>     return BAD_SECRET_MSG if !valid_secret?(secret)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line311">311</a>     NeptuneManager.log(&quot;@queues_to_read is #{@queues_to_read.join(', ')}, class #{@queues_to_read.class}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line312">312</a>     return JSON.dump(@queues_to_read)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line313">313</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line314">314</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line315">315</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line316">316</a>   # The nodes that runs as a babel_master is a master in the system. It decides</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line317">317</a>   # when to spawn new workers, and how many to spawn, based on the number of tasks</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line318">318</a>   # waiting to be executed in all queues.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line319">319</a>   def start_babel_master()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line320">320</a>     NeptuneManager.log(&quot;#{my_node.private_ip} is starting babel master&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line321">321</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line322">322</a>     while !@kill_sig_received do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line323">323</a>       queues = get_queues_from_shadow()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line324">324</a>       num_of_waiting_tasks = get_length_of_all_queues(queues)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line325">325</a>       if num_of_waiting_tasks.zero?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line326">326</a>         NeptuneManager.log(&quot;all queues are empty - waiting for tasks to arrive&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line327">327</a>         Kernel.sleep(TIME_TO_WAIT_FOR_NEW_TASKS)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line328">328</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line329">329</a>         spawn_babel_slaves(num_of_waiting_tasks)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line330">330</a>         NeptuneManager.log(&quot;workers spawned - waiting for them to run tasks&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line331">331</a>         Kernel.sleep(TIME_FOR_NEW_NODES_TO_GET_TASKS)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line332">332</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line333">333</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line334">334</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line335">335</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line336">336</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line337">337</a>   # Nodes that run as babel_slaves are workers in the system. They ask the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line338">338</a>   # master what queues tasks are stored on, and try to execute a configurable</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line339">339</a>   # number of tasks at a time.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line340">340</a>   def start_babel_slave()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line341">341</a>     Thread.new {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line342">342</a>     NeptuneManager.log(&quot;#{my_node.private_ip} is starting babel slave&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line343">343</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line344">344</a>     time_spent_idle = 0.0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line345">345</a>     loop {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line346">346</a>       queues = get_queues_from_shadow()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line347">347</a>       cores_per_machine = HelperFunctions.get_num_cpus()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line348">348</a>       tasks = get_n_items_of_work(cores_per_machine, queues)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line349">349</a>       if tasks.length.zero?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line350">350</a>         if time_spent_idle &gt; MAX_IDLE_TIME</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line351">351</a>           NeptuneManager.log(&quot;Spent too much time idle - reverting to open for now&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line352">352</a>           break</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line353">353</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line354">354</a>           NeptuneManager.log(&quot;no tasks found, waiting for more to arrive&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line355">355</a>           Kernel.sleep(TIME_TO_WAIT_FOR_NEW_TASKS)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line356">356</a>           time_spent_idle += TIME_TO_WAIT_FOR_NEW_TASKS</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line357">357</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line358">358</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line359">359</a>         NeptuneManager.log(&quot;#{tasks.length} tasks found, executing&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line360">360</a>         execute_multiple_tasks(tasks)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line361">361</a>         time_spent_idle = 0.0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line362">362</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line363">363</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line364">364</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line365">365</a>     NeptuneManager.log(&quot;Removing babel slave roles from this node&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line366">366</a>     ZKInterface.lock_and_run {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line367">367</a>       ZKInterface.remove_roles_from_node([&quot;rabbitmq_slave, &quot;&quot;babel_slave&quot;], </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line368">368</a>         my_node)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line369">369</a>       ZKInterface.add_roles_to_node([&quot;open&quot;], my_node)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line370">370</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line371">371</a>     NeptuneManager.log(&quot;Finished removing roles via ZooKeeper&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line372">372</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line373">373</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line374">374</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line375">375</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line376">376</a>   def stop_babel_master()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line377">377</a>     NeptuneManager.log(&quot;#{my_node.private_ip} is stopping babel master&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line378">378</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line379">379</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line380">380</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line381">381</a>   def stop_babel_slave()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line382">382</a>     NeptuneManager.log(&quot;#{my_node.private_ip} is stopping babel slave&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line383">383</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line384">384</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line385">385</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line386">386</a>   def run_task(job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line387">387</a>     dir = NeptuneManager.create_temp_dir()</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line388">388</a>     NeptuneManager.copy_code_and_inputs_to_dir(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line389">389</a>     output, error = NeptuneManager.run_code(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line390">390</a>     NeptuneManager.write_babel_outputs(output, error, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line391">391</a>     NeptuneManager.cleanup(dir)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line392">392</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line393">393</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line394">394</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line395">395</a>   def self.create_temp_dir()</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line396">396</a>     dir = &quot;/tmp/babel-#{rand(10000)}/&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line397">397</a>     FileUtils.mkdir_p(dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line398">398</a>     return dir</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line399">399</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line400">400</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line401">401</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line402">402</a>   def self.copy_code_and_inputs_to_dir(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line403">403</a>     input_storage_start_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line404">404</a>     NeptuneManager.copy_code_to_dir(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line405">405</a>     NeptuneManager.copy_inputs_to_dir(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line406">406</a>     input_storage_end_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line407">407</a>     job_data['@metadata_info']['input_storage_time'] = input_storage_end_time - input_storage_start_time</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line408">408</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line409">409</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line410">410</a>   def self.copy_code_to_dir(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line411">411</a>     if !self.is_storage_location?(job_data['@code'])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line412">412</a>       abort(&quot;The given code, #{job_data['@code']}, is not something we can fetch&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line413">413</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line414">414</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line415">415</a>     NeptuneManager.log(&quot;old code is #{job_data['@code']}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line416">416</a>     local_folder = self.copy_file_to_dir(File.dirname(job_data['@code']), dir, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line417">417</a>     job_data['@code'] = local_folder + '/' + File.basename(job_data['@code'])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line418">418</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line419">419</a>     # If the code isn't going to be executed by a different program (e.g., python)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line420">420</a>     # then we need to make it executable</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line421">421</a>     if job_data[&quot;@executable&quot;].nil? or job_data[&quot;@executable&quot;].empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line422">422</a>       NeptuneManager.log(&quot;making code executable&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line423">423</a>       HelperFunctions.shell(&quot;chmod +x #{job_data['@code']}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line424">424</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line425">425</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line426">426</a>     NeptuneManager.log(&quot;new code is #{job_data['@code']}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line427">427</a>     return job_data['@code']</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line428">428</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line429">429</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line430">430</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line431">431</a>   def self.copy_inputs_to_dir(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line432">432</a>     return if job_data['@argv'].class != Array</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line433">433</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line434">434</a>     new_argv = []</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line435">435</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line436">436</a>     NeptuneManager.log(&quot;old argv is #{job_data['@argv'].join(' ')}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line437">437</a>     job_data['@argv'].each { |arg|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line438">438</a>       if self.is_storage_location?(arg)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line439">439</a>         new_argv &lt;&lt; self.copy_file_to_dir(arg, dir, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line440">440</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line441">441</a>         new_argv &lt;&lt; arg</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line442">442</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line443">443</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line444">444</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line445">445</a>     job_data['@argv'] = new_argv</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line446">446</a>     NeptuneManager.log(&quot;new argv is #{job_data['@argv'].join(' ')}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line447">447</a>     return</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line448">448</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line449">449</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line450">450</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line451">451</a>   def self.copy_file_to_dir(remote, local, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line452">452</a>     bucket, file = DatastoreS3.parse_s3_key(remote)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line453">453</a>     remote_dir = file</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line454">454</a>     local_file = File.expand_path(local + &quot;/&quot; + remote_dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line455">455</a>     NeptuneManager.log(&quot;downloading remote file #{remote} to local location #{local_file}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line456">456</a>     NeptuneManager.log(&quot;bucket is #{bucket}, file is #{file}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line457">457</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line458">458</a>     datastore = DatastoreFactory.get_datastore(job_data['@storage'], job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line459">459</a>     datastore.get_output_and_save_to_fs(remote, local)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line460">460</a>     return local_file</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line461">461</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line462">462</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line463">463</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line464">464</a>   def self.run_code(job_data, dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line465">465</a>     filename_to_exec = job_data['@code']</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line466">466</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line467">467</a>     executable = job_data['@executable'] || &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line468">468</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line469">469</a>     # If the user specifies an argv to pass to the code to exec, be sure to</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line470">470</a>     # capture it and pass it along</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line471">471</a>     if job_data[&quot;@argv&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line472">472</a>       argv = job_data[&quot;@argv&quot;].join(' ')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line473">473</a>       # TODO(cgb): filter out colons and other things that malicious users could</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line474">474</a>       # use to hijack the system</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line475">475</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line476">476</a>       argv = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line477">477</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line478">478</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line479">479</a>     output_file = &quot;#{dir}/stdout-#{HelperFunctions.get_random_alphanumeric()}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line480">480</a>     error_file = &quot;#{dir}/stderr-#{HelperFunctions.get_random_alphanumeric()}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line481">481</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line482">482</a>     # For most file types, we can use the full path when executing them. For</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line483">483</a>     # programs that run over the JVM (e.g., Java, Scala), we can't - we need </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line484">484</a>     # to change into the directory where the file is located and exec the file </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line485">485</a>     # from there.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line486">486</a>     # TODO(cgb): Consider a job_data['@jvm_args'] option (with an array val)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line487">487</a>     # that users can set to pass in arguments that we should pass to the JVM</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line488">488</a>     # we are about to run.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line489">489</a>     if executable == &quot;java&quot; or executable == &quot;scala&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line490">490</a>       dir = File.dirname(filename_to_exec)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line491">491</a>       file = File.basename(filename_to_exec)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line492">492</a>       exec_command = &quot;cd #{dir}; #{executable} #{file} #{argv} 1&gt;#{output_file} 2&gt;#{error_file}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line493">493</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line494">494</a>       exec_command = &quot;#{executable} #{filename_to_exec} #{argv} 1&gt;#{output_file} 2&gt;#{error_file}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line495">495</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line496">496</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line497">497</a>     start_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line498">498</a>     ret_val = HelperFunctions.shell(exec_command)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line499">499</a>     end_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line500">500</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line501">501</a>     total = end_time - start_time</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line502">502</a>     NeptuneManager.log(&quot;Babel: Done running job!&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line503">503</a>     NeptuneManager.log(&quot;TIMING: Took #{total} seconds&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line504">504</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line505">505</a>     # Save some data about the task we just ran. At a high level, there are two</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line506">506</a>     # types of information we want to save: debugging information (in case the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line507">507</a>     # task failed and the user needs to deduce why), and profiling information</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line508">508</a>     # (so the user can see how long their code took to run).</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line509">509</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line510">510</a>     # Add in debugging information.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line511">511</a>     job_data['@metadata_info']['command'] = exec_command</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line512">512</a>     job_data['@metadata_info']['return_value'] = ret_val</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line513">513</a>     job_data['@metadata_info']['cpu_info'] = HelperFunctions.shell(&quot;cat /proc/cpuinfo&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line514">514</a>     job_data['@metadata_info']['mem_info'] = HelperFunctions.shell(&quot;cat /proc/meminfo&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line515">515</a>     job_data['@metadata_info']['df_h'] = HelperFunctions.shell(&quot;df -h&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line516">516</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line517">517</a>     # Add in profiling information, with all times converted to seconds since epoch.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line518">518</a>     job_data['@metadata_info']['start_time'] = start_time.to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line519">519</a>     job_data['@metadata_info']['end_time'] = end_time.to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line520">520</a>     job_data['@metadata_info']['total_execution_time'] = total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line521">521</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line522">522</a>     return output_file, error_file</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line523">523</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line524">524</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line525">525</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line526">526</a>   # Writes the stdout and stderr that a Babel task produces to the remote</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line527">527</a>   # datastore that the user has specified to use. We also automatically collect</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line528">528</a>   # some metadata about the task, so we write that to the datastore as well.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line529">529</a>   def self.write_babel_outputs(output, error, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line530">530</a>     datastore = DatastoreFactory.get_datastore(job_data['@storage'], job_data)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line531">531</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line532">532</a>     # Write our stdout file</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line533">533</a>     NeptuneManager.log(&quot;Saving stdout at #{output} to remote location&quot; + </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line534">534</a>       &quot; #{job_data['@output']}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line535">535</a>     output_storage_start_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line536">536</a>     datastore.write_remote_file_from_local_file(job_data['@output'], output)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line537">537</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line538">538</a>     # Write our stderr file</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line539">539</a>     NeptuneManager.log(&quot;Saving stderr #{error} to remote location&quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line540">540</a>       &quot; #{job_data['@error']}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line541">541</a>     datastore.write_remote_file_from_local_file(job_data['@error'], error)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line542">542</a>     output_storage_end_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line543">543</a>     total_output_time = output_storage_end_time - output_storage_start_time</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line544">544</a>     job_data['@metadata_info']['output_storage_time'] = total_output_time</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line545">545</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line546">546</a>     local_input_storage_time = job_data['@metadata_info']['time_to_store_inputs'] || 0.0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line547">547</a>     total_input_time = job_data['@metadata_info']['input_storage_time'] || 0.0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line548">548</a>     job_data['@metadata_info']['total_storage_time'] = local_input_storage_time + </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line549">549</a>       total_input_time + total_output_time</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line550">550</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line551">551</a>     end_of_task_time = Time.now.to_f</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line552">552</a>     start_of_task_time = job_data['@metadata_info']['received_task_at'] || 0.0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line553">553</a>     total_task_time = end_of_task_time - start_of_task_time</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line554">554</a>     job_data['@metadata_info']['total_task_time'] = total_task_time</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line555">555</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line556">556</a>     # Write our metadata info, which is not a file, but a hash we will turn to</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line557">557</a>     # a string via JSON</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line558">558</a>     NeptuneManager.log(&quot;Saving metadata #{job_data['@metadata_info'].inspect} &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line559">559</a>       &quot;to remote location #{job_data['@metadata']}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line560">560</a>     metadata_file = &quot;/tmp/metadata-#{HelperFunctions.get_random_alphanumeric()}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line561">561</a>     HelperFunctions.write_file(metadata_file, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line562">562</a>       JSON.dump(job_data['@metadata_info']))</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line563">563</a>     datastore.write_remote_file_from_local_file(job_data['@metadata'], </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line564">564</a>       metadata_file)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line565">565</a>     FileUtils.rm_f(metadata_file)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line566">566</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line567">567</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line568">568</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line569">569</a>   def self.save_output(remote_output, local_output, job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line570">570</a>     NeptuneManager.log(&quot;Saving local output #{local_output} to remote location #{remote_output}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line571">571</a>     datastore = DatastoreFactory.get_datastore(job_data['@storage'], job_data)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line572">572</a>     datastore.write_remote_file_from_local_file(remote_output, local_output)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line573">573</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line574">574</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line575">575</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line576">576</a>   def self.cleanup(dir)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line577">577</a>     NeptuneManager.log(&quot;Cleaning up directory #{dir}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line578">578</a>     # don't clean up if we want to debug the system</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line579">579</a>     return if DEBUG</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line580">580</a>     FileUtils.rm_rf(dir)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line581">581</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line582">582</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line583">583</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line584">584</a>   def self.is_storage_location?(file)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line585">585</a>     return STORAGE_PARAM_REGEX.match(file)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line586">586</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line587">587</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line588">588</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line589">589</a>   def get_queues_from_shadow()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line590">590</a>     secret = HelperFunctions.get_secret()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line591">591</a>     acc = AppControllerClient.new(get_shadow.public_ip, secret)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line592">592</a>     json_queue_and_cred_info = acc.get_queues_in_use()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line593">593</a>     NeptuneManager.log(&quot;raw json received is '#{json_queue_and_cred_info}'&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line594">594</a>     queue_and_cred_info = JSON.load(json_queue_and_cred_info)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line595">595</a>     NeptuneManager.log(&quot;json formatted data is [#{queue_and_cred_info}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line596">596</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line597">597</a>     queues = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line598">598</a>     if queue_and_cred_info.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line599">599</a>       NeptuneManager.log(&quot;queues from shadow are nil&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line600">600</a>       return queues</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line601">601</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line602">602</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line603">603</a>     queue_and_cred_info.each { |info|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line604">604</a>       NeptuneManager.log(&quot;this queue's info is #{info.inspect}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line605">605</a>       engine = info.keys[0]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line606">606</a>       credentials = info.values[0]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line607">607</a>       NeptuneManager.log(&quot;engine is [#{engine}], credentials are [#{credentials.inspect}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line608">608</a>       queues &lt;&lt; QueueFactory.get_queue(engine, credentials)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line609">609</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line610">610</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line611">611</a>     NeptuneManager.log(&quot;queues from shadow are [#{queues.join(', ')}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line612">612</a>     return queues</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line613">613</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line614">614</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line615">615</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line616">616</a>   def get_length_of_all_queues(queues)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line617">617</a>     # something to consider: do leased tasks count in the size?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line618">618</a>     length = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line619">619</a>     queues.each { |q|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line620">620</a>       length += q.size</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line621">621</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line622">622</a>     return length</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line623">623</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line624">624</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line625">625</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line626">626</a>   def get_n_items_of_work(n, queues)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line627">627</a>     items = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line628">628</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line629">629</a>     queues.each { |q|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line630">630</a>       loop {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line631">631</a>         NeptuneManager.log(&quot;popping an item of work off of queue #{q}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line632">632</a>         start_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line633">633</a>         new_item = q.pop</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line634">634</a>         end_time = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line635">635</a>         if new_item.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line636">636</a>           NeptuneManager.log(&quot;#{q} is empty - moving on to next queue&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line637">637</a>           break  # the queue is empty</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line638">638</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line639">639</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line640">640</a>         # add how long it took to grab the item from the queue to our metadata</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line641">641</a>         if !new_item[&quot;@metadata_info&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line642">642</a>           new_item = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line643">643</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line644">644</a>         queue_pop_time = end_time - start_time</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line645">645</a>         new_item['@metadata_info']['queue_pop_time'] = queue_pop_time</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line646">646</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line647">647</a>         NeptuneManager.log(&quot;adding [#{new_item}][#{new_item.class}] to items&quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line648">648</a>           &quot; - took #{queue_pop_time} seconds to pop it off the queue&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line649">649</a>         items &lt;&lt; new_item</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line650">650</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line651">651</a>         break if items.length &gt;= n</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line652">652</a>       }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line653">653</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line654">654</a>       break if items.length &gt;= n</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line655">655</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line656">656</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line657">657</a>     NeptuneManager.log(&quot;returning [#{items.join(', ')}] items of work&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line658">658</a>     return items</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line659">659</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line660">660</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line661">661</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line662">662</a>   # A Babel master can call this method to add more workers (Babel slaves) to the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line663">663</a>   # system as needed.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line664">664</a>   def spawn_babel_slaves(num_of_waiting_tasks)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line665">665</a>     NeptuneManager.log(&quot;spawning workers to handle #{num_of_waiting_tasks} tasks&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line666">666</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line667">667</a>     if is_cloud?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line668">668</a>       instance_type = &quot;m1.large&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line669">669</a>       #instance_type = &quot;m2.4xlarge&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line670">670</a>       cores_per_machine = INSTANCE_CPU_INFO[instance_type]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line671">671</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line672">672</a>       instance_type = &quot;m1.large&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line673">673</a>       cores_per_machine = 2</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line674">674</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line675">675</a>     NeptuneManager.log(&quot;Using #{cores_per_machine} cores/machine&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line676">676</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line677">677</a>     # First, calculate how many machines we would need to run all the tasks</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line678">678</a>     # as fast as possible, by running one task per core.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line679">679</a>     optimal_num_of_vms = (num_of_waiting_tasks / Float(cores_per_machine)).ceil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line680">680</a>     NeptuneManager.log(&quot;Will run #{num_of_waiting_tasks} on &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line681">681</a>       &quot;#{optimal_num_of_vms} VMs&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line682">682</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line683">683</a>     # The optimal number of VMs is optimal with respect to performance, but</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line684">684</a>     # is not optimal with respect to cost. As the user has told us what the</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line685">685</a>     # maximum number of machines they want to run are, grab that number and</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line686">686</a>     # compare the two to see how many machines we should actually acquire.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line687">687</a>     user_num_of_vms = ZKInterface.get_max_machines_for_babel_slaves()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line688">688</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line689">689</a>     total_num_of_vms_needed = [optimal_num_of_vms, user_num_of_vms].min</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line690">690</a>     NeptuneManager.log(&quot;For #{num_of_waiting_tasks} tasks, the optimal number of &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line691">691</a>       &quot;VMs to use is #{optimal_num_of_vms} VMs, while the user specified that &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line692">692</a>       &quot;no more than #{user_num_of_vms} VMs - using #{total_num_of_vms_needed} &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line693">693</a>       &quot;total VMs&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line694">694</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line695">695</a>     # A previous invocation of this function may have already spawned up</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line696">696</a>     # babel slaves, so to obey the maximum that the user has given us, we have to</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line697">697</a>     # subtract any already running babel slaves out of the value calculated above.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line698">698</a>     babel_slaves_already_running = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line699">699</a>     @nodes.each { |node|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line700">700</a>       babel_slaves_already_running += 1 if node.is_babel_slave?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line701">701</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line702">702</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line703">703</a>     num_of_vms_needed = total_num_of_vms_needed - babel_slaves_already_running</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line704">704</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line705">705</a>     if num_of_vms_needed &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line706">706</a>       NeptuneManager.log(&quot;#{babel_slaves_already_running} VMs are already running &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line707">707</a>         &quot;as babel slaves, so we still need to spawn #{num_of_vms_needed} VMs&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line708">708</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line709">709</a>       # Include rabbitmq_slave in here since we want to always be able to point</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line710">710</a>       # our RabbitMQ client to localhost to get tasks</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line711">711</a>       nodes_needed = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line712">712</a>       num_of_vms_needed.times { |i|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line713">713</a>         nodes_needed &lt;&lt; [&quot;rabbitmq_slave&quot;, &quot;babel_slave&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line714">714</a>       }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line715">715</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line716">716</a>       start_new_roles_on_nodes(nodes_needed, instance_type,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line717">717</a>         HelperFunctions.get_secret())</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line718">718</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line719">719</a>       NeptuneManager.log(&quot;#{babel_slaves_already_running} VMs are already &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line720">720</a>         &quot;running, and as can only have a maximum of #{num_of_vms_needed}, we &quot; +</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line721">721</a>         &quot;don't need to acquire more babel slaves right now&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line722">722</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line723">723</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line724">724</a>     return</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line725">725</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line726">726</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line727">727</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line728">728</a>   # This method spawns a thread for each task given to execute them in parallel.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line729">729</a>   # It then waits for all tasks to complete before returning.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line730">730</a>   def execute_multiple_tasks(tasks)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line731">731</a>     threads = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line732">732</a>     tasks.each { |task|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line733">733</a>       threads &lt;&lt; Thread.new {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line734">734</a>         run_task(task)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line735">735</a>       }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line736">736</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line737">737</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line738">738</a>     threads.each { |t| t.join }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line739">739</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line740">740</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line741">741</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line742">742</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Sat Sep 01 14:56:54 -0700 2012 with <a href="http://github.com/relevance/rcov">rcov 1.0.0</a></p>

  </body>
</html>
