<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module CronHelper - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>AppController/lib/cron_helper.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-clear_crontab">::clear_crontab</a>
    
    <li><a href="#method-c-update_cron">::update_cron</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./AppScaleException.html">AppScaleException</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./BlobServer.html">BlobServer</a>
  
    <li><a href="./Collectd.html">Collectd</a>
  
    <li><a href="./CronHelper.html">CronHelper</a>
  
    <li><a href="./Djinn.html">Djinn</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./DjinnServer.html">DjinnServer</a>
  
    <li><a href="./Ejabberd.html">Ejabberd</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GodInterface.html">GodInterface</a>
  
    <li><a href="./HAProxy.html">HAProxy</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./LoadBalancer.html">LoadBalancer</a>
  
    <li><a href="./Monitoring.html">Monitoring</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./Nginx.html">Nginx</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PbServer.html">PbServer</a>
  
    <li><a href="./RabbitMQ.html">RabbitMQ</a>
  
    <li><a href="./Repo.html">Repo</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module CronHelper</h1>

  <div id="description" class="description">
    
<p>A module that abstracts away interactions with our implementation of the
Google App Engine Cron API. It lets users write specifications for how
often URLs in their web app should be accessed, and turns that into
standard cron jobs.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-clear_crontab" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_crontab</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="clear_crontab-source">
            <pre><span class="ruby-comment"># File AppController/lib/cron_helper.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clear_crontab</span>
  <span class="ruby-value">%xcrontab -r`</span>  
<span class="ruby-keyword">end</span></pre>
          </div><!-- clear_crontab-source -->
          
        </div>

        

        
      </div><!-- clear_crontab-method -->

    
      <div id="method-c-update_cron" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_cron</span><span
            class="method-args">(ip, lang, app)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="update_cron-source">
            <pre><span class="ruby-comment"># File AppController/lib/cron_helper.rb, line 12</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_cron</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">lang</span>, <span class="ruby-identifier">app</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;saw a cron request with args [#{ip}][#{lang}][#{app}]&quot;</span>) 

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">lang</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;python&quot;</span>
    <span class="ruby-identifier">cron_file</span> = <span class="ruby-node">&quot;/var/apps/#{app}/app/cron.yaml&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">cron_file</span>)
    <span class="ruby-identifier">cron_yaml</span> = <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load_file</span>(<span class="ruby-identifier">cron_file</span>)[<span class="ruby-string">&quot;cron&quot;</span>]
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cron_yaml</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">cron_yaml</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">description</span> = <span class="ruby-identifier">item</span>[<span class="ruby-string">&quot;description&quot;</span>]
      <span class="ruby-comment"># since url gets put at end of curl, need to ensure it</span>
      <span class="ruby-comment"># is of the form /baz to prevent malicious urls</span>
      <span class="ruby-identifier">url</span> = <span class="ruby-identifier">item</span>[<span class="ruby-string">&quot;url&quot;</span>].<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r\A(\/[\/\d\w]+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
      <span class="ruby-identifier">schedule</span> = <span class="ruby-identifier">item</span>[<span class="ruby-string">&quot;schedule&quot;</span>]
      <span class="ruby-identifier">timezone</span> = <span class="ruby-identifier">item</span>[<span class="ruby-string">&quot;timezone&quot;</span>] <span class="ruby-comment"># will add support later for this</span>
      <span class="ruby-identifier">cron_scheds</span> = <span class="ruby-identifier">convert_schedule_to_cron</span>(<span class="ruby-identifier">schedule</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">app</span>)
      <span class="ruby-identifier">cron_scheds</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
      <span class="ruby-comment">#  cron_info = &lt;&lt;CRON</span>
      <span class="ruby-comment">#  Description: #{description}</span>
      <span class="ruby-comment">#  URL: #{url}</span>
      <span class="ruby-comment">#  Schedule: #{schedule}</span>
      <span class="ruby-comment">#  TimeZone: #{timezone}</span>
      <span class="ruby-comment">#  Cron Schedule: #{line}</span>
      <span class="ruby-comment">#CRON</span>
      <span class="ruby-comment">#  Djinn.log_debug(cron_info)</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Adding cron line: [#{line}]&quot;</span>)
        <span class="ruby-identifier">add_line_to_crontab</span>(<span class="ruby-identifier">line</span>)
      }
    }
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">lang</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;java&quot;</span>
    <span class="ruby-identifier">cron_file</span> = <span class="ruby-node">&quot;/var/apps/#{app}/app/war/WEB-INF/cron.xml&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">cron_file</span>)
    <span class="ruby-identifier">cron_xml</span> = <span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">cron_file</span>)).<span class="ruby-identifier">root</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cron_xml</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">cron_xml</span>.<span class="ruby-identifier">each_element</span>(<span class="ruby-string">'//cron'</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">description</span> = <span class="ruby-identifier">get_from_xml</span>(<span class="ruby-identifier">item</span>, <span class="ruby-string">&quot;description&quot;</span>)
      <span class="ruby-comment"># since url gets put at end of curl, need to ensure it</span>
      <span class="ruby-comment"># is of the form /baz to prevent malicious urls</span>
      <span class="ruby-identifier">url</span> = <span class="ruby-identifier">get_from_xml</span>(<span class="ruby-identifier">item</span>, <span class="ruby-string">&quot;url&quot;</span>).<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r\A(\/[\/\d\w]+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
      <span class="ruby-identifier">schedule</span> = <span class="ruby-identifier">get_from_xml</span>(<span class="ruby-identifier">item</span>, <span class="ruby-string">&quot;schedule&quot;</span>)
      <span class="ruby-identifier">timezone</span> = <span class="ruby-identifier">get_from_xml</span>(<span class="ruby-identifier">item</span>, <span class="ruby-string">&quot;timezone&quot;</span>) <span class="ruby-comment"># will add support later for this</span>
      <span class="ruby-identifier">cron_scheds</span> = <span class="ruby-identifier">convert_schedule_to_cron</span>(<span class="ruby-identifier">schedule</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">app</span>)
      <span class="ruby-identifier">cron_scheds</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
      <span class="ruby-comment">#  cron_info = &lt;&lt;CRON</span>
      <span class="ruby-comment">#  Description: #{description}</span>
      <span class="ruby-comment">#  URL: #{url}</span>
      <span class="ruby-comment">#  Schedule: #{schedule}</span>
      <span class="ruby-comment">#  TimeZone: #{timezone}</span>
      <span class="ruby-comment">#  Cron Schedule: #{line}</span>
      <span class="ruby-comment">#CRON</span>
      <span class="ruby-comment">#  Djinn.log_debug(cron_info)</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Adding cron line: [#{line}]&quot;</span>)
        <span class="ruby-identifier">add_line_to_crontab</span>(<span class="ruby-identifier">line</span>)
      }
    }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;cron: lang was neither python nor java but was [#{lang}]&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_cron-source -->
          
        </div>

        

        
      </div><!-- update_cron-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

