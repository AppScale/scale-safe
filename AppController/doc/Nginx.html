<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module Nginx - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>AppController/lib/nginx.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-app_listen_port">::app_listen_port</a>
    
    <li><a href="#method-c-check_config">::check_config</a>
    
    <li><a href="#method-c-clear_sites_enabled">::clear_sites_enabled</a>
    
    <li><a href="#method-c-create_app_config">::create_app_config</a>
    
    <li><a href="#method-c-create_app_load_balancer_config">::create_app_load_balancer_config</a>
    
    <li><a href="#method-c-create_app_monitoring_config">::create_app_monitoring_config</a>
    
    <li><a href="#method-c-create_pbserver_config">::create_pbserver_config</a>
    
    <li><a href="#method-c-initialize_config">::initialize_config</a>
    
    <li><a href="#method-c-is_running-3F">::is_running?</a>
    
    <li><a href="#method-c-reload">::reload</a>
    
    <li><a href="#method-c-reload_nginx">::reload_nginx</a>
    
    <li><a href="#method-c-remove_app">::remove_app</a>
    
    <li><a href="#method-c-restart">::restart</a>
    
    <li><a href="#method-c-start">::start</a>
    
    <li><a href="#method-c-stop">::stop</a>
    
    <li><a href="#method-c-write_app_config">::write_app_config</a>
    
    <li><a href="#method-c-write_fullproxy_app_config">::write_fullproxy_app_config</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./AppScaleException.html">AppScaleException</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./BlobServer.html">BlobServer</a>
  
    <li><a href="./Collectd.html">Collectd</a>
  
    <li><a href="./CronHelper.html">CronHelper</a>
  
    <li><a href="./Djinn.html">Djinn</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./DjinnServer.html">DjinnServer</a>
  
    <li><a href="./Ejabberd.html">Ejabberd</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GodInterface.html">GodInterface</a>
  
    <li><a href="./HAProxy.html">HAProxy</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./LoadBalancer.html">LoadBalancer</a>
  
    <li><a href="./Monitoring.html">Monitoring</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./Nginx.html">Nginx</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PbServer.html">PbServer</a>
  
    <li><a href="./RabbitMQ.html">RabbitMQ</a>
  
    <li><a href="./Repo.html">Repo</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module Nginx</h1>

  <div id="description" class="description">
    
<p>A module to wrap all the interactions with the nginx web server Google App
Engine applications can request that certain files should be hosted
statically, so we use the nginx web server for this. It is the first server
that a user hits, and forwards non-static file requests to haproxy, which
then load balances requests to AppServers. This module configures and
deploys nginx within AppScale.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="BLOBSERVER_PORT">BLOBSERVER_PORT
        
        <dd class="description">
        
      
        <dt id="CHANNELSERVER_PORT">CHANNELSERVER_PORT
        
        <dd class="description">
        
      
        <dt id="CONFIG_EXTENSION">CONFIG_EXTENSION
        
        <dd class="description">
        
      
        <dt id="MAIN_CONFIG_FILE">MAIN_CONFIG_FILE
        
        <dd class="description">
        
      
        <dt id="NGINX_PATH">NGINX_PATH
        
        <dd class="description">
        
      
        <dt id="SITES_ENABLED_PATH">SITES_ENABLED_PATH
        
        <dd class="description">
        
      
        <dt id="SSL_PORT_OFFSET">SSL_PORT_OFFSET
        
        <dd class="description"><p>This is the start port of SSL connections to applications. Where an app
would have the set of ports (8080, 3700), (8081, 3701), and so on.</p>
        
      
        <dt id="START_PORT">START_PORT
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-app_listen_port" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">app_listen_port</span><span
            class="method-args">(app_number)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The port that nginx will be listen on for the given app number</p>
          

          
          <div class="method-source-code" id="app_listen_port-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
  <span class="ruby-constant">START_PORT</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">app_number</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- app_listen_port-source -->
          
        </div>

        

        
      </div><!-- app_listen_port-method -->

    
      <div id="method-c-check_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">check_config</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Return true if the configuration is good, false o.w.</p>
          

          
          <div class="method-source-code" id="check_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 77</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">check_config</span>
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;nginx -t -c #{MAIN_CONFIG_FILE}&quot;</span>)
  <span class="ruby-keyword">return</span> (<span class="ruby-identifier">$?</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- check_config-source -->
          
        </div>

        

        
      </div><!-- check_config-method -->

    
      <div id="method-c-clear_sites_enabled" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_sites_enabled</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Removes all the enabled sites</p>
          

          
          <div class="method-source-code" id="clear_sites_enabled-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 287</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clear_sites_enabled</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>)
    <span class="ruby-identifier">sites</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">entries</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>)
    <span class="ruby-comment"># Remove any files that are not configs</span>
    <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">site</span>.<span class="ruby-identifier">end_with?</span>(<span class="ruby-constant">CONFIG_EXTENSION</span>) }
    <span class="ruby-identifier">full_path_sites</span> = <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-identifier">site</span>) }
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span> <span class="ruby-identifier">full_path_sites</span>

    <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clear_sites_enabled-source -->
          
        </div>

        

        
      </div><!-- clear_sites_enabled-method -->

    
      <div id="method-c-create_app_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_app_config</span><span
            class="method-args">(my_public_ip, my_private_ip, proxy_port, listen_port, name, public_dir, ssl_port=nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>A generic function for creating nginx config files used by appscale
services</p>
          

          
          <div class="method-source-code" id="create_app_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 387</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">proxy_port</span>, 
    <span class="ruby-identifier">listen_port</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">public_dir</span>, <span class="ruby-identifier">ssl_port</span>=<span class="ruby-keyword">nil</span>)

    <span class="ruby-identifier">config</span> = <span class="ruby-string">&quot;upstream #{name} {
   server #{my_private_ip}:#{proxy_port};
}
&quot;</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ssl_port</span>
      <span class="ruby-comment"># redirect all request to ssl port.</span>
      <span class="ruby-identifier">config</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;server {
    listen #{listen_port};
    rewrite ^(.*) https://#{my_public_ip}:#{ssl_port}$1 permanent;
}

server {
    listen #{ssl_port};
    ssl on;
    ssl_certificate #{NGINX_PATH}/mycert.pem;
    ssl_certificate_key #{NGINX_PATH}/mykey.pem;
&quot;</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">config</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;server {
    listen #{listen_port};
&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">config</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;    root #{public_dir};
    access_log  /var/log/nginx/load-balancer.access.log upstream;
    error_log  /var/log/nginx/load-balancer.error.log;
    rewrite_log off;
    error_page 502 /502.html;

    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  REMOTE_ADDR  $remote_addr;
      proxy_set_header  HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;

      client_body_timeout 360;
      proxy_read_timeout 360;

      #Increase file size so larger applications can be uploaded
      client_max_body_size 30M;


      # go to proxy
      if (!-f $request_filename) {
        proxy_pass http://#{name};
        break;
      }
    }

    location /502.html {
      root #{APPSCALE_HOME}/AppLoadBalancer/public;
    }
}
&quot;</span>

    <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-node">&quot;#{name}.#{CONFIG_EXTENSION}&quot;</span>)
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }

    <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- create_app_config-source -->
          
        </div>

        

        
      </div><!-- create_app_config-method -->

    
      <div id="method-c-create_app_load_balancer_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_app_load_balancer_config</span><span
            class="method-args">(my_public_ip, my_private_ip, proxy_port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Create the configuration file for the AppLoadBalancer Rails application</p>
          

          
          <div class="method-source-code" id="create_app_load_balancer_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 300</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_load_balancer_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, 
  <span class="ruby-identifier">proxy_port</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">proxy_port</span>, 
    <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">listen_port</span>, <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">name</span>, 
    <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">public_directory</span>, <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">listen_ssl_port</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_app_load_balancer_config-source -->
          
        </div>

        

        
      </div><!-- create_app_load_balancer_config-method -->

    
      <div id="method-c-create_app_monitoring_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_app_monitoring_config</span><span
            class="method-args">(my_public_ip, my_private_ip, proxy_port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Create the configuration file for the AppMonitoring Rails application</p>
          

          
          <div class="method-source-code" id="create_app_monitoring_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 308</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_monitoring_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">proxy_port</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">proxy_port</span>, 
    <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">listen_port</span>, <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">name</span>, <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">public_directory</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_app_monitoring_config-source -->
          
        </div>

        

        
      </div><!-- create_app_monitoring_config-method -->

    
      <div id="method-c-create_pbserver_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_pbserver_config</span><span
            class="method-args">(my_ip, proxy_port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Create the configuration file for the pbserver</p>
          

          
          <div class="method-source-code" id="create_pbserver_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 314</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_pbserver_config</span>(<span class="ruby-identifier">my_ip</span>, <span class="ruby-identifier">proxy_port</span>)
    <span class="ruby-identifier">config</span> = <span class="ruby-string">&quot;upstream #{PbServer::NAME} {
    server #{my_ip}:#{proxy_port};
}
    
server {
    listen #{PbServer::LISTEN_PORT_NO_SSL};
    server_name #{my_ip};
    root /root/appscale/AppDB/;
    # Uncomment these lines to enable logging, and comment out the following two
    #access_log  /var/log/nginx/pbserver.access.log upstream;
    #error_log  /var/log/nginx/pbserver.error.log;
    access_log off;
    error_log /dev/null crit;

    rewrite_log off;
    error_page 404 = /404.html;



    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://#{PbServer::NAME};
      client_max_body_size 30M;
      proxy_connect_timeout 60;
      client_body_timeout 60;
      proxy_read_timeout 60;
    }

}

server {
    listen #{PbServer::LISTEN_PORT_WITH_SSL};
    ssl on;
    ssl_certificate /etc/nginx/mycert.pem;
    ssl_certificate_key /etc/nginx/mykey.pem;
    root /root/appscale/AppDB/public;
    #access_log  /var/log/nginx/pbencrypt.access.log upstream;
    #error_log  /var/log/nginx/pbencrypt.error.log;
    access_log off;
    error_log  /dev/null crit;

    rewrite_log off;
    error_page 502 /502.html;

    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;

      client_body_timeout 60;
      proxy_read_timeout 60;
      #Increase file size so larger applications can be uploaded
      client_max_body_size 30M;
      # go to proxy
      proxy_pass http://#{PbServer::NAME};
    }
}
&quot;</span>
    <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-node">&quot;#{PbServer::NAME}.#{CONFIG_EXTENSION}&quot;</span>)
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }

    <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>

  <span class="ruby-keyword">end</span></pre>
          </div><!-- create_pbserver_config-source -->
          
        </div>

        

        
      </div><!-- create_pbserver_config-method -->

    
      <div id="method-c-initialize_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_config</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Set up the folder structure and creates the configuration files necessary
for nginx</p>
          

          
          <div class="method-source-code" id="initialize_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 460</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">initialize_config</span>
    <span class="ruby-identifier">config</span> = <span class="ruby-string">&quot;user www-data;
worker_processes  1;

error_log  /var/log/nginx/error.log;
pid        /var/run/nginx.pid;

events {
    worker_connections  30000;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log  /var/log/nginx/access.log;

    log_format upstream '$remote_addr - - [$time_local] &quot;$request&quot; status $status '
                        'upstream $upstream_response_time request $request_time '
                        '[for $host via $upstream_addr]';

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  60;
    tcp_nodelay        on;
    server_names_hash_bucket_size 128;

    gzip  on;

    include #{NGINX_PATH}/sites-enabled/*;
}
&quot;</span>

    <span class="ruby-value">%xmkdir -p /var/log/nginx/`</span>
    <span class="ruby-comment"># Create the sites enabled folder</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-constant">SITES_ENABLED_PATH</span>
      <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">SITES_ENABLED_PATH</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># copy over certs for ssl</span>
    <span class="ruby-comment"># just copy files once to keep certificate as static.</span>
    <span class="ruby-comment">#`test ! -e #{NGINX_PATH}/mycert.pem &amp;&amp; cp /etc/appscale/certs/mycert.pem #{NGINX_PATH}`</span>
    <span class="ruby-comment">#`test ! -e #{NGINX_PATH}/mykey.pem &amp;&amp; cp /etc/appscale/certs/mykey.pem #{NGINX_PATH}`</span>
    <span class="ruby-node">%xcp /etc/appscale/certs/mykey.pem #{NGINX_PATH}`</span>
    <span class="ruby-node">%xcp /etc/appscale/certs/mycert.pem #{NGINX_PATH}`</span>
    <span class="ruby-comment"># Write the main configuration file which sets default configuration parameters</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">MAIN_CONFIG_FILE</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }
  <span class="ruby-keyword">end</span></pre>
          </div><!-- initialize_config-source -->
          
        </div>

        

        
      </div><!-- initialize_config-method -->

    
      <div id="method-c-is_running-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_running?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_running-3F-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 62</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_running?</span>
  <span class="ruby-identifier">processes</span> = <span class="ruby-value">%xps ax | grep nginx | grep -v grep | wc -l`</span>.<span class="ruby-identifier">chomp</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">processes</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_running-3F-source -->
          
        </div>

        

        
      </div><!-- is_running-3F-method -->

    
      <div id="method-c-reload" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reload</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="reload-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 58</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">restart</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reload-source -->
          
        </div>

        

        
      </div><!-- reload-method -->

    
      <div id="method-c-reload_nginx" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reload_nginx</span><span
            class="method-args">(config_path, app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="reload_nginx-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 269</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reload_nginx</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-identifier">app_name</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">check_config</span>
    <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Unable to load Nginx config for #{app_name}&quot;</span>) 
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-identifier">config_path</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reload_nginx-source -->
          
        </div>

        

        
      </div><!-- reload_nginx-method -->

    
      <div id="method-c-remove_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_app</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_app-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 280</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_app</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-identifier">config_name</span> = <span class="ruby-node">&quot;#{app_name}.#{CONFIG_EXTENSION}&quot;</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-identifier">config_name</span>))
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_app-source -->
          
        </div>

        

        
      </div><!-- remove_app-method -->

    
      <div id="method-c-restart" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restart</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="restart-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 53</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">restart</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">stop</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">start</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- restart-source -->
          
        </div>

        

        
      </div><!-- restart-method -->

    
      <div id="method-c-start" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 45</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">start</span>
  <span class="ruby-value">%x/etc/init.d/nginx start`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start-source -->
          
        </div>

        

        
      </div><!-- start-method -->

    
      <div id="method-c-stop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 49</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">stop</span>
  <span class="ruby-value">%x/etc/init.d/nginx stop`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop-source -->
          
        </div>

        

        
      </div><!-- stop-method -->

    
      <div id="method-c-write_app_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_app_config</span><span
            class="method-args">(app_name, app_number, my_public_ip, proxy_port, static_handlers, login_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a <a href="Nginx.html">Nginx</a> config file for the provided app
name</p>
          

          
          <div class="method-source-code" id="write_app_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 83</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">proxy_port</span>, <span class="ruby-identifier">static_handlers</span>, <span class="ruby-identifier">login_ip</span>)
    <span class="ruby-identifier">static_locations</span> = <span class="ruby-identifier">static_handlers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">handler</span><span class="ruby-operator">|</span> <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">generate_location_config</span>(<span class="ruby-identifier">handler</span>) }.<span class="ruby-identifier">join</span>
    <span class="ruby-identifier">listen_port</span> = <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
    <span class="ruby-identifier">config</span> = <span class="ruby-string">&quot;# Any requests that arent static files get sent to haproxy
upstream gae_#{app_name} {
    server #{my_public_ip}:#{proxy_port};
}

server {
    listen #{listen_port};
    server_name #{my_public_ip};
    root /var/apps/#{app_name}/app;
    # Uncomment these lines to enable logging, and comment out the following two
    #access_log  /var/log/nginx/#{app_name}.access.log upstream;
    error_log  /var/log/nginx/#{app_name}.error.log;
    access_log off;
    #error_log /dev/null crit;

    rewrite_log off;
    error_page 404 = /404.html;
    set $cache_dir /var/apps/#{app_name}/cache;

    #{static_locations}

    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://gae_#{app_name};
      client_max_body_size 2G;
      proxy_connect_timeout 60;
      client_body_timeout 60;
      proxy_read_timeout 60;
    }

    location /404.html {
      root /var/apps/#{app_name};
    }

    location /reserved-channel-appscale-path {
      proxy_buffering off;
      tcp_nodelay on;
      keepalive_timeout 55;
      proxy_pass http://#{login_ip}:#{CHANNELSERVER_PORT}/http-bind;
    }

}
&quot;</span>

    <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-node">&quot;#{app_name}.#{CONFIG_EXTENSION}&quot;</span>)
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">reload_nginx</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-identifier">app_name</span>)
  <span class="ruby-keyword">end</span></pre>
          </div><!-- write_app_config-source -->
          
        </div>

        

        
      </div><!-- write_app_config-method -->

    
      <div id="method-c-write_fullproxy_app_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_fullproxy_app_config</span><span
            class="method-args">(app_name, app_number, my_public_ip, my_private_ip, proxy_port, login_ip, appengine_server_ips)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a <a href="Nginx.html">Nginx</a> config file for the provided app
name on the load balancer</p>
          

          
          <div class="method-source-code" id="write_fullproxy_app_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/nginx.rb, line 141</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_fullproxy_app_config</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">my_public_ip</span>, 
    <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">proxy_port</span>, <span class="ruby-identifier">login_ip</span>, <span class="ruby-identifier">appengine_server_ips</span>)
    <span class="ruby-identifier">listen_port</span> = <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
    <span class="ruby-identifier">ssl_listen_port</span> = <span class="ruby-identifier">listen_port</span> <span class="ruby-operator">-</span> <span class="ruby-constant">SSL_PORT_OFFSET</span>
    <span class="ruby-identifier">blob_servers</span> = []
    <span class="ruby-identifier">servers</span> = []
    <span class="ruby-identifier">appengine_server_ips</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">servers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;server #{ip}:#{listen_port};&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">appengine_server_ips</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">blob_servers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;server #{ip}:#{BLOBSERVER_PORT};&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">servers</span> = <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
    <span class="ruby-identifier">config</span> = <span class="ruby-string">&quot;# Any requests that arent static files get sent to haproxy
upstream gae_#{app_name} {
    #{servers}
}
upstream gae_#{app_name}_blobstore {
    #{blob_servers}
}
server {
    listen #{listen_port};
    server_name #{my_public_ip}-#{app_name};
    #root /var/apps/#{app_name}/app;
    # Uncomment these lines to enable logging, and comment out the following two
    #access_log  /var/log/nginx/#{app_name}.access.log upstream;
    error_log  /var/log/nginx/#{app_name}.error.log;
    access_log off;
    #error_log /dev/null crit;

    rewrite_log off;
    error_page 404 = /404.html;
    set $cache_dir /var/apps/#{app_name}/cache;

    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://gae_#{app_name};
      client_max_body_size 2G;
      proxy_connect_timeout 60;
      client_body_timeout 60;
      proxy_read_timeout 60;
    }

    location /reserved-channel-appscale-path {
      proxy_buffering off;
      tcp_nodelay on;
      keepalive_timeout 55;
      proxy_pass http://#{login_ip}:#{CHANNELSERVER_PORT}/http-bind;
    }

}
server {
    listen #{BLOBSERVER_PORT};
    server_name #{my_public_ip}-#{app_name}-blobstore;
    #root /var/apps/#{app_name}/app;
    # Uncomment these lines to enable logging, and comment out the following two
    #access_log  /var/log/nginx/#{app_name}-blobstore.access.log upstream;
    error_log  /var/log/nginx/#{app_name}-blobstore.error.log;
    access_log off;
    #error_log /dev/null crit;

    rewrite_log off;
    error_page 404 = /404.html;

    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://gae_#{app_name}_blobstore;
      client_max_body_size 2G;
      proxy_connect_timeout 600;
      client_body_timeout 600;
      proxy_read_timeout 600;
    }
}    

server {
    listen #{ssl_listen_port};
    server_name #{my_public_ip}-#{app_name}-ssl;
    ssl on;
    ssl_certificate /etc/nginx/mycert.pem;
    ssl_certificate_key /etc/nginx/mykey.pem;

    #root /var/apps/#{app_name}/app;
    # Uncomment these lines to enable logging, and comment out the following two
    #access_log  /var/log/nginx/#{app_name}.access.log upstream;
    error_log  /var/log/nginx/#{app_name}.error.log;
    access_log off;
    #error_log /dev/null crit;

    rewrite_log off;
    error_page 404 = /404.html;
    set $cache_dir /var/apps/#{app_name}/cache;

    location / {
      proxy_set_header  X-Real-IP  $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://gae_#{app_name};
      client_max_body_size 2G;
      proxy_connect_timeout 60;
      client_body_timeout 60;
      proxy_read_timeout 60;
    }

    location /reserved-channel-appscale-path {
      proxy_buffering off;
      tcp_nodelay on;
      keepalive_timeout 55;
      proxy_pass http://#{login_ip}:#{CHANNELSERVER_PORT}/http-bind;
    }


}
&quot;</span>

    <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-node">&quot;#{app_name}.#{CONFIG_EXTENSION}&quot;</span>)
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">reload_nginx</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-identifier">app_name</span>)
  <span class="ruby-keyword">end</span></pre>
          </div><!-- write_fullproxy_app_config-source -->
          
        </div>

        

        
      </div><!-- write_fullproxy_app_config-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

