<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module RabbitMQ - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>AppController/lib/rabbitmq.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-erase_local_files">::erase_local_files</a>
    
    <li><a href="#method-c-start_master">::start_master</a>
    
    <li><a href="#method-c-start_slave">::start_slave</a>
    
    <li><a href="#method-c-stop">::stop</a>
    
    <li><a href="#method-c-write_cookie">::write_cookie</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./AppScaleException.html">AppScaleException</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./BlobServer.html">BlobServer</a>
  
    <li><a href="./Collectd.html">Collectd</a>
  
    <li><a href="./CronHelper.html">CronHelper</a>
  
    <li><a href="./Djinn.html">Djinn</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./DjinnServer.html">DjinnServer</a>
  
    <li><a href="./Ejabberd.html">Ejabberd</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GodInterface.html">GodInterface</a>
  
    <li><a href="./HAProxy.html">HAProxy</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./LoadBalancer.html">LoadBalancer</a>
  
    <li><a href="./Monitoring.html">Monitoring</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./Nginx.html">Nginx</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PbServer.html">PbServer</a>
  
    <li><a href="./RabbitMQ.html">RabbitMQ</a>
  
    <li><a href="./Repo.html">Repo</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module RabbitMQ</h1>

  <div id="description" class="description">
    
<p>To implement support for the Google App Engine Task Queue API, we use the
open source rabbitmq server. This lets users dispatch background tasks,
whose data are stored as items in rabbitmq. This module provides methods
that automatically configure and deploy rabbitmq as needed.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="COOKIE_FILE">COOKIE_FILE
        
        <dd class="description"><p>The path to the file that the shared secret should be written to.</p>
        
      
        <dt id="SERVER_PORT">SERVER_PORT
        
        <dd class="description"><p>The port that the <a href="RabbitMQ.html">RabbitMQ</a> server runs on, by
default.</p>
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-erase_local_files" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">erase_local_files</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Erases all the files that <a href="RabbitMQ.html">RabbitMQ</a> normally
writes to, which can be useful to ensure that we start up <a
href="RabbitMQ.html">RabbitMQ</a> without left-over state from previous
runs.</p>
          

          
          <div class="method-source-code" id="erase_local_files-source">
            <pre><span class="ruby-comment"># File AppController/lib/rabbitmq.rb, line 89</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">erase_local_files</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;rm -rf /var/log/rabbitmq/*&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;rm -rf /var/lib/rabbitmq/mnesia/*&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- erase_local_files-source -->
          
        </div>

        

        
      </div><!-- erase_local_files-method -->

    
      <div id="method-c-start_master" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_master</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts a service that we refer to as a “rabbitmq_master”, a <a
href="RabbitMQ.html">RabbitMQ</a> service that other nodes can rely on to
be running <a href="RabbitMQ.html">RabbitMQ</a>.</p>
          

          
          <div class="method-source-code" id="start_master-source">
            <pre><span class="ruby-comment"># File AppController/lib/rabbitmq.rb, line 26</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">start_master</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Starting RabbitMQ Master&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_cookie</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">erase_local_files</span>()
  <span class="ruby-identifier">start_cmd</span> = <span class="ruby-string">&quot;rabbitmq-server -detached -setcookie &quot;</span> <span class="ruby-operator">+</span>
   <span class="ruby-node">&quot;#{HelperFunctions.get_secret()}&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;#{start_cmd}&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_master-source -->
          
        </div>

        

        
      </div><!-- start_master-method -->

    
      <div id="method-c-start_slave" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_slave</span><span
            class="method-args">(master_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts a service that we refer to as a “rabbitmq slave”. Since all
nodes in <a href="RabbitMQ.html">RabbitMQ</a> are equal, this name isn’t
exactly fair, so what this role means here is “start a <a
href="RabbitMQ.html">RabbitMQ</a> server and connect it to the server on
the machine playing the ‘rabbitmq_master’ role.”</p>
          

          
          <div class="method-source-code" id="start_slave-source">
            <pre><span class="ruby-comment"># File AppController/lib/rabbitmq.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">start_slave</span>(<span class="ruby-identifier">master_ip</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Starting RabbitMQ Slave&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_cookie</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">erase_local_files</span>()
  
  <span class="ruby-comment"># Wait for RabbitMQ on master node to come up</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Waiting for RabbitMQ on master node to come up&quot;</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-identifier">master_ip</span>, <span class="ruby-constant">SERVER_PORT</span>)

  <span class="ruby-comment"># start the server, reset it to join the head node</span>
  <span class="ruby-comment"># TODO(cgb): This looks like this assumes that the head node is</span>
  <span class="ruby-comment"># appscale-image0 - true for default deployments but not necessarily</span>
  <span class="ruby-comment"># so in advanced placement scenarios. Change accordingly.</span>
  <span class="ruby-identifier">start_cmds</span> = [<span class="ruby-string">&quot;rabbitmqctl start_app&quot;</span>,
                <span class="ruby-string">&quot;rabbitmqctl stop_app&quot;</span>,
                <span class="ruby-string">&quot;rabbitmqctl reset&quot;</span>,
                <span class="ruby-node">&quot;rabbitmq-server -detached -setcookie #{HelperFunctions.get_secret()}&quot;</span>,
                <span class="ruby-string">&quot;rabbitmqctl cluster rabbit@appscale-image0&quot;</span>,
                <span class="ruby-string">&quot;rabbitmqctl start_app&quot;</span>]
  <span class="ruby-identifier">full_cmd</span> = <span class="ruby-node">&quot;#{start_cmds.join('; ')}&quot;</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;#{full_cmd}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Waiting for RabbitMQ on local node to come up&quot;</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-string">&quot;localhost&quot;</span>, <span class="ruby-constant">SERVER_PORT</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Done starting rabbitmq_slave on this node&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_slave-source -->
          
        </div>

        

        
      </div><!-- start_slave-method -->

    
      <div id="method-c-stop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Stops the <a href="RabbitMQ.html">RabbitMQ</a> server on this node.
TODO(cgb): It doesn’t actually do anything right now - find out what we
need to do to stop the server.</p>
          

          
          <div class="method-source-code" id="stop-source">
            <pre><span class="ruby-comment"># File AppController/lib/rabbitmq.rb, line 71</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">stop</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Shutting down RabbitMQ&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop-source -->
          
        </div>

        

        
      </div><!-- stop-method -->

    
      <div id="method-c-write_cookie" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_cookie</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Erlang processes use a secret value as a password to authenticate between
one another. Since this is pretty much the same thing we do in AppScale
with our secret key, use the same key here. TODO(cgb): Consider using a
different key, so that if one key is compromised it doesn’t compromise
the other.</p>
          

          
          <div class="method-source-code" id="write_cookie-source">
            <pre><span class="ruby-comment"># File AppController/lib/rabbitmq.rb, line 81</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_cookie</span>()
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-constant">COOKIE_FILE</span>, <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_secret</span>())
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_cookie-source -->
          
        </div>

        

        
      </div><!-- write_cookie-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

