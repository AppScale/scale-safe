<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module HelperFunctions - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>AppController/lib/helperfunctions.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-application_port">::application_port</a>
    
    <li><a href="#method-c-convert_fqdn_to_ip">::convert_fqdn_to_ip</a>
    
    <li><a href="#method-c-create_appscale_security_group">::create_appscale_security_group</a>
    
    <li><a href="#method-c-deserialize_info_from_tools">::deserialize_info_from_tools</a>
    
    <li><a href="#method-c-does_image_have_location-3F">::does_image_have_location?</a>
    
    <li><a href="#method-c-encrypt_password">::encrypt_password</a>
    
    <li><a href="#method-c-ensure_db_is_supported">::ensure_db_is_supported</a>
    
    <li><a href="#method-c-ensure_image_is_appscale">::ensure_image_is_appscale</a>
    
    <li><a href="#method-c-expires_duration">::expires_duration</a>
    
    <li><a href="#method-c-find_majority_item">::find_majority_item</a>
    
    <li><a href="#method-c-generate_location_config">::generate_location_config</a>
    
    <li><a href="#method-c-generate_makefile">::generate_makefile</a>
    
    <li><a href="#method-c-generate_ssh_key">::generate_ssh_key</a>
    
    <li><a href="#method-c-get_app_path">::get_app_path</a>
    
    <li><a href="#method-c-get_appscale_id">::get_appscale_id</a>
    
    <li><a href="#method-c-get_cache_path">::get_cache_path</a>
    
    <li><a href="#method-c-get_cert">::get_cert</a>
    
    <li><a href="#method-c-get_cloud_ips">::get_cloud_ips</a>
    
    <li><a href="#method-c-get_hybrid_ips">::get_hybrid_ips</a>
    
    <li><a href="#method-c-get_ips">::get_ips</a>
    
    <li><a href="#method-c-get_key">::get_key</a>
    
    <li><a href="#method-c-get_num_cpus">::get_num_cpus</a>
    
    <li><a href="#method-c-get_optimal_spot_price">::get_optimal_spot_price</a>
    
    <li><a href="#method-c-get_public_ips">::get_public_ips</a>
    
    <li><a href="#method-c-get_random_alphanumeric">::get_random_alphanumeric</a>
    
    <li><a href="#method-c-get_relative_filename">::get_relative_filename</a>
    
    <li><a href="#method-c-get_remote_appscale_home">::get_remote_appscale_home</a>
    
    <li><a href="#method-c-get_secret">::get_secret</a>
    
    <li><a href="#method-c-get_untar_dir">::get_untar_dir</a>
    
    <li><a href="#method-c-get_usage">::get_usage</a>
    
    <li><a href="#method-c-is_port_open-3F">::is_port_open?</a>
    
    <li><a href="#method-c-kill_process">::kill_process</a>
    
    <li><a href="#method-c-local_ip">::local_ip</a>
    
    <li><a href="#method-c-log_obscured_env">::log_obscured_env</a>
    
    <li><a href="#method-c-obscure_array">::obscure_array</a>
    
    <li><a href="#method-c-obscure_creds">::obscure_creds</a>
    
    <li><a href="#method-c-obscure_string">::obscure_string</a>
    
    <li><a href="#method-c-parse_static_data">::parse_static_data</a>
    
    <li><a href="#method-c-read_file">::read_file</a>
    
    <li><a href="#method-c-read_json_file">::read_json_file</a>
    
    <li><a href="#method-c-run_app">::run_app</a>
    
    <li><a href="#method-c-run_remote_command">::run_remote_command</a>
    
    <li><a href="#method-c-scp_file">::scp_file</a>
    
    <li><a href="#method-c-set_creds_in_env">::set_creds_in_env</a>
    
    <li><a href="#method-c-setup_app">::setup_app</a>
    
    <li><a href="#method-c-shell">::shell</a>
    
    <li><a href="#method-c-shorten_to_n_items">::shorten_to_n_items</a>
    
    <li><a href="#method-c-sleep_until_port_is_closed">::sleep_until_port_is_closed</a>
    
    <li><a href="#method-c-sleep_until_port_is_open">::sleep_until_port_is_open</a>
    
    <li><a href="#method-c-spawn_hybrid_vms">::spawn_hybrid_vms</a>
    
    <li><a href="#method-c-spawn_vms">::spawn_vms</a>
    
    <li><a href="#method-c-stop_app">::stop_app</a>
    
    <li><a href="#method-c-terminate_all_vms">::terminate_all_vms</a>
    
    <li><a href="#method-c-terminate_hybrid_vms">::terminate_hybrid_vms</a>
    
    <li><a href="#method-c-terminate_vms">::terminate_vms</a>
    
    <li><a href="#method-c-write_file">::write_file</a>
    
    <li><a href="#method-c-write_json_file">::write_json_file</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./AppScaleException.html">AppScaleException</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./BlobServer.html">BlobServer</a>
  
    <li><a href="./Collectd.html">Collectd</a>
  
    <li><a href="./CronHelper.html">CronHelper</a>
  
    <li><a href="./Djinn.html">Djinn</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./DjinnServer.html">DjinnServer</a>
  
    <li><a href="./Ejabberd.html">Ejabberd</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GodInterface.html">GodInterface</a>
  
    <li><a href="./HAProxy.html">HAProxy</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./LoadBalancer.html">LoadBalancer</a>
  
    <li><a href="./Monitoring.html">Monitoring</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./Nginx.html">Nginx</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PbServer.html">PbServer</a>
  
    <li><a href="./RabbitMQ.html">RabbitMQ</a>
  
    <li><a href="./Repo.html">Repo</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module HelperFunctions</h1>

  <div id="description" class="description">
    
<p><a href="HelperFunctions.html">HelperFunctions</a> holds miscellaneous
functions - functions that really aren’t bound to a particular service,
but are reused across multiple functions. TODO(cgb): Consider removing App
Engine-related functions below into its own helper class</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="APPSCALE_HOME">APPSCALE_HOME
        
        <dd class="description">
        
      
        <dt id="APP_START_PORT">APP_START_PORT
        
        <dd class="description"><p>The first port that should be used to host Google App Engine applications
that users have uploaded.</p>
        
      
        <dt id="CLOUDY_CREDS">CLOUDY_CREDS
        
        <dd class="description">
        
      
        <dt id="DEFAULT_SKIP_FILES_REGEX">DEFAULT_SKIP_FILES_REGEX
        
        <dd class="description">
        
      
        <dt id="DELTA_REGEX">DELTA_REGEX
        
        <dd class="description">
        
      
        <dt id="DONT_USE_SSL">DONT_USE_SSL
        
        <dd class="description"><p>A constant that indicates that SSL should not be used when checking if a
given port is open.</p>
        
      
        <dt id="FQDN_REGEX">FQDN_REGEX
        
        <dd class="description">
        
      
        <dt id="IP_OR_FQDN">IP_OR_FQDN
        
        <dd class="description">
        
      
        <dt id="IP_REGEX">IP_REGEX
        
        <dd class="description">
        
      
        <dt id="MAX_VM_CREATION_TIME">MAX_VM_CREATION_TIME
        
        <dd class="description"><p>The maximum amount of time, in seconds, that we are willing to wait for a
virtual machine to start up, from the initial run-instances request.
Setting this value is a bit of an art, but we choose the value below
because our image is roughly 10GB in size, and if Eucalyptus doesn’t have
the image cached, it could take half an hour to get our image started.</p>
        
      
        <dt id="SLEEP_TIME">SLEEP_TIME
        
        <dd class="description">
        
      
        <dt id="TIME_IN_SECONDS">TIME_IN_SECONDS
        
        <dd class="description">
        
      
        <dt id="USE_SSL">USE_SSL
        
        <dd class="description"><p>A constant that indicates that SSL should be used when checking if a given
port is open.</p>
        
      
        <dt id="VER_NUM">VER_NUM
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-application_port" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">application_port</span><span
            class="method-args">(app_number, index, num_of_servers)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Determine the port that the given app should use</p>
          

          
          <div class="method-source-code" id="application_port-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 898</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">application_port</span>(<span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">num_of_servers</span>)
  <span class="ruby-constant">APP_START_PORT</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">app_number</span> * <span class="ruby-identifier">num_of_servers</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">index</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- application_port-source -->
          
        </div>

        

        
      </div><!-- application_port-method -->

    
      <div id="method-c-convert_fqdn_to_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_fqdn_to_ip</span><span
            class="method-args">(host)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>In cloudy deployments, the recommended way to determine a machine’s true
private IP address from its private FQDN is to use dig. This method
attempts to resolve IPs in that method, deferring to other methods if that
fails.</p>
          

          
          <div class="method-source-code" id="convert_fqdn_to_ip-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 435</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">host</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">host</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">host</span> <span class="ruby-operator">=~</span> <span class="ruby-node">%r#{IP_REGEX}/</span>

  <span class="ruby-identifier">ip</span> = <span class="ruby-node">%xdig #{host} +short`</span>.<span class="ruby-identifier">chomp</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;couldn't use dig to resolve [#{host}]&quot;</span>)
    <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;Couldn't convert #{host} to an IP address. Result of dig was \n#{ip}&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ip</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- convert_fqdn_to_ip-source -->
          
        </div>

        

        
      </div><!-- convert_fqdn_to_ip-method -->

    
      <div id="method-c-create_appscale_security_group" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_appscale_security_group</span><span
            class="method-args">(infrastructure, group)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="create_appscale_security_group-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 783</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_appscale_security_group</span>(<span class="ruby-identifier">infrastructure</span>, <span class="ruby-identifier">group</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-add-group #{group} -d appscale 2&gt;&amp;1&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-authorize #{group} -p 1-65535 -P udp 2&gt;&amp;1&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-authorize #{group} -p 1-65535 -P tcp 2&gt;&amp;1&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-authorize #{group} -s 0.0.0.0/0 -P icmp -t -1:-1 2&gt;&amp;1&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_appscale_security_group-source -->
          
        </div>

        

        
      </div><!-- create_appscale_security_group-method -->

    
      <div id="method-c-deserialize_info_from_tools" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">deserialize_info_from_tools</span><span
            class="method-args">(ips)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="deserialize_info_from_tools-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 135</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">deserialize_info_from_tools</span>(<span class="ruby-identifier">ips</span>) 
  <span class="ruby-identifier">nodes</span> = {}
  <span class="ruby-comment"># FIXME: Here we make the string back into a hash using the crappy deserialization</span>
  <span class="ruby-comment"># Definitely change this to JSON at some point</span>
  <span class="ruby-identifier">ips</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;..&quot;</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tokens</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;--&quot;</span>)
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tokens</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-value">2</span>
    <span class="ruby-identifier">id</span>,<span class="ruby-identifier">roles</span> = <span class="ruby-identifier">tokens</span>
    <span class="ruby-identifier">nodes</span>[<span class="ruby-identifier">id</span>] = <span class="ruby-identifier">roles</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">nodes</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- deserialize_info_from_tools-source -->
          
        </div>

        

        
      </div><!-- deserialize_info_from_tools-method -->

    
      <div id="method-c-does_image_have_location-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">does_image_have_location?</span><span
            class="method-args">(ip, location, key)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="does_image_have_location-3F-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1078</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">does_image_have_location?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">location</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-identifier">ret_val</span> = <span class="ruby-node">%xssh -i #{key} -o NumberOfPasswordPrompts=0 -o StrictHostkeyChecking=no 2&gt;&amp;1 root@#{ip} 'ls #{location}'; echo $?`</span>.<span class="ruby-identifier">chomp</span>[<span class="ruby-value">-1</span>]
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ret_val</span>.<span class="ruby-identifier">chr</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- does_image_have_location-3F-source -->
          
        </div>

        

        
      </div><!-- does_image_have_location-3F-method -->

    
      <div id="method-c-encrypt_password" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">encrypt_password</span><span
            class="method-args">(user, pass)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="encrypt_password-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1044</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">encrypt_password</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">pass</span>)
  <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">SHA1</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">user</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">pass</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- encrypt_password-source -->
          
        </div>

        

        
      </div><!-- encrypt_password-method -->

    
      <div id="method-c-ensure_db_is_supported" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_db_is_supported</span><span
            class="method-args">(ip, db, key)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="ensure_db_is_supported-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1094</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ensure_db_is_supported</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">db</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">does_image_have_location?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-node">&quot;/etc/appscale/#{VER_NUM}/#{db}&quot;</span>, <span class="ruby-identifier">key</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Image at #{ip} supports #{db}.&quot;</span>)
  <span class="ruby-keyword">else</span> 
    <span class="ruby-identifier">fail_msg</span> = <span class="ruby-node">&quot;The image at #{ip} does not have support for #{db}.&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot; Please install support for this database and try again.&quot;</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">fail_msg</span>)
    <span class="ruby-identifier">abort</span>(<span class="ruby-identifier">fail_msg</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ensure_db_is_supported-source -->
          
        </div>

        

        
      </div><!-- ensure_db_is_supported-method -->

    
      <div id="method-c-ensure_image_is_appscale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_image_is_appscale</span><span
            class="method-args">(ip, key)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="ensure_image_is_appscale-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1083</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ensure_image_is_appscale</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">does_image_have_location?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-string">&quot;/etc/appscale&quot;</span>, <span class="ruby-identifier">key</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Image at #{ip} is an AppScale image.&quot;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">fail_msg</span> = <span class="ruby-node">&quot;The image at #{ip} is not an AppScale image.&quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot; Please install AppScale on it and try again.&quot;</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">fail_msg</span>)
    <span class="ruby-identifier">abort</span>(<span class="ruby-identifier">fail_msg</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ensure_image_is_appscale-source -->
          
        </div>

        

        
      </div><!-- ensure_image_is_appscale-method -->

    
      <div id="method-c-expires_duration" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">expires_duration</span><span
            class="method-args">(input_string)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Parses the expiration string provided in the app.yaml and returns its
duration in seconds</p>
          

          
          <div class="method-source-code" id="expires_duration-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1030</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expires_duration</span> <span class="ruby-identifier">input_string</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">input_string</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">input_string</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-comment"># Start with nil so we can distinguish between it not being set and 0</span>
  <span class="ruby-identifier">duration</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">input_string</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">token</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">match</span> = <span class="ruby-identifier">token</span>.<span class="ruby-identifier">match</span>(<span class="ruby-constant">DELTA_REGEX</span>)
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">match</span>
    <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">units</span> = <span class="ruby-identifier">match</span>.<span class="ruby-identifier">captures</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">amount</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">units</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">duration</span> = (<span class="ruby-identifier">duration</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>) <span class="ruby-operator">+</span> <span class="ruby-constant">TIME_IN_SECONDS</span>[<span class="ruby-identifier">units</span>.<span class="ruby-identifier">downcase</span>]*<span class="ruby-identifier">amount</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">duration</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- expires_duration-source -->
          
        </div>

        

        
      </div><!-- expires_duration-method -->

    
      <div id="method-c-find_majority_item" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_majority_item</span><span
            class="method-args">(array)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="find_majority_item-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1166</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_majority_item</span>(<span class="ruby-identifier">array</span>)
  <span class="ruby-identifier">count</span> = {}
  <span class="ruby-identifier">array</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">count</span>[<span class="ruby-identifier">item</span>] = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">count</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">count</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  }

  <span class="ruby-identifier">max_k</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">max_v</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">count</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max_v</span>
      <span class="ruby-identifier">max_k</span> = <span class="ruby-identifier">k</span>
      <span class="ruby-identifier">max_v</span> = <span class="ruby-identifier">v</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">max_k</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_majority_item-source -->
          
        </div>

        

        
      </div><!-- find_majority_item-method -->

    
      <div id="method-c-generate_location_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_location_config</span><span
            class="method-args">(handler)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="generate_location_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 902</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">generate_location_config</span> <span class="ruby-identifier">handler</span>
  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">handler</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-string">&quot;static_dir&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">handler</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-string">&quot;static_files&quot;</span>)

  <span class="ruby-identifier">result</span> = <span class="ruby-node">&quot;\n    location #{handler['url']} {&quot;</span>
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n\t&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;root $cache_dir;&quot;</span>
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n\t&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;expires #{handler['expiration']};&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">handler</span>[<span class="ruby-string">'expiration'</span>]

  <span class="ruby-comment"># TODO: return a 404 page if rewritten path doesn not exist</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-string">&quot;static_dir&quot;</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n\t&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;rewrite #{handler['url']}(.*) /#{handler['static_dir']}/$1 break;&quot;</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-string">&quot;static_files&quot;</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n\t&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;rewrite #{handler['url']} /#{handler['static_files']} break;&quot;</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;    }&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n&quot;</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- generate_location_config-source -->
          
        </div>

        

        
      </div><!-- generate_location_config-method -->

    
      <div id="method-c-generate_makefile" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_makefile</span><span
            class="method-args">(code, input_loc)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="generate_makefile-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1105</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">generate_makefile</span>(<span class="ruby-identifier">code</span>, <span class="ruby-identifier">input_loc</span>)
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;code is nil&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">code</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">makefile</span> = <span class="ruby-string">&quot;all:\n\t&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%r\.x10\Z/</span>
    <span class="ruby-identifier">out</span> = <span class="ruby-identifier">code</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r\A(.*)\.x10\Z/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">makefile</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;/usr/local/x10/x10.dist/bin/x10c++ -x10rt mpi -o #{out} #{code}\n\n&quot;</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%r\.erl\Z/</span>
    <span class="ruby-identifier">makefile</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;HOME=/root erlc #{code}&quot;</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%r\.c\Z/</span>
    <span class="ruby-identifier">out</span> = <span class="ruby-identifier">code</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r\A(.*)\.c\Z/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>

    <span class="ruby-identifier">code_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">input_loc</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">code</span>)
    <span class="ruby-identifier">contents</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-identifier">code_path</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">contents</span> <span class="ruby-operator">=~</span> <span class="ruby-node">%r#include .mpi\.h./</span>
      <span class="ruby-identifier">makefile</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;mpicc #{code} -o #{out} -Wall&quot;</span>

    <span class="ruby-comment"># for upc, there's upc_relaxed, upc_strict, and upc</span>
    <span class="ruby-comment"># this should catch them all - just like pokemon</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">contents</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-node">&quot;#include &lt;upc&quot;</span>)
      <span class="ruby-identifier">makefile</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;/usr/local/berkeley_upc-2.12.1/upcc --network=mpi -o #{out} #{code}&quot;</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># its plain old c</span>
      <span class="ruby-identifier">makefile</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;gcc -o #{out} #{code} -Wall&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%r\.go\Z/</span>
      <span class="ruby-identifier">prefix</span> = <span class="ruby-identifier">code</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r\A(.*)\.go\Z/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
      <span class="ruby-identifier">link</span> = <span class="ruby-node">&quot;#{prefix}.6&quot;</span>
      <span class="ruby-identifier">makefile</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;GOROOT=#{GOROOT} #{GOBIN}/6g #{code} &amp;&amp; GOROOT=#{GOROOT} #{GOBIN}/6l -o #{prefix} #{link}&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;code type not supported for auto-gen makefile&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">makefile_location</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">input_loc</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/Makefile&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">makefile_location</span>, <span class="ruby-identifier">makefile</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- generate_makefile-source -->
          
        </div>

        

        
      </div><!-- generate_makefile-method -->

    
      <div id="method-c-generate_ssh_key" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_ssh_key</span><span
            class="method-args">(outputLocation, name, infrastructure)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="generate_ssh_key-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 753</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">generate_ssh_key</span>(<span class="ruby-identifier">outputLocation</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">infrastructure</span>)
  <span class="ruby-identifier">ec2_output</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">ec2_output</span> = <span class="ruby-node">%x#{infrastructure}-add-keypair #{name} 2&gt;&amp;1`</span>
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ec2_output</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;BEGIN RSA PRIVATE KEY&quot;</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Trying again. Saw this from #{infrastructure}-add-keypair: #{ec2_output}&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-delete-keypair #{name} 2&gt;&amp;1&quot;</span>)
  }

  <span class="ruby-comment"># output is the ssh private key prepended with info we don't need</span>
  <span class="ruby-comment"># delimited by the first \n, so rip it off first to get just the key</span>

  <span class="ruby-comment">#first_newline = ec2_output.index(&quot;\n&quot;)</span>
  <span class="ruby-comment">#ssh_private_key = ec2_output[first_newline+1, ec2_output.length-1]</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">outputLocation</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>
    <span class="ruby-identifier">outputLocation</span> = [<span class="ruby-identifier">outputLocation</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">outputLocation</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">fullPath</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">path</span>)
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">fullPath</span>, <span class="ruby-string">&quot;w&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">file</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">ec2_output</span>)
    }
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0600</span>, <span class="ruby-identifier">fullPath</span>) <span class="ruby-comment"># else ssh won't use the key</span>
  }

  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- generate_ssh_key-source -->
          
        </div>

        

        
      </div><!-- generate_ssh_key-method -->

    
      <div id="method-c-get_app_path" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_app_path</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_app_path-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 921</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_app_path</span> <span class="ruby-identifier">app_name</span>
  <span class="ruby-node">&quot;/var/apps/#{app_name}/&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_app_path-source -->
          
        </div>

        

        
      </div><!-- get_app_path-method -->

    
      <div id="method-c-get_appscale_id" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_appscale_id</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_appscale_id-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 278</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_appscale_id</span>
  <span class="ruby-comment"># This needs to be ec2 or euca 2ools.</span>
  <span class="ruby-identifier">image_info</span> = <span class="ruby-value">%xec2-describe-images`</span>
  
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;ec2 tools can't find appscale image&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">image_info</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;appscale&quot;</span>)
  <span class="ruby-identifier">image_id</span> = <span class="ruby-identifier">image_info</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r([a|e]mi-[0-9a-zA-Z]+)\sappscale/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">image_id</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_appscale_id-source -->
          
        </div>

        

        
      </div><!-- get_appscale_id-method -->

    
      <div id="method-c-get_cache_path" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_cache_path</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_cache_path-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 925</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_cache_path</span> <span class="ruby-identifier">app_name</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">get_app_path</span>(<span class="ruby-identifier">app_name</span>),<span class="ruby-string">&quot;cache&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_cache_path-source -->
          
        </div>

        

        
      </div><!-- get_cache_path-method -->

    
      <div id="method-c-get_cert" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_cert</span><span
            class="method-args">(filename)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_cert-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 288</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_cert</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">X509</span><span class="ruby-operator">::</span><span class="ruby-constant">Certificate</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">filename</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>
  })
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_cert-source -->
          
        </div>

        

        
      </div><!-- get_cert-method -->

    
      <div id="method-c-get_cloud_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_cloud_ips</span><span
            class="method-args">(infrastructure, keyname)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_cloud_ips-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 856</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_cloud_ips</span>(<span class="ruby-identifier">infrastructure</span>, <span class="ruby-identifier">keyname</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_obscured_env</span>

  <span class="ruby-identifier">describe_instances</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">describe_instances</span> = <span class="ruby-node">%x#{infrastructure}-describe-instances 2&gt;&amp;1`</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;[oi!] #{describe_instances}&quot;</span>)
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">describe_instances</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rMessage replay detected./</span>
    <span class="ruby-identifier">sleep</span>(<span class="ruby-value">10</span>)
  }

  <span class="ruby-identifier">running_machine_regex</span> = <span class="ruby-node">%r\s+(#{IP_OR_FQDN})\s+(#{IP_OR_FQDN})\s+running\s+#{keyname}\s/</span>
  <span class="ruby-identifier">all_ip_addrs</span> = <span class="ruby-identifier">describe_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-identifier">running_machine_regex</span>).<span class="ruby-identifier">flatten</span>
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;[oi!] all ips are [#{all_ip_addrs.join(', ')}]&quot;</span>)
  <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_ips</span>(<span class="ruby-identifier">all_ip_addrs</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_cloud_ips-source -->
          
        </div>

        

        
      </div><!-- get_cloud_ips-method -->

    
      <div id="method-c-get_hybrid_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_hybrid_ips</span><span
            class="method-args">(creds)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_hybrid_ips-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 828</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_hybrid_ips</span>(<span class="ruby-identifier">creds</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;creds are #{self.obscure_creds(creds).inspect}&quot;</span>)

  <span class="ruby-identifier">public_ips</span> = []
  <span class="ruby-identifier">private_ips</span> = []

  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]

  <span class="ruby-identifier">cloud_num</span> = <span class="ruby-value">1</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;CLOUD#{cloud_num}_TYPE&quot;</span>
    <span class="ruby-identifier">cloud_type</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-identifier">key</span>]
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cloud_type</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_creds_in_env</span>(<span class="ruby-identifier">creds</span>, <span class="ruby-identifier">cloud_num</span>)

    <span class="ruby-identifier">this_pub</span>, <span class="ruby-identifier">this_priv</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_cloud_ips</span>(<span class="ruby-identifier">cloud_type</span>, <span class="ruby-identifier">keyname</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;CLOUD#{cloud_num} reports public ips [#{this_pub.join(', ')}] and private ips [#{this_priv.join(', ')}]&quot;</span>)
    <span class="ruby-identifier">public_ips</span> = <span class="ruby-identifier">public_ips</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">this_pub</span>
    <span class="ruby-identifier">private_ips</span> = <span class="ruby-identifier">private_ips</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">this_priv</span>

    <span class="ruby-identifier">cloud_num</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  }

  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;all public ips are [#{public_ips.join(', ')}] and private ips [#{private_ips.join(', ')}]&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_hybrid_ips-source -->
          
        </div>

        

        
      </div><!-- get_hybrid_ips-method -->

    
      <div id="method-c-get_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_ips</span><span
            class="method-args">(ips)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_ips-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 447</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_ips</span>(<span class="ruby-identifier">ips</span>)
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;ips not even length array&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ips</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">%</span> <span class="ruby-value">2</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">reported_public</span> = []
  <span class="ruby-identifier">reported_private</span> = []
  <span class="ruby-identifier">ips</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">%</span> <span class="ruby-value">2</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">reported_public</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ips</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">reported_private</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ips</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">end</span>
  }
  
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Reported Public IPs: [#{reported_public.join(', ')}]&quot;</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Reported Private IPs: [#{reported_private.join(', ')}]&quot;</span>)

  <span class="ruby-identifier">actual_public</span> = []
  <span class="ruby-identifier">actual_private</span> = []
  
  <span class="ruby-identifier">reported_public</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">pub</span> = <span class="ruby-identifier">reported_public</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-identifier">pri</span> = <span class="ruby-identifier">reported_private</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pub</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;0.0.0.0&quot;</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">pri</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;0.0.0.0&quot;</span>
      <span class="ruby-identifier">actual_public</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pub</span>
      <span class="ruby-identifier">actual_private</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pri</span>
    <span class="ruby-keyword">end</span>
  }
      
  <span class="ruby-comment">#actual_public.each_index { |index|</span>
  <span class="ruby-comment">#  actual_public[index] = HelperFunctions.convert_fqdn_to_ip(actual_public[index])</span>
  <span class="ruby-comment">#}</span>

  <span class="ruby-identifier">actual_private</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">actual_private</span>[<span class="ruby-identifier">index</span>] = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">actual_private</span>[<span class="ruby-identifier">index</span>])
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span>
      <span class="ruby-comment"># this can happen if the private ip doesn't resolve</span>
      <span class="ruby-comment"># which can happen in hybrid environments: euca boxes wont be </span>
      <span class="ruby-comment"># able to resolve ec2 private ips, and vice-versa in euca-managed-mode</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;rescued! failed to convert #{actual_private[index]} to public&quot;</span>)
      <span class="ruby-identifier">actual_private</span>[<span class="ruby-identifier">index</span>] = <span class="ruby-identifier">actual_public</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">end</span>
  }
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">actual_public</span>, <span class="ruby-identifier">actual_private</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_ips-source -->
          
        </div>

        

        
      </div><!-- get_ips-method -->

    
      <div id="method-c-get_key" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_key</span><span
            class="method-args">(filename)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_key-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 295</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_key</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">PKey</span><span class="ruby-operator">::</span><span class="ruby-constant">RSA</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">filename</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>
  })
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_key-source -->
          
        </div>

        

        
      </div><!-- get_key-method -->

    
      <div id="method-c-get_num_cpus" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_num_cpus</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_num_cpus-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1153</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_num_cpus</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Integer</span>(<span class="ruby-value">%xcat /proc/cpuinfo | grep 'processor' | wc -l`</span>.<span class="ruby-identifier">chomp</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_num_cpus-source -->
          
        </div>

        

        
      </div><!-- get_num_cpus-method -->

    
      <div id="method-c-get_optimal_spot_price" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_optimal_spot_price</span><span
            class="method-args">(instance_type)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Queries Amazon EC2’s Spot Instance pricing history to see how much other
users have paid for the given instance type (assumed to be a Linux box), so
that we can place a bid that is similar to the average price. How similar
to the average price to pay is a bit of an open problem - for now, we pay
20% more so that in case the market price goes up a little bit, we still
get to keep our instances.</p>
          

          
          <div class="method-source-code" id="get_optimal_spot_price-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 527</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_optimal_spot_price</span>(<span class="ruby-identifier">instance_type</span>)
  <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;ec2-describe-spot-price-history -t #{instance_type} | &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot;grep 'Linux/UNIX' | awk '{print $2}'&quot;</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;\n&quot;</span>)
  <span class="ruby-identifier">prices</span> = <span class="ruby-node">%x#{command}`</span>

  <span class="ruby-identifier">average</span> = <span class="ruby-identifier">prices</span>.<span class="ruby-identifier">reduce</span>(<span class="ruby-value">0.0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">price</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sum</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Float</span>(<span class="ruby-identifier">price</span>)
  }
  
  <span class="ruby-identifier">average</span> <span class="ruby-operator">/=</span> <span class="ruby-identifier">prices</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">plus_twenty</span> = <span class="ruby-identifier">average</span> * <span class="ruby-value">1.20</span>
  
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;The average spot instance price for a #{instance_type} &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;machine is $#{average}, and 20% more is $#{plus_twenty}&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">plus_twenty</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_optimal_spot_price-source -->
          
        </div>

        

        
      </div><!-- get_optimal_spot_price-method -->

    
      <div id="method-c-get_public_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_public_ips</span><span
            class="method-args">(ips)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_public_ips-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 493</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_public_ips</span>(<span class="ruby-identifier">ips</span>)
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;ips not even length array&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ips</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">%</span> <span class="ruby-value">2</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">reported_public</span> = []
  <span class="ruby-identifier">reported_private</span> = []
  <span class="ruby-identifier">ips</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">%</span> <span class="ruby-value">2</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">reported_public</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ips</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">reported_private</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ips</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">end</span>
  }
  
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Reported Public IPs: [#{reported_public.join(', ')}]&quot;</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Reported Private IPs: [#{reported_private.join(', ')}]&quot;</span>)
  
  <span class="ruby-identifier">public_ips</span> = []
  <span class="ruby-identifier">reported_public</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">reported_public</span>[<span class="ruby-identifier">index</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;0.0.0.0&quot;</span>
      <span class="ruby-identifier">public_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">reported_public</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">reported_private</span>[<span class="ruby-identifier">index</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;0.0.0.0&quot;</span>
      <span class="ruby-identifier">public_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">reported_private</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">end</span>
  }
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">flatten</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_public_ips-source -->
          
        </div>

        

        
      </div><!-- get_public_ips-method -->

    
      <div id="method-c-get_random_alphanumeric" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_random_alphanumeric</span><span
            class="method-args">(length=10)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns a random string composed of alphanumeric characters, as long as the
user requests.</p>
          

          
          <div class="method-source-code" id="get_random_alphanumeric-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 122</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_random_alphanumeric</span>(<span class="ruby-identifier">length</span>=<span class="ruby-value">10</span>)
  <span class="ruby-identifier">random</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">possible</span> = <span class="ruby-string">&quot;0123456789abcdefghijklmnopqrstuvxwyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
  <span class="ruby-identifier">possibleLength</span> = <span class="ruby-identifier">possible</span>.<span class="ruby-identifier">length</span>
   
  <span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">random</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">possible</span>[<span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">possibleLength</span>)]
  }
   
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">random</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_random_alphanumeric-source -->
          
        </div>

        

        
      </div><!-- get_random_alphanumeric-method -->

    
      <div id="method-c-get_relative_filename" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_relative_filename</span><span
            class="method-args">(filename, app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>We have the files full path (e.g. ./data/myappname/static/file.txt) but we
want is the files path relative to the apps directory (e.g.
/static/file.txt). This is the hacky way of getting that.</p>
          

          
          <div class="method-source-code" id="get_relative_filename-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 937</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_relative_filename</span> <span class="ruby-identifier">filename</span>, <span class="ruby-identifier">app_name</span>
  <span class="ruby-identifier">filename</span>[<span class="ruby-identifier">get_untar_dir</span>(<span class="ruby-identifier">app_name</span>).<span class="ruby-identifier">length</span><span class="ruby-operator">..</span><span class="ruby-identifier">filename</span>.<span class="ruby-identifier">length</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_relative_filename-source -->
          
        </div>

        

        
      </div><!-- get_relative_filename-method -->

    
      <div id="method-c-get_remote_appscale_home" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_remote_appscale_home</span><span
            class="method-args">(ip, key)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_remote_appscale_home-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 267</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_remote_appscale_home</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-identifier">cat</span> = <span class="ruby-string">&quot;cat /etc/appscale/home&quot;</span>
  <span class="ruby-identifier">remote_cmd</span> = <span class="ruby-node">&quot;ssh -i #{key} -o NumberOfPasswordPrompts=0 -o StrictHostkeyChecking=no 2&gt;&amp;1 root@#{ip} '#{cat}'&quot;</span>
  <span class="ruby-identifier">possible_home</span> = <span class="ruby-node">%x#{remote_cmd}`</span>.<span class="ruby-identifier">chomp</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">possible_home</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">possible_home</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;/root/appscale/&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">possible_home</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_remote_appscale_home-source -->
          
        </div>

        

        
      </div><!-- get_remote_appscale_home-method -->

    
      <div id="method-c-get_secret" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_secret</span><span
            class="method-args">(filename="/etc/appscale/secret.key")</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_secret-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 302</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_secret</span>(<span class="ruby-identifier">filename</span>=<span class="ruby-string">&quot;/etc/appscale/secret.key&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">filename</span>), <span class="ruby-identifier">chomp</span>=<span class="ruby-keyword">true</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_secret-source -->
          
        </div>

        

        
      </div><!-- get_secret-method -->

    
      <div id="method-c-get_untar_dir" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_untar_dir</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The directory where the applications tarball will be extracted to</p>
          

          
          <div class="method-source-code" id="get_untar_dir-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 930</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_untar_dir</span> <span class="ruby-identifier">app_name</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">get_app_path</span>(<span class="ruby-identifier">app_name</span>),<span class="ruby-string">&quot;app&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_untar_dir-source -->
          
        </div>

        

        
      </div><!-- get_untar_dir-method -->

    
      <div id="method-c-get_usage" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_usage</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_usage-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 874</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_usage</span>
  <span class="ruby-identifier">top_results</span> = <span class="ruby-value">%xtop -n1 -d0 -b`</span>
  <span class="ruby-identifier">usage</span> = {}
  <span class="ruby-identifier">usage</span>[<span class="ruby-string">'cpu'</span>] = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">usage</span>[<span class="ruby-string">'mem'</span>] = <span class="ruby-keyword">nil</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">top_results</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rCpu\(s\):\s+([\d|\.]+)%us,\s+([\d|\.]+)%sy/</span>
    <span class="ruby-identifier">user_cpu</span> = <span class="ruby-constant">Float</span>(<span class="ruby-node">$1</span>)
    <span class="ruby-identifier">sys_cpu</span> = <span class="ruby-constant">Float</span>(<span class="ruby-node">$2</span>)
    <span class="ruby-identifier">usage</span>[<span class="ruby-string">'cpu'</span>] = <span class="ruby-identifier">user_cpu</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sys_cpu</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">top_results</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rMem:\s+(\d+)k total,\s+(\d+)k used/</span>
    <span class="ruby-identifier">total_memory</span> = <span class="ruby-constant">Float</span>(<span class="ruby-node">$1</span>)
    <span class="ruby-identifier">used_memory</span> = <span class="ruby-constant">Float</span>(<span class="ruby-node">$2</span>)
    <span class="ruby-identifier">usage</span>[<span class="ruby-string">'mem'</span>] = <span class="ruby-identifier">used_memory</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">total_memory</span> * <span class="ruby-value">100</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">usage</span>[<span class="ruby-string">'disk'</span>] = <span class="ruby-constant">Integer</span>(<span class="ruby-value">%xdf /`</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r(\d+)%/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>)
  
  <span class="ruby-identifier">usage</span>    
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_usage-source -->
          
        </div>

        

        
      </div><!-- get_usage-method -->

    
      <div id="method-c-is_port_open-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_port_open?</span><span
            class="method-args">(ip, port, use_ssl=DONT_USE_SSL)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_port_open-3F-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 186</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">use_ssl</span>=<span class="ruby-constant">DONT_USE_SSL</span>)
  <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>(<span class="ruby-value">1</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">sock</span> = <span class="ruby-constant">TCPSocket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_ssl</span>
          <span class="ruby-identifier">ssl_context</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSLContext</span>.<span class="ruby-identifier">new</span>() 
          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ssl_context</span>.<span class="ruby-identifier">verify_mode</span> 
            <span class="ruby-identifier">ssl_context</span>.<span class="ruby-identifier">verify_mode</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">VERIFY_NONE</span> 
          <span class="ruby-keyword">end</span> 
          <span class="ruby-identifier">sslsocket</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSLSocket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">sock</span>, <span class="ruby-identifier">ssl_context</span>) 
          <span class="ruby-identifier">sslsocket</span>.<span class="ruby-identifier">sync_close</span> = <span class="ruby-keyword">true</span> 
          <span class="ruby-identifier">sslsocket</span>.<span class="ruby-identifier">connect</span>          
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">close</span>
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EHOSTUNREACH</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_port_open-3F-source -->
          
        </div>

        

        
      </div><!-- is_port_open-3F-method -->

    
      <div id="method-c-kill_process" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">kill_process</span><span
            class="method-args">(name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="kill_process-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 149</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">kill_process</span>(<span class="ruby-identifier">name</span>)
  <span class="ruby-node">%xps ax | grep #{name} | grep -v grep | awk '{ print $1 }' | xargs -d '\n' kill -9`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- kill_process-source -->
          
        </div>

        

        
      </div><!-- kill_process-method -->

    
      <div id="method-c-local_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">local_ip</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="local_ip-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 413</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">local_ip</span>()
  <span class="ruby-identifier">ifconfig</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-string">&quot;ifconfig&quot;</span>)
  <span class="ruby-identifier">bound_addrs</span> = <span class="ruby-identifier">ifconfig</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rinet addr:(\d+.\d+.\d+.\d+)/</span>).<span class="ruby-identifier">flatten</span>

  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;ifconfig reports bound IP addresses as &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;[#{bound_addrs.join(', ')}]&quot;</span>)
  <span class="ruby-identifier">bound_addrs</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">addr</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">addr</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;127.0.0.1&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Returning #{addr} as our local IP address&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">addr</span>
  }

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Couldn't get our local IP address&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- local_ip-source -->
          
        </div>

        

        
      </div><!-- local_ip-method -->

    
      <div id="method-c-log_obscured_env" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">log_obscured_env</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="log_obscured_env-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1141</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_obscured_env</span>()
  <span class="ruby-identifier">env</span> = <span class="ruby-value">%xenv`</span>

  [<span class="ruby-string">&quot;EC2_ACCESS_KEY&quot;</span>, <span class="ruby-string">&quot;EC2_SECRET_KEY&quot;</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">cred</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">env</span> <span class="ruby-operator">=~</span> <span class="ruby-node">%r#{cred}=(.*)/</span>
      <span class="ruby-identifier">env</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-node">%r#{cred}=(.*)/</span>, <span class="ruby-node">&quot;#{cred}=#{self.obscure_string($1)}&quot;</span>)
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">env</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- log_obscured_env-source -->
          
        </div>

        

        
      </div><!-- log_obscured_env-method -->

    
      <div id="method-c-obscure_array" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">obscure_array</span><span
            class="method-args">(array)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="obscure_array-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1055</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscure_array</span>(<span class="ruby-identifier">array</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">array</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> 
    <span class="ruby-keyword">if</span> <span class="ruby-constant">CLOUDY_CREDS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">s</span>)
      <span class="ruby-identifier">obscure_string</span>(<span class="ruby-identifier">string</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">string</span>
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- obscure_array-source -->
          
        </div>

        

        
      </div><!-- obscure_array-method -->

    
      <div id="method-c-obscure_creds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">obscure_creds</span><span
            class="method-args">(creds)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="obscure_creds-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1065</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscure_creds</span>(<span class="ruby-identifier">creds</span>)
  <span class="ruby-identifier">obscured</span> = {}
  <span class="ruby-identifier">creds</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">CLOUDY_CREDS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">k</span>)
      <span class="ruby-identifier">obscured</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscure_string</span>(<span class="ruby-identifier">v</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">obscured</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">obscured</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- obscure_creds-source -->
          
        </div>

        

        
      </div><!-- obscure_creds-method -->

    
      <div id="method-c-obscure_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">obscure_string</span><span
            class="method-args">(string)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="obscure_string-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1048</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscure_string</span>(<span class="ruby-identifier">string</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">string</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">string</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">string</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
  <span class="ruby-identifier">last_four</span> = <span class="ruby-identifier">string</span>[<span class="ruby-identifier">string</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">-</span><span class="ruby-value">4</span>, <span class="ruby-identifier">string</span>.<span class="ruby-identifier">length</span>]
  <span class="ruby-identifier">obscured</span> = <span class="ruby-string">&quot;*&quot;</span> * (<span class="ruby-identifier">string</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">-</span><span class="ruby-value">4</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">obscured</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">last_four</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- obscure_string-source -->
          
        </div>

        

        
      </div><!-- obscure_string-method -->

    
      <div id="method-c-parse_static_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parse_static_data</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="parse_static_data-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 941</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parse_static_data</span> <span class="ruby-identifier">app_name</span>
  <span class="ruby-identifier">untar_dir</span> = <span class="ruby-identifier">get_untar_dir</span>(<span class="ruby-identifier">app_name</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">tree</span> = <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load_file</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">untar_dir</span>,<span class="ruby-string">&quot;app.yaml&quot;</span>))
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;Failed to load YAML file to parse static data&quot;</span>)
    <span class="ruby-keyword">return</span> []
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">handlers</span> = <span class="ruby-identifier">tree</span>[<span class="ruby-string">&quot;handlers&quot;</span>]
  <span class="ruby-identifier">default_expiration</span> = <span class="ruby-identifier">expires_duration</span>(<span class="ruby-identifier">tree</span>[<span class="ruby-string">&quot;default_expiration&quot;</span>])
  
  <span class="ruby-comment"># Create the destination cache directory</span>
  <span class="ruby-identifier">cache_path</span> = <span class="ruby-identifier">get_cache_path</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-identifier">cache_path</span>

  <span class="ruby-identifier">skip_files_regex</span> = <span class="ruby-constant">DEFAULT_SKIP_FILES_REGEX</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">tree</span>[<span class="ruby-string">&quot;skip_files&quot;</span>]
    <span class="ruby-comment"># An alternate regex has been provided for the files which should be skipped</span>
    <span class="ruby-identifier">input_regex</span> = <span class="ruby-identifier">tree</span>[<span class="ruby-string">&quot;skip_files&quot;</span>]
    <span class="ruby-identifier">input_regex</span> = <span class="ruby-identifier">input_regex</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;|&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">input_regex</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">Array</span>)

    <span class="ruby-comment"># Remove any superfluous spaces since they will break the regex</span>
    <span class="ruby-identifier">input_regex</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">%r /</span>,<span class="ruby-string">&quot;&quot;</span>)
    <span class="ruby-identifier">skip_files_regex</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">input_regex</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">handlers</span>.<span class="ruby-identifier">map!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">handler</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">handler</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-string">&quot;static_dir&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">handler</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-string">&quot;static_files&quot;</span>)
    
    <span class="ruby-comment"># TODO: Get the mime-type setting from app.yaml and add it to the nginx config</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;static_dir&quot;</span>]
      <span class="ruby-comment"># This is for bug https://bugs.launchpad.net/appscale/+bug/800539</span>
      <span class="ruby-comment"># this is a temp fix</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;url&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;/&quot;</span>
        <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Remapped path from / to temp_fix for application #{app_name}&quot;</span>)
        <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;url&quot;</span>] = <span class="ruby-string">&quot;/temp_fix&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">cache_static_dir_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">cache_path</span>,<span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;static_dir&quot;</span>])
      <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-identifier">cache_static_dir_path</span>

      <span class="ruby-identifier">filenames</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">untar_dir</span>, <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;static_dir&quot;</span>],<span class="ruby-string">&quot;*&quot;</span>))

      <span class="ruby-comment"># Remove all files which match the skip file regex so they do not get copied</span>
      <span class="ruby-identifier">filenames</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">f</span>).<span class="ruby-identifier">match</span>(<span class="ruby-identifier">skip_files_regex</span>) }

      <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp_r</span> <span class="ruby-identifier">filenames</span>, <span class="ruby-identifier">cache_static_dir_path</span>

      <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;expiration&quot;</span>] = <span class="ruby-identifier">expires_duration</span>(<span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;expiration&quot;</span>]) <span class="ruby-operator">||</span> <span class="ruby-identifier">default_expiration</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;static_files&quot;</span>]
      <span class="ruby-comment"># This is for bug https://bugs.launchpad.net/appscale/+bug/800539</span>
      <span class="ruby-comment"># this is a temp fix</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;url&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;/&quot;</span>
        <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Remapped path from / to temp_fix for application #{app_name}&quot;</span>)
        <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;url&quot;</span>] = <span class="ruby-string">&quot;/temp_fix&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># Need to convert all \1 into $1 so that nginx understands it</span>
      <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;static_files&quot;</span>] = <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;static_files&quot;</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\\/</span>,<span class="ruby-string">&quot;$&quot;</span>)

      <span class="ruby-identifier">upload_regex</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;upload&quot;</span>])

      <span class="ruby-identifier">filenames</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">untar_dir</span>,<span class="ruby-string">&quot;**&quot;</span>,<span class="ruby-string">&quot;*&quot;</span>))

      <span class="ruby-identifier">filenames</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filename</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">relative_filename</span> = <span class="ruby-identifier">get_relative_filename</span>(<span class="ruby-identifier">filename</span>,<span class="ruby-identifier">app_name</span>)

        <span class="ruby-comment"># Only include files that match the provided upload regular expression</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">relative_filename</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">upload_regex</span>)

        <span class="ruby-comment"># Skip all files which match the skip file regex so they do not get copied</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">relative_filename</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">skip_files_regex</span>)

        <span class="ruby-identifier">file_cache_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">cache_path</span>, <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">relative_filename</span>))
        <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-identifier">file_cache_path</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">file_cache_path</span>)
        
        <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp_r</span> <span class="ruby-identifier">filename</span>, <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">file_cache_path</span>,<span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">filename</span>))
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;expiration&quot;</span>] = <span class="ruby-identifier">expires_duration</span>(<span class="ruby-identifier">handler</span>[<span class="ruby-string">&quot;expiration&quot;</span>]) <span class="ruby-operator">||</span> <span class="ruby-identifier">default_expiration</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">handler</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">handlers</span>.<span class="ruby-identifier">compact</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parse_static_data-source -->
          
        </div>

        

        
      </div><!-- parse_static_data-method -->

    
      <div id="method-c-read_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_file</span><span
            class="method-args">(location, chomp=true)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="read_file-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 102</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">chomp</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">location</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span> }
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">chomp</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">chomp</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">file</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- read_file-source -->
          
        </div>

        

        
      </div><!-- read_file-method -->

    
      <div id="method-c-read_json_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_json_file</span><span
            class="method-args">(location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Reads the given file, which is assumed to be a JSON-loadable object, and
returns that JSON back to the caller.</p>
          

          
          <div class="method-source-code" id="read_json_file-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 114</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_json_file</span>(<span class="ruby-identifier">location</span>)
  <span class="ruby-identifier">data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-identifier">location</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">data</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- read_json_file-source -->
          
        </div>

        

        
      </div><!-- read_json_file-method -->

    
      <div id="method-c-run_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">run_app</span><span
            class="method-args">(app_name, port, db_location, public_ip, private_ip, app_version, app_language, nginx_port, xmpp_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns pid if successful, -1 if not</p>
          

          
          <div class="method-source-code" id="run_app-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 324</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_app</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">db_location</span>, <span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">private_ip</span>, <span class="ruby-identifier">app_version</span>, <span class="ruby-identifier">app_language</span>, <span class="ruby-identifier">nginx_port</span>, <span class="ruby-identifier">xmpp_ip</span>)
  <span class="ruby-identifier">secret</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_secret</span>    

  <span class="ruby-identifier">start_cmd</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">env_vars</span> = {}
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_language</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;python&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-node">&quot;/var/apps/#{app_name}/app/app.yaml&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;The #{app_name} application was missing a app.yaml&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-value">-1</span> 
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;saw a python app coming through&quot;</span>)
    <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'MY_IP_ADDRESS'</span>] = <span class="ruby-identifier">public_ip</span>
    <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'MY_PORT'</span>] = <span class="ruby-identifier">port</span>
    <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'APPNAME'</span>] = <span class="ruby-identifier">app_name</span>
    <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'GOMAXPROCS'</span>] = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_num_cpus</span>()

    <span class="ruby-identifier">start_cmd</span> = [ <span class="ruby-string">&quot;python2.5 &quot;</span>,
           <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppServer/dev_appserver.py&quot;</span>,
           <span class="ruby-node">&quot;-p #{port}&quot;</span>,
           <span class="ruby-node">&quot;--cookie_secret #{secret}&quot;</span>,
           <span class="ruby-node">&quot;--login_server #{public_ip}&quot;</span>,
           <span class="ruby-string">&quot;--admin_console_server ''&quot;</span>,
           <span class="ruby-node">&quot;--nginx_port #{nginx_port}&quot;</span>,
           <span class="ruby-node">&quot;--nginx_host #{public_ip}&quot;</span>,
           <span class="ruby-string">&quot;--require_indexes&quot;</span>,
           <span class="ruby-string">&quot;--enable_sendmail&quot;</span>,
           <span class="ruby-node">&quot;--xmpp_path #{xmpp_ip}&quot;</span>,
           <span class="ruby-node">&quot;--uaserver_path #{db_location}:#{UserAppClient::SERVER_PORT}&quot;</span>,
           <span class="ruby-node">&quot;--datastore_path #{db_location}:#{PbServer::LISTEN_PORT_NO_SSL}&quot;</span>,
           <span class="ruby-node">&quot;--history_path /var/apps/#{app_name}/data/app.datastore.history&quot;</span>,
           <span class="ruby-node">&quot;/var/apps/#{app_name}/app&quot;</span>,
           <span class="ruby-node">&quot;-a #{private_ip}&quot;</span>,
           <span class="ruby-comment">#&quot;&gt;&gt; /var/apps/#{app_name}/log/server.log 2&gt;&amp;1 &amp;&quot;</span>
           ].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
    <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-node">&quot;ps ax | grep #{start_cmd} | grep -v grep | awk '{ print $1 }' | xargs -d '\n' kill -9&quot;</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">app_language</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;java&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-node">&quot;/var/apps/#{app_name}/app/war/WEB-INF/web.xml&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">and</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-node">&quot;/var/apps/#{app_name}/app/app.yaml&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;The #{app_name} application was missing a web.xml or app.yaml file&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-value">-1</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;saw a java app coming through&quot;</span>)
    <span class="ruby-node">%xcp #{APPSCALE_HOME}/AppServer_Java/appengine-java-sdk-repacked/lib/user/*.jar /var/apps/#{app_name}/app/war/WEB-INF/lib/`</span>
    <span class="ruby-node">%xcp #{APPSCALE_HOME}/AppServer_Java/appengine-java-sdk-repacked/lib/user/orm/*.jar /var/apps/#{app_name}/app/war/WEB-INF/lib/`</span>
    <span class="ruby-identifier">start_cmd</span> = [<span class="ruby-node">&quot;cd #{APPSCALE_HOME}/AppServer_Java &amp;&amp;&quot;</span>,
           <span class="ruby-string">&quot;./genKeystore.sh &amp;&amp;&quot;</span>,
           <span class="ruby-string">&quot;./appengine-java-sdk-repacked/bin/dev_appserver.sh&quot;</span>,
           <span class="ruby-node">&quot;--port=#{port}&quot;</span>,
           <span class="ruby-node">&quot;--address=#{private_ip}&quot;</span>,
           <span class="ruby-node">&quot;--datastore_path=#{db_location}&quot;</span>,
           <span class="ruby-node">&quot;--cookie_secret=#{secret}&quot;</span>,
           <span class="ruby-node">&quot;--login_server=#{public_ip}&quot;</span>,
           <span class="ruby-node">&quot;--appscale_version=#{app_version}&quot;</span>,
           <span class="ruby-node">&quot;--NGINX_ADDRESS=#{public_ip}&quot;</span>,
           <span class="ruby-node">&quot;--NGINX_PORT=#{nginx_port}&quot;</span>,
           <span class="ruby-node">&quot;/var/apps/#{app_name}/app/war/&quot;</span>,
           <span class="ruby-comment">#&quot;&gt;&gt; /var/apps/#{app_name}/log/server.log 2&gt;&amp;1 &amp;&quot;</span>
           ].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
    <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-node">&quot;ps ax | grep #{start_cmd} | grep -v grep | awk '{ print $1 }' | xargs -d '\n' kill -9&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Currently we only support python, go, and java applications, not #{app_language}.&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'APPSCALE_HOME'</span>] = <span class="ruby-constant">APPSCALE_HOME</span>

  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">start_cmd</span>, <span class="ruby-identifier">stop_cmd</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">env_vars</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">local_ip</span>, <span class="ruby-identifier">port</span>)

  <span class="ruby-identifier">pid</span> = <span class="ruby-node">%xlsof -t -i :#{port}`</span>
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Started app #{app_name} with pid #{pid}&quot;</span>)
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">pid</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- run_app-source -->
          
        </div>

        

        
      </div><!-- run_app-method -->

    
      <div id="method-c-run_remote_command" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">run_remote_command</span><span
            class="method-args">(ip, command, public_key_loc, want_output)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="run_remote_command-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 213</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_remote_command</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">command</span>, <span class="ruby-identifier">public_key_loc</span>, <span class="ruby-identifier">want_output</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;ip is [#{ip}], command is [#{command}], public key is [#{public_key_loc}], want output? [#{want_output}]&quot;</span>)
  <span class="ruby-identifier">public_key_loc</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">public_key_loc</span>)
  
  <span class="ruby-identifier">remote_cmd</span> = <span class="ruby-node">&quot;ssh -i #{public_key_loc} -o StrictHostkeyChecking=no root@#{ip} '#{command} &quot;</span>
  
  <span class="ruby-identifier">output_file</span> = <span class="ruby-node">&quot;/tmp/#{ip}.log&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">want_output</span>
    <span class="ruby-identifier">remote_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;2&gt;&amp;1 &gt; #{output_file} &amp;' &amp;&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">remote_cmd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;&gt; /dev/null &amp;' &amp;&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Running [#{remote_cmd}]&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">want_output</span>
    <span class="ruby-keyword">return</span> <span class="ruby-node">%x#{remote_cmd}`</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">system</span> <span class="ruby-identifier">remote_cmd</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">remote_cmd</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- run_remote_command-source -->
          
        </div>

        

        
      </div><!-- run_remote_command-method -->

    
      <div id="method-c-scp_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">scp_file</span><span
            class="method-args">(local_file_loc, remote_file_loc, target_ip, private_key_loc)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="scp_file-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">local_file_loc</span>, <span class="ruby-identifier">remote_file_loc</span>, <span class="ruby-identifier">target_ip</span>, <span class="ruby-identifier">private_key_loc</span>)
  <span class="ruby-identifier">private_key_loc</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">private_key_loc</span>)
  <span class="ruby-node">%xchmod 0600 #{private_key_loc}`</span>
  <span class="ruby-identifier">local_file_loc</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">local_file_loc</span>)
  <span class="ruby-identifier">retval_file</span> = <span class="ruby-node">&quot;/etc/appscale/retval-#{Kernel.rand()}&quot;</span>
  <span class="ruby-identifier">cmd</span> = <span class="ruby-node">&quot;scp -i #{private_key_loc} -o StrictHostkeyChecking=no 2&gt;&amp;1 #{local_file_loc} root@#{target_ip}:#{remote_file_loc}; echo $? &gt; #{retval_file}&quot;</span>
  <span class="ruby-comment">#Kernel.puts(cmd)</span>
  <span class="ruby-identifier">scp_result</span> = <span class="ruby-node">%x#{cmd}`</span>

  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">retval_file</span>)
    <span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
  }

  <span class="ruby-identifier">retval</span> = (<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">retval_file</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span> }).<span class="ruby-identifier">chomp</span>

  <span class="ruby-identifier">fails</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">retval</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0&quot;</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;\n\n[#{cmd}] returned #{retval} instead of 0 as expected. Will try to copy again momentarily...&quot;</span>)
    <span class="ruby-identifier">fails</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;SCP failed&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fails</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">5</span>
    <span class="ruby-identifier">sleep</span>(<span class="ruby-value">2</span>)
    <span class="ruby-node">%x#{cmd}`</span>
    <span class="ruby-identifier">retval</span> = (<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">retval_file</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span> }).<span class="ruby-identifier">chomp</span>
  }

  <span class="ruby-comment">#Kernel.puts(scp_result)</span>
  <span class="ruby-node">%xrm -fv #{retval_file}`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- scp_file-source -->
          
        </div>

        

        
      </div><!-- scp_file-method -->

    
      <div id="method-c-set_creds_in_env" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_creds_in_env</span><span
            class="method-args">(creds, cloud_num)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="set_creds_in_env-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 545</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_creds_in_env</span>(<span class="ruby-identifier">creds</span>, <span class="ruby-identifier">cloud_num</span>)
  <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_JVM_ARGS'</span>] = <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">creds</span>.<span class="ruby-identifier">each_pair</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">=~</span> <span class="ruby-node">%r\ACLOUD#{cloud_num}/</span>
    <span class="ruby-identifier">env_key</span> = <span class="ruby-identifier">k</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">%r\ACLOUD#{cloud_num}_(.*)\Z/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-constant">ENV</span>[<span class="ruby-identifier">env_key</span>] = <span class="ruby-identifier">v</span>
  }

  <span class="ruby-comment"># note that key and cert vars are set wrong - they refer to</span>
  <span class="ruby-comment"># the location on the user's machine where the key is</span>
  <span class="ruby-comment"># thus, let's fix that</span>

  <span class="ruby-identifier">cloud_keys_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/keys/cloud#{cloud_num}&quot;</span>)
  <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_PRIVATE_KEY'</span>] = <span class="ruby-node">&quot;#{cloud_keys_dir}/mykey.pem&quot;</span>
  <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_CERT'</span>] = <span class="ruby-node">&quot;#{cloud_keys_dir}/mycert.pem&quot;</span>

  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Setting private key to #{cloud_keys_dir}/mykey.pem, cert to #{cloud_keys_dir}/mycert.pem&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_creds_in_env-source -->
          
        </div>

        

        
      </div><!-- set_creds_in_env-method -->

    
      <div id="method-c-setup_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">setup_app</span><span
            class="method-args">(app_name, untar=true)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="setup_app-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 306</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">setup_app</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">untar</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">meta_dir</span> = <span class="ruby-node">&quot;/var/apps/#{app_name}&quot;</span>
  <span class="ruby-identifier">tar_dir</span> = <span class="ruby-node">&quot;#{meta_dir}/app/&quot;</span>
  <span class="ruby-identifier">tar_path</span> = <span class="ruby-node">&quot;#{tar_dir}#{app_name}.tar.gz&quot;</span>
  <span class="ruby-comment">#Kernel.system &quot;rm -rf #{tar_dir}&quot;</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;mkdir -p #{tar_dir}&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;mkdir -p #{meta_dir}/log&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;cp #{APPSCALE_HOME}/AppLoadBalancer/public/404.html #{meta_dir}&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;touch #{meta_dir}/log/server.log&quot;</span>)
  <span class="ruby-comment">#tar_file = File.open(tar_path, &quot;w&quot;)</span>
  <span class="ruby-comment">#decoded_tar = Base64.decode64(encoded_app_tar)</span>
  <span class="ruby-comment">#tar_file.write(decoded_tar)</span>
  <span class="ruby-comment">#tar_file.close</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;tar --file #{tar_path} --force-local -C #{tar_dir} -zx&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">untar</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- setup_app-source -->
          
        </div>

        

        
      </div><!-- setup_app-method -->

    
      <div id="method-c-shell" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">shell</span><span
            class="method-args">(cmd)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="shell-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 87</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-identifier">cmd</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-node">%x#{cmd}`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- shell-source -->
          
        </div>

        

        
      </div><!-- shell-method -->

    
      <div id="method-c-shorten_to_n_items" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">shorten_to_n_items</span><span
            class="method-args">(n, array)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="shorten_to_n_items-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 1157</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shorten_to_n_items</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">array</span>)
  <span class="ruby-identifier">len</span> = <span class="ruby-identifier">array</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">len</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">n</span>
    <span class="ruby-identifier">array</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">array</span>[<span class="ruby-identifier">len</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">len</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- shorten_to_n_items-source -->
          
        </div>

        

        
      </div><!-- shorten_to_n_items-method -->

    
      <div id="method-c-sleep_until_port_is_closed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sleep_until_port_is_closed</span><span
            class="method-args">(ip, port, use_ssl=DONT_USE_SSL)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="sleep_until_port_is_closed-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 170</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">sleep_until_port_is_closed</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">use_ssl</span>=<span class="ruby-constant">DONT_USE_SSL</span>)
  <span class="ruby-identifier">sleep_time</span> = <span class="ruby-value">1</span>

  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">use_ssl</span>)

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-identifier">sleep_time</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sleep_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">30</span>
      <span class="ruby-identifier">sleep_time</span> <span class="ruby-operator">*=</span> <span class="ruby-value">2</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Waiting on #{ip}:#{port} to be closed (currently open).&quot;</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- sleep_until_port_is_closed-source -->
          
        </div>

        

        
      </div><!-- sleep_until_port_is_closed-method -->

    
      <div id="method-c-sleep_until_port_is_open" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sleep_until_port_is_open</span><span
            class="method-args">(ip, port, use_ssl=DONT_USE_SSL)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="sleep_until_port_is_open-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 154</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">use_ssl</span>=<span class="ruby-constant">DONT_USE_SSL</span>)
  <span class="ruby-identifier">sleep_time</span> = <span class="ruby-value">1</span>

  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">use_ssl</span>)

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-identifier">sleep_time</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sleep_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">30</span>
      <span class="ruby-identifier">sleep_time</span> <span class="ruby-operator">*=</span> <span class="ruby-value">2</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Waiting on #{ip}:#{port} to be open (currently closed).&quot;</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- sleep_until_port_is_open-source -->
          
        </div>

        

        
      </div><!-- sleep_until_port_is_open-method -->

    
      <div id="method-c-spawn_hybrid_vms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">spawn_hybrid_vms</span><span
            class="method-args">(creds, nodes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="spawn_hybrid_vms-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 565</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">spawn_hybrid_vms</span>(<span class="ruby-identifier">creds</span>, <span class="ruby-identifier">nodes</span>)
  <span class="ruby-identifier">info</span> = <span class="ruby-node">&quot;Spawning hybrid vms with creds #{self.obscure_creds(creds).inspect} and nodes #{nodes.inspect}&quot;</span>
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">info</span>)

  <span class="ruby-identifier">cloud_info</span> = []

  <span class="ruby-identifier">cloud_num</span> = <span class="ruby-value">1</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">cloud_type</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-node">&quot;CLOUD#{cloud_num}_TYPE&quot;</span>]
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cloud_type</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_creds_in_env</span>(<span class="ruby-identifier">creds</span>, <span class="ruby-identifier">cloud_num</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">cloud_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;euca&quot;</span>
      <span class="ruby-identifier">machine</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-node">&quot;CLOUD#{cloud_num}_EMI&quot;</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">cloud_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;ec2&quot;</span>
      <span class="ruby-identifier">machine</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-node">&quot;CLOUD#{cloud_num}_AMI&quot;</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;cloud type was #{cloud_type}, which is not a supported value.&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">num_of_vms</span> = <span class="ruby-value">0</span>
    <span class="ruby-identifier">jobs_needed</span> = []
    <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">each_pair</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">=~</span> <span class="ruby-node">%r\Acloud#{cloud_num}-\d+\Z/</span>
        <span class="ruby-identifier">num_of_vms</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">jobs_needed</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">v</span>
      <span class="ruby-keyword">end</span>
    }

    <span class="ruby-identifier">instance_type</span> = <span class="ruby-string">&quot;m1.large&quot;</span>
    <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
    <span class="ruby-identifier">cloud</span> = <span class="ruby-node">&quot;cloud#{cloud_num}&quot;</span>
    <span class="ruby-identifier">group</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-string">&quot;group&quot;</span>]

    <span class="ruby-identifier">this_cloud_info</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">spawn_vms</span>(<span class="ruby-identifier">num_of_vms</span>, <span class="ruby-identifier">jobs_needed</span>, <span class="ruby-identifier">machine</span>, 
      <span class="ruby-identifier">instance_type</span>, <span class="ruby-identifier">keyname</span>, <span class="ruby-identifier">cloud_type</span>, <span class="ruby-identifier">cloud</span>, <span class="ruby-identifier">group</span>)

    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Cloud#{cloud_num} reports the following info: #{this_cloud_info.join(', ')}&quot;</span>)

    <span class="ruby-identifier">cloud_info</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">this_cloud_info</span>
    <span class="ruby-identifier">cloud_num</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  }

  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Hybrid cloud spawning reports the following info: #{cloud_info.join(', ')}&quot;</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cloud_info</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- spawn_hybrid_vms-source -->
          
        </div>

        

        
      </div><!-- spawn_hybrid_vms-method -->

    
      <div id="method-c-spawn_vms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">spawn_vms</span><span
            class="method-args">(num_of_vms_to_spawn, job, image_id, instance_type, keyname, infrastructure, cloud, group, spot=false)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="spawn_vms-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 614</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">spawn_vms</span>(<span class="ruby-identifier">num_of_vms_to_spawn</span>, <span class="ruby-identifier">job</span>, <span class="ruby-identifier">image_id</span>, <span class="ruby-identifier">instance_type</span>, <span class="ruby-identifier">keyname</span>,
  <span class="ruby-identifier">infrastructure</span>, <span class="ruby-identifier">cloud</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">spot</span>=<span class="ruby-keyword">false</span>)

  <span class="ruby-identifier">start_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>

  <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">num_of_vms_to_spawn</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>

  <span class="ruby-identifier">ssh_key</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/keys/#{cloud}/#{keyname}.key&quot;</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;About to spawn VMs, expecting to find a key at #{ssh_key}&quot;</span>)

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_obscured_env</span>

  <span class="ruby-identifier">new_cloud</span> = <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_cloud</span> <span class="ruby-comment"># need to create security group and key</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Creating keys/security group for #{cloud}&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">generate_ssh_key</span>(<span class="ruby-identifier">ssh_key</span>, <span class="ruby-identifier">keyname</span>, <span class="ruby-identifier">infrastructure</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_appscale_security_group</span>(<span class="ruby-identifier">infrastructure</span>, <span class="ruby-identifier">group</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Not creating keys/security group for #{cloud}&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">instance_ids_up</span> = []
  <span class="ruby-identifier">public_up_already</span> = []
  <span class="ruby-identifier">private_up_already</span> = []
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;[#{num_of_vms_to_spawn}] [#{job}] [#{image_id}]  [#{instance_type}] [#{keyname}] [#{infrastructure}] [#{cloud}] [#{group}] [#{spot}]&quot;</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;EC2_URL = [#{ENV['EC2_URL']}]&quot;</span>)
  <span class="ruby-identifier">loop</span> { <span class="ruby-comment"># need to make sure ec2 doesn't return an error message here</span>
    <span class="ruby-identifier">describe_instances</span> = <span class="ruby-node">%x#{infrastructure}-describe-instances 2&gt;&amp;1`</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;describe-instances says [#{describe_instances}]&quot;</span>)
    <span class="ruby-identifier">all_ip_addrs</span> = <span class="ruby-identifier">describe_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">%r\s+(#{IP_OR_FQDN})\s+(#{IP_OR_FQDN})\s+running\s+#{keyname}\s/</span>).<span class="ruby-identifier">flatten</span>
    <span class="ruby-identifier">instance_ids_up</span> = <span class="ruby-identifier">describe_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rINSTANCE\s+(i-\w+)/</span>).<span class="ruby-identifier">flatten</span>
    <span class="ruby-identifier">public_up_already</span>, <span class="ruby-identifier">private_up_already</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_ips</span>(<span class="ruby-identifier">all_ip_addrs</span>)
    <span class="ruby-identifier">vms_up_already</span> = <span class="ruby-identifier">describe_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">%r(#{IP_OR_FQDN})\s+running\s+#{keyname}\s+/</span>).<span class="ruby-identifier">length</span>
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">vms_up_already</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">new_cloud</span> <span class="ruby-comment"># crucial for hybrid cloud, where one box may not be running yet</span>
  }
 
  <span class="ruby-identifier">args</span> = <span class="ruby-node">&quot;-k #{keyname} -n #{num_of_vms_to_spawn} --instance-type #{instance_type} --group #{group} #{image_id}&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">spot</span>
    <span class="ruby-identifier">price</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_optimal_spot_price</span>(<span class="ruby-identifier">instance_type</span>)
    <span class="ruby-identifier">command_to_run</span> = <span class="ruby-node">&quot;ec2-request-spot-instances -p #{price} #{args}&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">command_to_run</span> = <span class="ruby-node">&quot;#{infrastructure}-run-instances #{args}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">loop</span> {
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">command_to_run</span>)
    <span class="ruby-identifier">run_instances</span> = <span class="ruby-node">%x#{command_to_run} 2&gt;&amp;1`</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;run_instances says [#{run_instances}]&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">run_instances</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rPlease try again later./</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Error with run_instances: #{run_instances}. Will try again in a moment.&quot;</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">run_instances</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rtry --addressing private/</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;Need to retry with addressing private. Will try again in a moment.&quot;</span>)
      <span class="ruby-identifier">command_to_run</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot; --addressing private&quot;</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">run_instances</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rPROBLEM/</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Error: #{run_instances}&quot;</span>)
      <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;Saw the following error message from EC2 tools. Please resolve the issue and try again:\n#{run_instances}&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;Run instances message sent successfully. Waiting for the image to start up.&quot;</span>)
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-string">&quot;sleepy time&quot;</span>)
    <span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
  }
  
  <span class="ruby-identifier">instance_ids</span> = []
  <span class="ruby-identifier">public_ips</span> = []
  <span class="ruby-identifier">private_ips</span> = []

  <span class="ruby-identifier">sleep</span>(<span class="ruby-value">10</span>) <span class="ruby-comment"># euca 2.0.3 can throw forbidden errors if we hit it too fast</span>
  <span class="ruby-comment"># TODO: refactor me to use rightaws gem, check for forbidden, and retry accordingly</span>

  <span class="ruby-identifier">end_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-constant">MAX_VM_CREATION_TIME</span>
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">end_time</span>
    <span class="ruby-identifier">describe_instances</span> = <span class="ruby-node">%x#{infrastructure}-describe-instances`</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;[#{Time.now}] #{end_time - now} seconds left...&quot;</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">describe_instances</span>)
 
    <span class="ruby-comment"># TODO: match on instance id</span>
    <span class="ruby-comment">#if describe_instances =~ /terminated\s+#{keyname}\s+/</span>
    <span class="ruby-comment">#  terminated_message = &quot;An instance was unexpectedly terminated. &quot; +</span>
    <span class="ruby-comment">#    &quot;Please contact your cloud administrator to determine why &quot; +</span>
    <span class="ruby-comment">#    &quot;and try again. \n#{describe_instances}&quot;</span>
    <span class="ruby-comment">#  Kernel.puts(terminated_message)</span>
    <span class="ruby-comment">#  abort(terminated_message)</span>
    <span class="ruby-comment">#end</span>
    
    <span class="ruby-comment"># changed regexes so ensure we are only checking for instances created</span>
    <span class="ruby-comment"># for appscale only (don't worry about other instances created)</span>
    
    <span class="ruby-identifier">all_ip_addrs</span> = <span class="ruby-identifier">describe_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">%r\s+(#{IP_OR_FQDN})\s+(#{IP_OR_FQDN})\s+running\s+#{keyname}\s+/</span>).<span class="ruby-identifier">flatten</span>
    <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_ips</span>(<span class="ruby-identifier">all_ip_addrs</span>)
    <span class="ruby-identifier">public_ips</span> = <span class="ruby-identifier">public_ips</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">public_up_already</span>
    <span class="ruby-identifier">private_ips</span> = <span class="ruby-identifier">private_ips</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">private_up_already</span>
    <span class="ruby-identifier">instance_ids</span> = <span class="ruby-identifier">describe_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">%rINSTANCE\s+(i-\w+)\s+[\w\-\s\.]+#{keyname}/</span>).<span class="ruby-identifier">flatten</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">instance_ids_up</span>
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">num_of_vms_to_spawn</span>
    <span class="ruby-identifier">sleep</span>(<span class="ruby-constant">SLEEP_TIME</span>)
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;No public IPs were able to be procured within the time limit.&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">num_of_vms_to_spawn</span>
    <span class="ruby-identifier">potential_dead_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_ips</span>(<span class="ruby-identifier">all_ip_addrs</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">public_up_already</span>
    <span class="ruby-identifier">potential_dead_ips</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">potential_dead_ips</span>[<span class="ruby-identifier">index</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0.0.0.0&quot;</span>
        <span class="ruby-identifier">instance_to_term</span> = <span class="ruby-identifier">instance_ids</span>[<span class="ruby-identifier">index</span>]
        <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Instance #{instance_to_term} failed to get a public IP address and is being terminated.&quot;</span>)
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-terminate-instances #{instance_to_term}&quot;</span>)
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>         
  
  <span class="ruby-identifier">jobs</span> = []
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
    <span class="ruby-comment"># We only got one job, so just repeat it for each one of the nodes</span>
    <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">jobs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">job</span> }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">jobs</span> = <span class="ruby-identifier">job</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># ip:job:instance-id</span>
  <span class="ruby-identifier">instances_created</span> = []
  <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">instances_created</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{public_ips[index]}:#{private_ips[index]}:#{jobs[index]}:#{instance_ids[index]}:#{cloud}&quot;</span>
  }
  
  <span class="ruby-identifier">end_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
  <span class="ruby-identifier">total_time</span> = <span class="ruby-identifier">end_time</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start_time</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">spot</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;TIMING: It took #{total_time} seconds to spawn &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{num_of_vms_to_spawn} spot instances&quot;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;TIMING: It took #{total_time} seconds to spawn &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{num_of_vms_to_spawn} regular instances&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">instances_created</span>    
<span class="ruby-keyword">end</span></pre>
          </div><!-- spawn_vms-source -->
          
        </div>

        

        
      </div><!-- spawn_vms-method -->

    
      <div id="method-c-stop_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_app</span><span
            class="method-args">(app_name, port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Instructs god to terminate and stop watching an App Engine application, 
identified by its name and the port that it runs on.</p>
          

          
          <div class="method-source-code" id="stop_app-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 404</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">stop_app</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">port</span>)
  <span class="ruby-identifier">watch</span> = <span class="ruby-string">&quot;appscale-&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">app_name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;-&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">port</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-identifier">watch</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Stopped #{watch} process via god.&quot;</span>)
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">remove</span>(<span class="ruby-identifier">watch</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Stopped watching #{watch} via god.&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_app-source -->
          
        </div>

        

        
      </div><!-- stop_app-method -->

    
      <div id="method-c-terminate_all_vms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">terminate_all_vms</span><span
            class="method-args">(infrastructure, keyname)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="terminate_all_vms-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 821</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">terminate_all_vms</span>(<span class="ruby-identifier">infrastructure</span>, <span class="ruby-identifier">keyname</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_obscured_env</span>
  <span class="ruby-identifier">desc_instances</span> = <span class="ruby-node">%x#{infrastructure}-describe-instances`</span>
  <span class="ruby-identifier">instances</span> = <span class="ruby-identifier">desc_instances</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">%rINSTANCE\s+(i-\w+)\s+[\w\-\s\.]+#{keyname}/</span>).<span class="ruby-identifier">flatten</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">%x#{infrastructure}-terminate-instances #{instances.join(' ')}`</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- terminate_all_vms-source -->
          
        </div>

        

        
      </div><!-- terminate_all_vms-method -->

    
      <div id="method-c-terminate_hybrid_vms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">terminate_hybrid_vms</span><span
            class="method-args">(creds)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="terminate_hybrid_vms-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 800</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">terminate_hybrid_vms</span>(<span class="ruby-identifier">creds</span>)
  <span class="ruby-comment"># TODO: kill my own cloud last</span>
  <span class="ruby-comment"># otherwise could orphan other clouds</span>

  <span class="ruby-identifier">cloud_num</span> = <span class="ruby-value">1</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;CLOUD#{cloud_num}_TYPE&quot;</span>
    <span class="ruby-identifier">cloud_type</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-identifier">key</span>]
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cloud_type</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_creds_in_env</span>(<span class="ruby-identifier">creds</span>, <span class="ruby-identifier">cloud_num</span>)

    <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Killing Cloud#{cloud_num}'s machines, of type #{cloud_type} and with keyname #{keyname}&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">terminate_all_vms</span>(<span class="ruby-identifier">cloud_type</span>, <span class="ruby-identifier">keyname</span>)

    <span class="ruby-identifier">cloud_num</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  }

<span class="ruby-keyword">end</span></pre>
          </div><!-- terminate_hybrid_vms-source -->
          
        </div>

        

        
      </div><!-- terminate_hybrid_vms-method -->

    
      <div id="method-c-terminate_vms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">terminate_vms</span><span
            class="method-args">(nodes, infrastructure)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="terminate_vms-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 790</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">terminate_vms</span>(<span class="ruby-identifier">nodes</span>, <span class="ruby-identifier">infrastructure</span>)
  <span class="ruby-identifier">instances</span> = []
  <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">instance_id</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">instance_id</span>
    <span class="ruby-identifier">instances</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">instance_id</span>
  }
  
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-node">&quot;#{infrastructure}-terminate-instances #{instances.join(' ')}&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- terminate_vms-source -->
          
        </div>

        

        
      </div><!-- terminate_vms-method -->

    
      <div id="method-c-write_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_file</span><span
            class="method-args">(location, contents)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_file-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 92</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">contents</span>)
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">location</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">contents</span>) }
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_file-source -->
          
        </div>

        

        
      </div><!-- write_file-method -->

    
      <div id="method-c-write_json_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_json_file</span><span
            class="method-args">(location, contents)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_json_file-source">
            <pre><span class="ruby-comment"># File AppController/lib/helperfunctions.rb, line 97</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_json_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">contents</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">contents</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_json_file-source -->
          
        </div>

        

        
      </div><!-- write_json_file-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

