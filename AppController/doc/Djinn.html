<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class Djinn - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>AppController/djinn.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="Object.html">Object</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-convert_location_array_to_class">::convert_location_array_to_class</a>
    
    <li><a href="#method-c-convert_location_class_to_array">::convert_location_class_to_array</a>
    
    <li><a href="#method-c-get_db_master_ip">::get_db_master_ip</a>
    
    <li><a href="#method-c-get_db_slave_ips">::get_db_slave_ips</a>
    
    <li><a href="#method-c-get_nearest_db_ip">::get_nearest_db_ip</a>
    
    <li><a href="#method-c-log_debug">::log_debug</a>
    
    <li><a href="#method-c-log_run">::log_run</a>
    
    <li><a href="#method-c-log_to_buffer">::log_to_buffer</a>
    
    <li><a href="#method-c-log_to_stdout">::log_to_stdout</a>
    
    <li><a href="#method-c-neptune_parse_creds">::neptune_parse_creds</a>
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-add_appserver_process">#add_appserver_process</a>
    
    <li><a href="#method-i-add_role">#add_role</a>
    
    <li><a href="#method-i-backup_appcontroller_state">#backup_appcontroller_state</a>
    
    <li><a href="#method-i-change_job">#change_job</a>
    
    <li><a href="#method-i-convert_fqdns_to_ips">#convert_fqdns_to_ips</a>
    
    <li><a href="#method-i-copy_app_to_local">#copy_app_to_local</a>
    
    <li><a href="#method-i-copy_encryption_keys">#copy_encryption_keys</a>
    
    <li><a href="#method-i-done_uploading">#done_uploading</a>
    
    <li><a href="#method-i-ensure_all_roles_are_running">#ensure_all_roles_are_running</a>
    
    <li><a href="#method-i-find_me_in_locations">#find_me_in_locations</a>
    
    <li><a href="#method-i-get_all_appengine_nodes">#get_all_appengine_nodes</a>
    
    <li><a href="#method-i-get_all_public_ips">#get_all_public_ips</a>
    
    <li><a href="#method-i-get_db_master">#get_db_master</a>
    
    <li><a href="#method-i-get_load_balancer_ip">#get_load_balancer_ip</a>
    
    <li><a href="#method-i-get_login">#get_login</a>
    
    <li><a href="#method-i-get_online_users_list">#get_online_users_list</a>
    
    <li><a href="#method-i-get_public_ip">#get_public_ip</a>
    
    <li><a href="#method-i-get_role_info">#get_role_info</a>
    
    <li><a href="#method-i-get_scaling_info_for_app">#get_scaling_info_for_app</a>
    
    <li><a href="#method-i-get_shadow">#get_shadow</a>
    
    <li><a href="#method-i-get_stats">#get_stats</a>
    
    <li><a href="#method-i-get_status">#get_status</a>
    
    <li><a href="#method-i-got_all_data">#got_all_data</a>
    
    <li><a href="#method-i-initialize_node">#initialize_node</a>
    
    <li><a href="#method-i-initialize_nodes_in_parallel">#initialize_nodes_in_parallel</a>
    
    <li><a href="#method-i-initialize_scaling_info_for_app">#initialize_scaling_info_for_app</a>
    
    <li><a href="#method-i-initialize_server">#initialize_server</a>
    
    <li><a href="#method-i-is_app_running">#is_app_running</a>
    
    <li><a href="#method-i-is_cloud-3F">#is_cloud?</a>
    
    <li><a href="#method-i-is_cpu_or_mem_maxed_out-3F">#is_cpu_or_mem_maxed_out?</a>
    
    <li><a href="#method-i-is_done_initializing">#is_done_initializing</a>
    
    <li><a href="#method-i-is_done_loading">#is_done_loading</a>
    
    <li><a href="#method-i-is_hybrid_cloud-3F">#is_hybrid_cloud?</a>
    
    <li><a href="#method-i-is_running-3F">#is_running?</a>
    
    <li><a href="#method-i-job_start">#job_start</a>
    
    <li><a href="#method-i-kill">#kill</a>
    
    <li><a href="#method-i-load_neptune_info">#load_neptune_info</a>
    
    <li><a href="#method-i-my_node">#my_node</a>
    
    <li><a href="#method-i-parse_creds">#parse_creds</a>
    
    <li><a href="#method-i-perform_scaling_for_appservers">#perform_scaling_for_appservers</a>
    
    <li><a href="#method-i-post_logs_to_sisyphus">#post_logs_to_sisyphus</a>
    
    <li><a href="#method-i-remove_appserver_process">#remove_appserver_process</a>
    
    <li><a href="#method-i-remove_node_from_local_and_zookeeper">#remove_node_from_local_and_zookeeper</a>
    
    <li><a href="#method-i-remove_role">#remove_role</a>
    
    <li><a href="#method-i-restore_appcontroller_state">#restore_appcontroller_state</a>
    
    <li><a href="#method-i-restore_db_state_if_needed">#restore_db_state_if_needed</a>
    
    <li><a href="#method-i-restore_from_db-3F">#restore_from_db?</a>
    
    <li><a href="#method-i-rsync_files">#rsync_files</a>
    
    <li><a href="#method-i-run_neptune_in_cloud-3F">#run_neptune_in_cloud?</a>
    
    <li><a href="#method-i-sanitize_credentials">#sanitize_credentials</a>
    
    <li><a href="#method-i-scale_appservers">#scale_appservers</a>
    
    <li><a href="#method-i-send_logs_to_sisyphus">#send_logs_to_sisyphus</a>
    
    <li><a href="#method-i-set_apps">#set_apps</a>
    
    <li><a href="#method-i-set_parameters">#set_parameters</a>
    
    <li><a href="#method-i-set_uaserver_ips">#set_uaserver_ips</a>
    
    <li><a href="#method-i-setup_config_files">#setup_config_files</a>
    
    <li><a href="#method-i-setup_hadoop_config_org">#setup_hadoop_config_org</a>
    
    <li><a href="#method-i-spawn_and_setup_appengine">#spawn_and_setup_appengine</a>
    
    <li><a href="#method-i-spawn_appengine">#spawn_appengine</a>
    
    <li><a href="#method-i-start_appcontroller">#start_appcontroller</a>
    
    <li><a href="#method-i-start_appengine">#start_appengine</a>
    
    <li><a href="#method-i-start_blobstore_server">#start_blobstore_server</a>
    
    <li><a href="#method-i-start_ejabberd">#start_ejabberd</a>
    
    <li><a href="#method-i-start_hadoop_org">#start_hadoop_org</a>
    
    <li><a href="#method-i-start_infrastructure_manager">#start_infrastructure_manager</a>
    
    <li><a href="#method-i-start_load_balancer">#start_load_balancer</a>
    
    <li><a href="#method-i-start_memcache">#start_memcache</a>
    
    <li><a href="#method-i-start_neptune_manager">#start_neptune_manager</a>
    
    <li><a href="#method-i-start_new_roles_on_nodes">#start_new_roles_on_nodes</a>
    
    <li><a href="#method-i-start_open">#start_open</a>
    
    <li><a href="#method-i-start_pbserver">#start_pbserver</a>
    
    <li><a href="#method-i-start_rabbitmq_master">#start_rabbitmq_master</a>
    
    <li><a href="#method-i-start_rabbitmq_slave">#start_rabbitmq_slave</a>
    
    <li><a href="#method-i-start_shadow">#start_shadow</a>
    
    <li><a href="#method-i-start_sisyphus">#start_sisyphus</a>
    
    <li><a href="#method-i-start_soap_server">#start_soap_server</a>
    
    <li><a href="#method-i-start_xmpp_for_app">#start_xmpp_for_app</a>
    
    <li><a href="#method-i-status">#status</a>
    
    <li><a href="#method-i-stop_app">#stop_app</a>
    
    <li><a href="#method-i-stop_appengine">#stop_appengine</a>
    
    <li><a href="#method-i-stop_blob_server">#stop_blob_server</a>
    
    <li><a href="#method-i-stop_ejabberd">#stop_ejabberd</a>
    
    <li><a href="#method-i-stop_infrastructure_manager">#stop_infrastructure_manager</a>
    
    <li><a href="#method-i-stop_load_balancer">#stop_load_balancer</a>
    
    <li><a href="#method-i-stop_memcache">#stop_memcache</a>
    
    <li><a href="#method-i-stop_neptune_manager">#stop_neptune_manager</a>
    
    <li><a href="#method-i-stop_open">#stop_open</a>
    
    <li><a href="#method-i-stop_pbserver">#stop_pbserver</a>
    
    <li><a href="#method-i-stop_shadow">#stop_shadow</a>
    
    <li><a href="#method-i-stop_sisyphus">#stop_sisyphus</a>
    
    <li><a href="#method-i-stop_soap_server">#stop_soap_server</a>
    
    <li><a href="#method-i-try_to_scale_down">#try_to_scale_down</a>
    
    <li><a href="#method-i-try_to_scale_up">#try_to_scale_up</a>
    
    <li><a href="#method-i-update">#update</a>
    
    <li><a href="#method-i-update_api_status">#update_api_status</a>
    
    <li><a href="#method-i-update_local_nodes">#update_local_nodes</a>
    
    <li><a href="#method-i-valid_format_for_credentials">#valid_format_for_credentials</a>
    
    <li><a href="#method-i-valid_secret-3F">#valid_secret?</a>
    
    <li><a href="#method-i-validate_image">#validate_image</a>
    
    <li><a href="#method-i-wait_for_data">#wait_for_data</a>
    
    <li><a href="#method-i-wait_for_nodes_to_finish_loading">#wait_for_nodes_to_finish_loading</a>
    
    <li><a href="#method-i-write_cloud_info">#write_cloud_info</a>
    
    <li><a href="#method-i-write_database_info">#write_database_info</a>
    
    <li><a href="#method-i-write_hypersoap">#write_hypersoap</a>
    
    <li><a href="#method-i-write_neptune_info">#write_neptune_info</a>
    
    <li><a href="#method-i-write_our_node_info">#write_our_node_info</a>
    
    <li><a href="#method-i-write_zookeeper_locations">#write_zookeeper_locations</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./AppScaleException.html">AppScaleException</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./BlobServer.html">BlobServer</a>
  
    <li><a href="./Collectd.html">Collectd</a>
  
    <li><a href="./CronHelper.html">CronHelper</a>
  
    <li><a href="./Djinn.html">Djinn</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./DjinnServer.html">DjinnServer</a>
  
    <li><a href="./Ejabberd.html">Ejabberd</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GodInterface.html">GodInterface</a>
  
    <li><a href="./HAProxy.html">HAProxy</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./LoadBalancer.html">LoadBalancer</a>
  
    <li><a href="./Monitoring.html">Monitoring</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./Nginx.html">Nginx</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PbServer.html">PbServer</a>
  
    <li><a href="./RabbitMQ.html">RabbitMQ</a>
  
    <li><a href="./Repo.html">Repo</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Djinn</h1>

  <div id="description" class="description">
    
<p><a href="Djinn.html">Djinn</a> (interchangeably known as ‘the
AppController’) automatically configures and deploys all services for a
single node. It relies on other Djinns or the AppScale Tools to tell it
what services (roles) it should be hosting, and exposes these methods via a
SOAP interface (as is provided in <a
href="DjinnServer.html">DjinnServer</a>).</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="APPSCALE_HOME">APPSCALE_HOME
        
        <dd class="description">
        
      
        <dt id="AUTOSCALE_LOG_FILE">AUTOSCALE_LOG_FILE
        
        <dd class="description"><p>The path to the file where we will store information about AppServer
scaling decisions.</p>
        
      
        <dt id="BAD_INPUT_MSG">BAD_INPUT_MSG
        
        <dd class="description"><p>The message that we display to the user if they call a SOAP-accessible
function with a malformed input (e.g., of the wrong class or format).</p>
        
      
        <dt id="FIREWALL_IS_ON">FIREWALL_IS_ON
        
        <dd class="description"><p>A boolean that indicates whether or not we should turn the firewall on, and
continuously keep it on. Should definitely be on for releases, and on
whenever possible.</p>
        
      
        <dt id="HEALTH_FILE">HEALTH_FILE
        
        <dd class="description"><p>The location on the local filesystem where the AppController writes
information about the status of App Engine APIs, which the AppLoadBalancer
will read and display to users.</p>
        
      
        <dt id="MAX_APPSERVERS_ON_THIS_NODE">MAX_APPSERVERS_ON_THIS_NODE
        
        <dd class="description"><p>The maximum number of AppServers (for all applications) that should be run
on this node.</p>
        
      
        <dt id="MAX_CPU_FOR_APPSERVERS">MAX_CPU_FOR_APPSERVERS
        
        <dd class="description"><p>CPU limits that determine when to stop adding AppServers on a node. Because
AppServers in different languages consume different amounts of CPU, set
different limits per language.</p>
        
      
        <dt id="MAX_MEM_FOR_APPSERVERS">MAX_MEM_FOR_APPSERVERS
        
        <dd class="description"><p>Memory limits that determine when to stop adding AppServers on a node. 
Because AppServers in different languages consume different amounts of 
memory, set different limits per language.</p>
        
      
        <dt id="MIN_APPSERVERS_ON_THIS_NODE">MIN_APPSERVERS_ON_THIS_NODE
        
        <dd class="description"><p>The minimum number of AppServers (for all applications) that should be run
on this node.</p>
        
      
        <dt id="NEPTUNE_INFO">NEPTUNE_INFO
        
        <dd class="description"><p>The location on the local filesystem where the AppController writes
information about Neptune jobs that have finished. One day this information
may be used to more intelligently schedule jobs on the fly.</p>
        
      
        <dt id="NOT_ENOUGH_OPEN_NODES">NOT_ENOUGH_OPEN_NODES
        
        <dd class="description"><p>The message that we display to the user if they want to scale up services
in an Xen/KVM deployment but don’t have enough open nodes to do so.</p>
        
      
        <dt id="NUM_DATA_POINTS">NUM_DATA_POINTS
        
        <dd class="description"><p>The size of the rotating buffers that we use to keep information on the
request rate and number of enqueued requests.</p>
        
      
        <dt id="REQ_IN_QUEUE_INDEX">REQ_IN_QUEUE_INDEX
        
        <dd class="description"><p>The position in the haproxy profiling information where the number of
enqueued requests is specified.</p>
        
      
        <dt id="REQ_RATE_INDEX">REQ_RATE_INDEX
        
        <dd class="description"><p>The position in the haproxy profiling information where the request rate is
specified.</p>
        
      
        <dt id="SCALEDOWN_REQUEST_RATE_THRESHOLD">SCALEDOWN_REQUEST_RATE_THRESHOLD
        
        <dd class="description"><p>Scales down the number of AppServers used to host an application if the
request rate falls below this value.</p>
        
      
        <dt id="SCALEDOWN_TIME_THRESHOLD">SCALEDOWN_TIME_THRESHOLD
        
        <dd class="description"><p>How often we should attempt to decrease the number of AppServers on a given
node.</p>
        
      
        <dt id="SCALEUP_QUEUE_SIZE_THRESHOLD">SCALEUP_QUEUE_SIZE_THRESHOLD
        
        <dd class="description"><p>The minimum number of requests that have to sit in haproxy’s wait queue
for an App Engine application before we will scale up the number of
AppServers  that serve that application.</p>
        
      
        <dt id="SCALEUP_REQUEST_RATE_THRESHOLD">SCALEUP_REQUEST_RATE_THRESHOLD
        
        <dd class="description"><p>Scales up the number of AppServers used to host an application if the
request rate rises above this value.</p>
        
      
        <dt id="SCALEUP_TIME_THRESHOLD">SCALEUP_TIME_THRESHOLD
        
        <dd class="description"><p>How often we should attempt to increase the number of AppServers on a given
node.</p>
        
      
        <dt id="SERVER_PORT">SERVER_PORT
        
        <dd class="description"><p>The port that the AppController runs on by default</p>
        
      
        <dt id="SERVICE_NAME_INDEX">SERVICE_NAME_INDEX
        
        <dd class="description"><p>The position in the haproxy profiling information where the name of the
service (e.g., the frontend or backend) is specified.</p>
        
      
        <dt id="SSH_PORT">SSH_PORT
        
        <dd class="description"><p>The port that SSH connections are hosted over, by default.</p>
        
      
        <dt id="STATE_FILE">STATE_FILE
        
        <dd class="description"><p>The location on the local filesystem where the AppController periodically
writes its state to, and recovers its state from if it crashes.</p>
        
      
        <dt id="USE_SSL">USE_SSL
        
        <dd class="description"><p>A boolean that should be used when we are waiting for a specific port to
open, and only if that port needs SSL to talk over it.</p>
        
      
        <dt id="WGET_OPTIONS">WGET_OPTIONS
        
        <dd class="description"><p>The options that should be used when invoking wget, so that the
AppController can automatically probe a site to see if it’s up.</p>
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-api_status" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">api_status</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A Hash that lists the status of each Google App Engine API made available
within AppScale. Keys are the names of the APIs (e.g., memcache), and
values are the statuses of those APIs (e.g., running).</p>
        
        </div>
      </div>
      
      <div id="attribute-i-app_names" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">app_names</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>An Array of Strings, each of which corresponding to the name of an App
Engine app that should be loaded.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-apps_loaded" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">apps_loaded</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>An Array of Strings, each of which corresponding to the name of an App
Engine app that has been loaded on this node.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-creds" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">creds</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A Hash containing all the parameters needed to configure any service on any
node. At a minimum, this is all the information from the AppScale Tools,
including information about database parameters and the roles for all
nodes.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-done_initializing" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">done_initializing</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A boolean that is used to let remote callers know when this AppController
is done initializing itself, but not necessarily done starting or  stopping
roles.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-done_loading" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">done_loading</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A boolean that is used to let remote callers know when this AppController
is done starting all the services it is responsible for.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-haproxy_port" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">haproxy_port</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The port that haproxy will listen to for the next App Engine app that is
uploaded into the system.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-kill_sig_received" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">kill_sig_received</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A boolean that is used to let remote callers start the shutdown process on
this AppController, which will cleanly shut down and terminate all services
on this node.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-last_updated" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">last_updated</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>An integer timestamp that corresponds to the last time this AppController
has updated @nodes, which we use to compare with a similar timestamp in
ZooKeeper to see when data in @nodes has changed on other nodes.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-my_index" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">my_index</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>An Integer that indexes into @nodes, to return information about this node.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-neptune_jobs" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">neptune_jobs</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A Hash that maps information about each successfully completed Neptune job
to information about the job, that will one day be used to provide hints to
future jobs about how to schedule them optimally.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-neptune_nodes" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">neptune_nodes</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>An Array of <a href="DjinnJobData.html">DjinnJobData</a> objects that
correspond to nodes used for Neptune computation. Nodes are reclaimed every
hour if they are not in use (to avoid being charged for them for another
hour).</p>
        
        </div>
      </div>
      
      <div id="attribute-i-nginx_port" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">nginx_port</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The port that nginx will listen to for the next App Engine app that is
uploaded into the system.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-nodes" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">nodes</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>An Array of <a href="DjinnJobData.html">DjinnJobData</a> objects, each of
which containing information about a node in the currently running AppScale
deployment.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-num_appengines" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">num_appengines</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The number of dev_appservers that should run for every App Engine
application.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-queues_to_read" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">queues_to_read</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>For Babel jobs via Neptune, we keep a list of queues that may have tasks
stored for execution, as well as the parameters needed to execute them
(e.g., input location, output location, cloud credentials).</p>
        
        </div>
      </div>
      
      <div id="attribute-i-registered_with_sisyphus" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">registered_with_sisyphus</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Each component that writes log data to Sisyphus must register itself first,
so this boolean ensures that we only register ourselves once.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-restored" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">restored</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>A boolean that indicates if we are done restoring state from a previously
running AppScale deployment.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-state" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">state</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The human-readable state that this AppController is in.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-total_boxes" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">total_boxes</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The number of nodes that are running in this AppScale deployment.
TODO(cgb): It would seem like we could always calculate this with
@nodes.length, so replace it accordingly.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-userappserver_private_ip" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">userappserver_private_ip</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The public IP address (or FQDN) that the UserAppServer can be found at,
initally set to a dummy value to tell callers not to use it until a real
value is set.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-userappserver_public_ip" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">userappserver_public_ip</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The public IP address (or FQDN) that the UserAppServer can be found at,
initally set to a dummy value to tell callers not to use it until a real
value is set.</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-convert_location_array_to_class" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_location_array_to_class</span><span
            class="method-args">(nodes, keyname)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method converts an Array of Strings (where each String contains all
the information about a single node) to an Array of <a
href="DjinnJobData.html">DjinnJobData</a> objects, which provide
convenience methods that make them easier to operate on than just raw
String objects.</p>
          

          
          <div class="method-source-code" id="convert_location_array_to_class-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1123</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_location_array_to_class</span>(<span class="ruby-identifier">nodes</span>, <span class="ruby-identifier">keyname</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Keyname is of class #{keyname.class}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Keyname is #{keyname}&quot;</span>)
  
  <span class="ruby-identifier">array_of_nodes</span> = []
  <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">converted</span> = <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>, <span class="ruby-identifier">keyname</span>)
    <span class="ruby-identifier">array_of_nodes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">converted</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Adding data &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">converted</span>.<span class="ruby-identifier">to_s</span>)
  }
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">array_of_nodes</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- convert_location_array_to_class-source -->
          
        </div>

        

        
      </div><!-- convert_location_array_to_class-method -->

    
      <div id="method-c-convert_location_class_to_array" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_location_class_to_array</span><span
            class="method-args">(djinn_locations)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method is the opposite of the previous method, and is needed when an
AppController wishes to pass node information to other AppControllers via
SOAP (as SOAP accepts Arrays and Strings but not <a
href="DjinnJobData.html">DjinnJobData</a> objects).</p>
          

          
          <div class="method-source-code" id="convert_location_class_to_array-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1141</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_location_class_to_array</span>(<span class="ruby-identifier">djinn_locations</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">djinn_locations</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>, <span class="ruby-string">&quot;Locations should be an array&quot;</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">djinn_loc_array</span> = []
  <span class="ruby-identifier">djinn_locations</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">location</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">djinn_loc_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">location</span>.<span class="ruby-identifier">serialize</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Serializing data &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">location</span>.<span class="ruby-identifier">serialize</span>)
  }
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">djinn_loc_array</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- convert_location_class_to_array-source -->
          
        </div>

        

        
      </div><!-- convert_location_class_to_array-method -->

    
      <div id="method-c-get_db_master_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_db_master_ip</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_db_master_ip-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1179</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_db_master_ip</span>
  <span class="ruby-identifier">masters_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/masters&quot;</span>)
  <span class="ruby-identifier">master_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-identifier">masters_file</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">master_ip</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_db_master_ip-source -->
          
        </div>

        

        
      </div><!-- get_db_master_ip-method -->

    
      <div id="method-c-get_db_slave_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_db_slave_ips</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_db_slave_ips-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1185</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_db_slave_ips</span>
  <span class="ruby-identifier">slaves_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/slaves&quot;</span>)
  <span class="ruby-identifier">slave_ips</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">slaves_file</span>).<span class="ruby-identifier">readlines</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">chomp!</span> }
  <span class="ruby-identifier">slave_ips</span> = [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">slave_ips</span> <span class="ruby-operator">==</span> [<span class="ruby-string">&quot;&quot;</span>]
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">slave_ips</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_db_slave_ips-source -->
          
        </div>

        

        
      </div><!-- get_db_slave_ips-method -->

    
      <div id="method-c-get_nearest_db_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_nearest_db_ip</span><span
            class="method-args">(is_mysql=false)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_nearest_db_ip-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1192</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_nearest_db_ip</span>(<span class="ruby-identifier">is_mysql</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">db_ips</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_db_slave_ips</span>
  <span class="ruby-comment"># Unless this is mysql we include the master ip</span>
  <span class="ruby-comment"># Update, now mysql also has an API node</span>
  <span class="ruby-identifier">db_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_db_master_ip</span>
  <span class="ruby-identifier">db_ips</span>.<span class="ruby-identifier">compact!</span>
  
  <span class="ruby-identifier">local_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">local_ip</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;DB IPs are [#{db_ips.join(', ')}]&quot;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">db_ips</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">local_ip</span>)
    <span class="ruby-comment"># If there is a local database then use it</span>
    <span class="ruby-identifier">local_ip</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># Otherwise just select one randomly</span>
    <span class="ruby-identifier">db_ips</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-identifier">rand</span> }[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_nearest_db_ip-source -->
          
        </div>

        

        
      </div><!-- get_nearest_db_ip-method -->

    
      <div id="method-c-log_debug" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">log_debug</span><span
            class="method-args">(msg)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method is the nexus of all AppController logging - all messages get
sent to stdout immediately (which god will send to 
/var/log/appscale/controller-17443.log for tailing), and also buffered in
@@log_buffer, which eventually gets pushed to Sisyphus for viewing. See <a
href="Djinn.html#method-i-send_logs_to_sisyphus">#send_logs_to_sisyphus</a>
for that code. Important: Definitely do not log within the following three
methods, as it would cause an infinite loop.</p>
          

          
          <div class="method-source-code" id="log_debug-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1083</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">msg</span>)
  <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_to_stdout</span>(<span class="ruby-identifier">time</span>, <span class="ruby-identifier">msg</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_to_buffer</span>(<span class="ruby-identifier">time</span>, <span class="ruby-identifier">msg</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- log_debug-source -->
          
        </div>

        

        
      </div><!-- log_debug-method -->

    
      <div id="method-c-log_run" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">log_run</span><span
            class="method-args">(command)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Logs and runs the given command, which is assumed to be trusted and thus
needs no filtering on our part. Obviously this should not be executed by
anything that the user could inject input into. Returns the return value of
the code we executed.</p>
          

          
          <div class="method-source-code" id="log_run-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1112</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">command</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">command</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">%x#{command}`</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">$?</span>.<span class="ruby-identifier">to_i</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- log_run-source -->
          
        </div>

        

        
      </div><!-- log_run-method -->

    
      <div id="method-c-log_to_buffer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">log_to_buffer</span><span
            class="method-args">(time, msg)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Logs and timestamps the given message to a log queue, for later processing
via the Sisyphus web app.</p>
          

          
          <div class="method-source-code" id="log_to_buffer-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1101</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_to_buffer</span>(<span class="ruby-identifier">time</span>, <span class="ruby-identifier">msg</span>)
  <span class="ruby-identifier">sec_since_epoch</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%s&quot;</span>)
  <span class="ruby-identifier">this_event</span> = {<span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">msg</span>, <span class="ruby-value">:timestamp</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sec_since_epoch</span>}
  <span class="ruby-identifier">@@log_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">this_event</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- log_to_buffer-source -->
          
        </div>

        

        
      </div><!-- log_to_buffer-method -->

    
      <div id="method-c-log_to_stdout" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">log_to_stdout</span><span
            class="method-args">(time, msg)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Logs and timestamps the given message to standard out. TODO(cgb): Examine
the performance impact of flushing stdout on every puts, which we do to
ensure that a message can be seen immediately.</p>
          

          
          <div class="method-source-code" id="log_to_stdout-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1093</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">log_to_stdout</span>(<span class="ruby-identifier">time</span>, <span class="ruby-identifier">msg</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{time}] #{msg}&quot;</span>
  <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- log_to_stdout-source -->
          
        </div>

        

        
      </div><!-- log_to_stdout-method -->

    
      <div id="method-c-neptune_parse_creds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">neptune_parse_creds</span><span
            class="method-args">(storage, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="neptune_parse_creds-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3405</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">neptune_parse_creds</span>(<span class="ruby-identifier">storage</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">creds</span> = {}

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">storage</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;s3&quot;</span>
    [<span class="ruby-string">'EC2_ACCESS_KEY'</span>, <span class="ruby-string">'EC2_SECRET_KEY'</span>, <span class="ruby-string">'S3_URL'</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">creds</span>[<span class="ruby-identifier">item</span>] = <span class="ruby-identifier">job_data</span>[<span class="ruby-node">&quot;@#{item}&quot;</span>]
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">creds</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- neptune_parse_creds-source -->
          
        </div>

        

        
      </div><!-- neptune_parse_creds-method -->

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new <a href="Djinn.html">Djinn</a>, which holds all the
information needed to configure and deploy all the services on this node.</p>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 342</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>()
  <span class="ruby-comment"># The password, or secret phrase, that is required for callers to access</span>
  <span class="ruby-comment"># methods exposed via SOAP.</span>
  <span class="ruby-identifier">@@secret</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_secret</span>()

  <span class="ruby-comment"># AppController logs (see self.log_debug) are printed to stdout for</span>
  <span class="ruby-comment"># immediate reading, and are buffered for delayed sending to Sisyphus, for</span>
  <span class="ruby-comment"># later viewing via web. </span>
  <span class="ruby-identifier">@@log_buffer</span> = <span class="ruby-constant">Queue</span>.<span class="ruby-identifier">new</span>

  <span class="ruby-ivar">@nodes</span> = []
  <span class="ruby-ivar">@my_index</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@creds</span> = {}
  <span class="ruby-ivar">@app_names</span> = []
  <span class="ruby-ivar">@apps_loaded</span> = []
  <span class="ruby-ivar">@kill_sig_received</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@done_initializing</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@done_loading</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@nginx_port</span> = <span class="ruby-constant">Nginx</span><span class="ruby-operator">::</span><span class="ruby-constant">START_PORT</span>
  <span class="ruby-ivar">@haproxy_port</span> = <span class="ruby-constant">HAProxy</span><span class="ruby-operator">::</span><span class="ruby-constant">START_PORT</span>
  <span class="ruby-ivar">@appengine_port</span> = <span class="ruby-value">20000</span>
  <span class="ruby-ivar">@userappserver_public_ip</span> = <span class="ruby-string">&quot;not-up-yet&quot;</span>
  <span class="ruby-ivar">@userappserver_private_ip</span> = <span class="ruby-string">&quot;not-up-yet&quot;</span>
  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;AppController just started&quot;</span>
  <span class="ruby-ivar">@total_boxes</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@num_appengines</span> = <span class="ruby-value">1</span>
  <span class="ruby-ivar">@restored</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@neptune_jobs</span> = {}
  <span class="ruby-ivar">@neptune_nodes</span> = []
  <span class="ruby-ivar">@api_status</span> = {}
  <span class="ruby-ivar">@queues_to_read</span> = []
  <span class="ruby-ivar">@registered_with_sisyphus</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@last_updated</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@app_info_map</span> = {}

  <span class="ruby-ivar">@scaling_in_progress</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@last_decision</span> = {}
  <span class="ruby-ivar">@initialized_apps</span> = {}
  <span class="ruby-ivar">@req_rate</span> = {}
  <span class="ruby-ivar">@req_in_queue</span> = {}
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-add_appserver_process" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_appserver_process</span><span
            class="method-args">(app)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts a new AppServer for the given application. TODO(cgb): This is mostly
copy-pasta’d from <a
href="Djinn.html#method-i-start_appengine">#start_appengine</a> -
consolidate this somehow</p>
          

          
          <div class="method-source-code" id="add_appserver_process-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3165</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_appserver_process</span>(<span class="ruby-identifier">app</span>)
  <span class="ruby-comment"># Starting a appserver instance on request to scale the application </span>
  <span class="ruby-ivar">@state</span> = <span class="ruby-node">&quot;Adding an AppServer for #{app}&quot;</span>

  <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)
  <span class="ruby-identifier">warmup_url</span> = <span class="ruby-string">&quot;/&quot;</span>

  <span class="ruby-identifier">app_data</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_app_data</span>(<span class="ruby-identifier">app</span>)
  
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Get app data for #{app} said [#{app_data}]&quot;</span>)

  <span class="ruby-identifier">loop</span> {
      <span class="ruby-identifier">app_version</span> = <span class="ruby-identifier">app_data</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rversion:(\d+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Waiting for app data to have instance info for app named #{app}: #{app_data} &quot;</span><span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;The app's version is #{app_version}, and its class is #{app_version.class}&quot;</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_data</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">4</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;Error&quot;</span>
        <span class="ruby-identifier">app_version</span> = <span class="ruby-string">&quot;0&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_version</span>.<span class="ruby-identifier">empty?</span>
        <span class="ruby-identifier">app_version</span> = <span class="ruby-constant">Integer</span>(<span class="ruby-identifier">app_version</span>)
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_version</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">app_data</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_app_data</span>(<span class="ruby-identifier">app</span>)
      <span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
   }
  
  <span class="ruby-identifier">app_version</span> = <span class="ruby-identifier">app_data</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rversion:(\d+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">app_language</span> = <span class="ruby-identifier">app_data</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rlanguage:(\w+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>

  <span class="ruby-identifier">app_is_enabled</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">does_app_exist?</span>(<span class="ruby-identifier">app</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;is app #{app} enabled? #{app_is_enabled}&quot;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_is_enabled</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;false&quot;</span>
    <span class="ruby-keyword">return</span>  
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">nginx_port</span> = <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:nginx</span>]
  <span class="ruby-identifier">haproxy_port</span> = <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:haproxy</span>]
  <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@appengine_port</span>

  <span class="ruby-identifier">app_number</span> = <span class="ruby-identifier">nginx_port</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Nginx</span><span class="ruby-operator">::</span><span class="ruby-constant">START_PORT</span>

  <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;port apps error contains - #{@app_info_map[app][:appengine]}&quot;</span>)
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">update_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>],
    <span class="ruby-identifier">my_public</span>)     

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Adding #{app_language} app #{app} on #{HelperFunctions.local_ip}:#{@appengine_port} &quot;</span>)
  <span class="ruby-identifier">xmpp_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">pid</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">run_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-ivar">@appengine_port</span>, <span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">get_load_balancer_ip</span>(), <span class="ruby-identifier">my_private</span>, <span class="ruby-identifier">app_version</span>, <span class="ruby-identifier">app_language</span>, <span class="ruby-identifier">nginx_port</span>, <span class="ruby-identifier">xmpp_ip</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">pid</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;ERROR: Unable to start application #{app} on port #{@appengine_port}.&quot;</span>) 
    <span class="ruby-keyword">next</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">pid_file_name</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/#{app}-#{@appengine_port}.pid&quot;</span>
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">pid_file_name</span>, <span class="ruby-identifier">pid</span>)

  <span class="ruby-identifier">location</span> = <span class="ruby-node">&quot;http://#{my_public}:#{@appengine_port}#{warmup_url}&quot;</span>
  <span class="ruby-identifier">wget_cmd</span> = <span class="ruby-node">&quot;wget #{WGET_OPTIONS} #{location}&quot;</span>
      
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">wget_cmd</span>)

  <span class="ruby-ivar">@appengine_port</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

  <span class="ruby-comment"># Nginx.reload </span>
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">restart</span>

  <span class="ruby-comment"># add_instance_info = uac.add_instance(app, my_public, @nginx_port)</span>
 
  <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>

  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">haproxy_location</span> = <span class="ruby-node">&quot;http://#{my_public}:#{haproxy_port}#{warmup_url}&quot;</span>
    <span class="ruby-identifier">nginx_location</span> = <span class="ruby-node">&quot;http://#{my_public}:#{nginx_port}#{warmup_url}&quot;</span>

    <span class="ruby-identifier">wget_haproxy</span> = <span class="ruby-node">&quot;wget #{WGET_OPTIONS} #{haproxy_location}&quot;</span>
    <span class="ruby-identifier">wget_nginx</span> = <span class="ruby-node">&quot;wget #{WGET_OPTIONS} #{nginx_location}&quot;</span>
 
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">wget_haproxy</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">wget_nginx</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_appserver_process-source -->
          
        </div>

        

        
      </div><!-- add_appserver_process-method -->

    
      <div id="method-i-add_role" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_role</span><span
            class="method-args">(new_role, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="add_role-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 938</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_role</span>(<span class="ruby-identifier">new_role</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># new roles may run indefinitely in the background, so don't block</span>
  <span class="ruby-comment"># on them - just fire and forget</span>
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">start_roles</span> = <span class="ruby-identifier">new_role</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
    <span class="ruby-identifier">start_roles</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># only start roles that we aren't already running</span>
      <span class="ruby-comment"># e.g., don't start_appengine if we already are, as this</span>
      <span class="ruby-comment"># will create two threads loading apps</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Already running role #{role}, not invoking again&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Adding and starting role #{role}&quot;</span>)
        <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">add_roles</span>(<span class="ruby-identifier">role</span>)
        <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;start_#{role}&quot;</span>.<span class="ruby-identifier">to_sym</span>)
      <span class="ruby-keyword">end</span>
    }
  }

  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;OK&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_role-source -->
          
        </div>

        

        
      </div><!-- add_role-method -->

    
      <div id="method-i-backup_appcontroller_state" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">backup_appcontroller_state</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="backup_appcontroller_state-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1441</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">backup_appcontroller_state</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Backing up AppController state to ZooKeeper&quot;</span>)
  <span class="ruby-identifier">state</span> = {<span class="ruby-string">'@@secret'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">@@secret</span> }

  <span class="ruby-identifier">instance_variables</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">v</span> = <span class="ruby-identifier">instance_variable_get</span>(<span class="ruby-identifier">k</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;@nodes&quot;</span>
      <span class="ruby-identifier">v</span> = <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">convert_location_class_to_array</span>(<span class="ruby-ivar">@nodes</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;@my_index&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;@api_status&quot;</span>
      <span class="ruby-comment"># Don't back up @my_index - it's a node-specific pointer that</span>
      <span class="ruby-comment"># indicates which node is &quot;our node&quot; and thus should be regenerated</span>
      <span class="ruby-comment"># via find_me_in_locations. Also don't worry about @api_status - it</span>
      <span class="ruby-comment"># can take up a lot of space and can easily be regenerated with new</span>
      <span class="ruby-comment"># data.</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">state</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>
  }

  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">write_appcontroller_state</span>(<span class="ruby-identifier">state</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Backed up AppController state to ZooKeeper&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- backup_appcontroller_state-source -->
          
        </div>

        

        
      </div><!-- backup_appcontroller_state-method -->

    
      <div id="method-i-change_job" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">change_job</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="change_job-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2038</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">change_job</span>()
  <span class="ruby-identifier">my_data</span> = <span class="ruby-identifier">my_node</span>
  <span class="ruby-identifier">jobs_to_run</span> = <span class="ruby-identifier">my_data</span>.<span class="ruby-identifier">jobs</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'ips'</span>]
    <span class="ruby-ivar">@total_boxes</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'ips'</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'min_images'</span>]
    <span class="ruby-ivar">@total_boxes</span> = <span class="ruby-constant">Integer</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">'min_images'</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Pre-loop: #{@nodes.join('\n')}&quot;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@total_boxes</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">spawn_and_setup_appengine</span>
    <span class="ruby-identifier">loop</span> {
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Looping: #{@nodes.join('\n')}&quot;</span>)
      <span class="ruby-ivar">@everyone_else_is_done</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@my_index</span>
          <span class="ruby-identifier">ip</span> = <span class="ruby-ivar">@nodes</span>[<span class="ruby-identifier">index</span>].<span class="ruby-identifier">private_ip</span>
          <span class="ruby-identifier">acc</span> = <span class="ruby-constant">AppControllerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">@@secret</span>)
          <span class="ruby-identifier">result</span> = <span class="ruby-identifier">acc</span>.<span class="ruby-identifier">is_done_initializing?</span>()
          <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;#{ip} returned #{result} (#{result.class})&quot;</span>)
          <span class="ruby-ivar">@everyone_else_is_done</span> = <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span>
        <span class="ruby-keyword">end</span>
      }
      <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@everyone_else_is_done</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Waiting on other nodes to come online&quot;</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">initialize_server</span>
  <span class="ruby-comment"># start_load_balancer </span>

  <span class="ruby-identifier">memcache_ips</span> = []
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">memcache_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_memcache?</span>
  }

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Memcache servers will be at #{memcache_ips.join(', ')}&quot;</span>)

  <span class="ruby-identifier">memcache_file</span> = <span class="ruby-string">&quot;/etc/appscale/memcache_ips&quot;</span>
  <span class="ruby-identifier">memcache_contents</span> = <span class="ruby-identifier">memcache_ips</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">memcache_file</span>, <span class="ruby-identifier">memcache_contents</span>)

  <span class="ruby-identifier">setup_config_files</span>
  <span class="ruby-identifier">set_uaserver_ips</span> 
  <span class="ruby-identifier">write_hypersoap</span>

  <span class="ruby-comment"># ejabberd uses uaserver for authentication</span>
  <span class="ruby-comment"># so start it after we find out the uaserver's ip</span>

  <span class="ruby-identifier">start_ejabberd</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_login?</span>

  <span class="ruby-ivar">@done_initializing</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-comment"># start zookeeper</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_zookeeper?</span>
    <span class="ruby-identifier">configure_zookeeper</span>(<span class="ruby-ivar">@nodes</span>, <span class="ruby-ivar">@my_index</span>)
    <span class="ruby-identifier">init</span> = <span class="ruby-operator">!</span>(<span class="ruby-ivar">@creds</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;keep_zookeeper_data&quot;</span>))
    <span class="ruby-identifier">start_zookeeper</span>(<span class="ruby-identifier">init</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">init</span>(<span class="ruby-identifier">my_node</span>, <span class="ruby-ivar">@nodes</span>)

  <span class="ruby-identifier">commands</span> = {
    <span class="ruby-string">&quot;load_balancer&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;start_load_balancer&quot;</span>,
    <span class="ruby-string">&quot;memcache&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;start_memcache&quot;</span>,
    <span class="ruby-string">&quot;db_master&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;start_db_master&quot;</span>,
    <span class="ruby-string">&quot;db_slave&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;start_db_slave&quot;</span>
  }

  <span class="ruby-identifier">jobs_to_run</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">job</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">commands</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">job</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;About to run [#{commands[job]}]&quot;</span>)
      <span class="ruby-identifier">send</span>(<span class="ruby-identifier">commands</span>[<span class="ruby-identifier">job</span>].<span class="ruby-identifier">to_sym</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># create initial tables</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_db_master?</span> <span class="ruby-operator">||</span> (<span class="ruby-keyword">defined?</span>(<span class="ruby-identifier">is_priming_needed?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">is_priming_needed?</span>(<span class="ruby-identifier">my_node</span>))) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">restore_from_db?</span>
    <span class="ruby-identifier">table</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]
    <span class="ruby-identifier">prime_script</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppDB/#{table}/prime_#{table}.py&quot;</span>
    <span class="ruby-identifier">retries</span> = <span class="ruby-value">10</span>
    <span class="ruby-identifier">retval</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">retries</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">replication</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;replication&quot;</span>]
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;MASTER_IP='localhost' LOCAL_DB_IP='localhost' python2.6 #{prime_script} #{replication}; echo $? &gt; /tmp/retval&quot;</span>)
      <span class="ruby-identifier">retval</span> = <span class="ruby-value">%xcat /tmp/retval`</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">retval</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Fail to create initial table. Retry #{retries} times.&quot;</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-identifier">retries</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">retval</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Fail to create initial table. Could not startup AppScale.&quot;</span>)
      <span class="ruby-identifier">exit</span>(<span class="ruby-value">1</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># start soap server and pb server</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_soap_server?</span>(<span class="ruby-identifier">my_node</span>)
    <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Starting up SOAP Server and PBServer&quot;</span>
    <span class="ruby-identifier">start_pbserver</span>
    <span class="ruby-identifier">start_soap_server</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">local_ip</span>, <span class="ruby-constant">UserAppClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SERVER_PORT</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">start_blobstore_server</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_rabbitmq_master?</span>
    <span class="ruby-identifier">start_rabbitmq_master</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_rabbitmq_slave?</span>
    <span class="ruby-identifier">start_rabbitmq_slave</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># for neptune jobs, start a place where they can save output to</span>
  <span class="ruby-comment"># also, since repo does health checks on the app engine apis, start it up there too</span>

  <span class="ruby-identifier">repo_ip</span> = <span class="ruby-identifier">get_shadow</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">repo_private_ip</span> = <span class="ruby-identifier">get_shadow</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">repo_ip</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
  <span class="ruby-identifier">repo_private_ip</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
  <span class="ruby-constant">Repo</span>.<span class="ruby-identifier">init</span>(<span class="ruby-identifier">repo_ip</span>, <span class="ruby-identifier">repo_private_ip</span>,  <span class="ruby-identifier">@@secret</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_shadow?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
    <span class="ruby-identifier">start_sisyphus</span>
    <span class="ruby-constant">Repo</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-ivar">@userappserver_private_ip</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># TODO(cgb): replace this with something more generic, in case other neptune</span>
  <span class="ruby-comment"># jobs need it down the road</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_babel_slave?</span>
    <span class="ruby-identifier">start_babel_slave</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># appengine is started elsewhere</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- change_job-source -->
          
        </div>

        

        
      </div><!-- change_job-method -->

    
      <div id="method-i-convert_fqdns_to_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_fqdns_to_ips</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If running in a cloud environment, we may be dealing with public and
private FQDNs instead of IP addresses, which makes it hard to find out
which node is our node (since we find our node by IP). This method looks
through all the nodes we currently know of and converts any private FQDNs
we see to private IPs.</p>
          

          
          <div class="method-source-code" id="convert_fqdns_to_ips-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1956</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">convert_fqdns_to_ips</span>()
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_cloud?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;In a cloud deployment, so converting FQDNs -&gt; IPs&quot;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Not in a cloud deployment, so not converting FQDNs -&gt; IPs&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;hostname&quot;</span>] <span class="ruby-operator">=~</span> <span class="ruby-node">%r#{FQDN_REGEX}/</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;hostname&quot;</span>] = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;hostname&quot;</span>])
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Failed to convert main hostname #{@creds['hostname']} to public, might want to look into this?&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># Resolve the private FQDN to a private IP, but don't resolve the public</span>
    <span class="ruby-comment"># FQDN, as that will just resolve to the private IP.</span>

    <span class="ruby-identifier">pri</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pri</span> <span class="ruby-operator">=~</span> <span class="ruby-node">%r#{FQDN_REGEX}/</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">pri</span>)
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;This node has public ip #{node.public_ip} and private ip #{node.private_ip}&quot;</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- convert_fqdns_to_ips-source -->
          
        </div>

        

        
      </div><!-- convert_fqdns_to_ips-method -->

    
      <div id="method-i-copy_app_to_local" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_app_to_local</span><span
            class="method-args">(appname)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns true on success, false otherwise</p>
          

          
          <div class="method-source-code" id="copy_app_to_local-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3337</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_app_to_local</span>(<span class="ruby-identifier">appname</span>)
  <span class="ruby-identifier">app_dir</span> = <span class="ruby-node">&quot;/var/apps/#{appname}/app&quot;</span>
  <span class="ruby-identifier">app_path</span> = <span class="ruby-node">&quot;#{app_dir}/#{appname}.tar.gz&quot;</span>

  <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">app_path</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;I already have a copy of app #{appname} - won't grab it remotely&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;I don't have a copy of app #{appname} - will grab it remotely&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">nodes_with_app</span> = []
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">nodes_with_app</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_app_hosters</span>(<span class="ruby-identifier">appname</span>)
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">nodes_with_app</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Waiting for a node to have a copy of app #{appname}&quot;</span>)
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
  }

  <span class="ruby-comment"># Try 3 times on each node known to have this application</span>
  <span class="ruby-identifier">nodes_with_app</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">ssh_key</span>
    <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-identifier">tries</span> = <span class="ruby-value">3</span>
    <span class="ruby-identifier">loop</span> {
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Trying #{ip}:#{app_path} for the application&quot;</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;scp -o StrictHostkeyChecking=no -i #{ssh_key} #{ip}:#{app_path} #{app_path}&quot;</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-node">&quot;#{app_path}&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Got a copy of #{appname} from #{ip}&quot;</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> 
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;ERROR: Unable to get the application from #{ip}:#{app_path}! scp failed.&quot;</span>) 
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">tries</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Trying again in 5 seconds&quot;</span>) 
        <span class="ruby-identifier">tries</span> = <span class="ruby-identifier">tries</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
        <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Giving up on node #{ip} for the application&quot;</span>)
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
    }
  }
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Unable to get the application from any node&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> 
<span class="ruby-keyword">end</span></pre>
          </div><!-- copy_app_to_local-source -->
          
        </div>

        

        
      </div><!-- copy_app_to_local-method -->

    
      <div id="method-i-copy_encryption_keys" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_encryption_keys</span><span
            class="method-args">(dest_node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="copy_encryption_keys-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2375</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_encryption_keys</span>(<span class="ruby-identifier">dest_node</span>)
  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">ssh_key</span>

  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-constant">SSH_PORT</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">3</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;ec2&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;hybrid&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;euca&quot;</span>
    <span class="ruby-identifier">options</span> = <span class="ruby-string">&quot;-o StrictHostkeyChecking=no -o NumberOfPasswordPrompts=0&quot;</span>
    <span class="ruby-identifier">enable_root_login</span> = <span class="ruby-string">&quot;sudo cp /home/ubuntu/.ssh/authorized_keys /root/.ssh/&quot;</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;ssh -i #{ssh_key} #{options} 2&gt;&amp;1 ubuntu@#{ip} '#{enable_root_login}'&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">secret_key_loc</span> = <span class="ruby-string">&quot;/etc/appscale/secret.key&quot;</span>
  <span class="ruby-identifier">cert_loc</span> = <span class="ruby-string">&quot;/etc/appscale/certs/mycert.pem&quot;</span>
  <span class="ruby-identifier">key_loc</span> = <span class="ruby-string">&quot;/etc/appscale/certs/mykey.pem&quot;</span>

  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">secret_key_loc</span>, <span class="ruby-identifier">secret_key_loc</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">cert_loc</span>, <span class="ruby-identifier">cert_loc</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">key_loc</span>, <span class="ruby-identifier">key_loc</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)

  <span class="ruby-comment"># TODO: should be able to merge these together</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_hybrid_cloud?</span>
    <span class="ruby-identifier">cloud_num</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">loop</span> {
      <span class="ruby-identifier">cloud_type</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-node">&quot;CLOUD#{cloud_num}_TYPE&quot;</span>]
      <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cloud_type</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">cloud_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>
      <span class="ruby-identifier">cloud_keys_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-node">&quot;/etc/appscale/keys/cloud#{cloud_num}&quot;</span>)
      <span class="ruby-identifier">make_dir</span> = <span class="ruby-node">&quot;mkdir -p #{cloud_keys_dir}&quot;</span>

      <span class="ruby-identifier">keyname</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
      <span class="ruby-identifier">cloud_ssh_key</span> = <span class="ruby-node">&quot;#{cloud_keys_dir}/#{keyname}.key&quot;</span>
      <span class="ruby-identifier">cloud_private_key</span> = <span class="ruby-node">&quot;#{cloud_keys_dir}/mykey.pem&quot;</span>
      <span class="ruby-identifier">cloud_cert</span> = <span class="ruby-node">&quot;#{cloud_keys_dir}/mycert.pem&quot;</span>

      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">run_remote_command</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">make_dir</span>, <span class="ruby-identifier">ssh_key</span>, <span class="ruby-constant">NO_OUTPUT</span>)
      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">cloud_ssh_key</span>, <span class="ruby-identifier">cloud_ssh_key</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">cloud_private_key</span>, <span class="ruby-identifier">cloud_private_key</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">cloud_cert</span>, <span class="ruby-identifier">cloud_cert</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
      <span class="ruby-identifier">cloud_num</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">cloud_keys_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&quot;/etc/appscale/keys/cloud1&quot;</span>)
    <span class="ruby-identifier">make_dir</span> = <span class="ruby-node">&quot;mkdir -p #{cloud_keys_dir}&quot;</span>

    <span class="ruby-identifier">cloud_private_key</span> = <span class="ruby-node">&quot;#{cloud_keys_dir}/mykey.pem&quot;</span>
    <span class="ruby-identifier">cloud_cert</span> = <span class="ruby-node">&quot;#{cloud_keys_dir}/mycert.pem&quot;</span>

    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">run_remote_command</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">make_dir</span>, <span class="ruby-identifier">ssh_key</span>, <span class="ruby-constant">NO_OUTPUT</span>)
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">ssh_key</span>, <span class="ruby-identifier">ssh_key</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">cloud_private_key</span>, <span class="ruby-identifier">cloud_private_key</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">cloud_cert</span>, <span class="ruby-identifier">cloud_cert</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- copy_encryption_keys-source -->
          
        </div>

        

        
      </div><!-- copy_encryption_keys-method -->

    
      <div id="method-i-done_uploading" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">done_uploading</span><span
            class="method-args">(appname, location, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="done_uploading-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 905</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">done_uploading</span>(<span class="ruby-identifier">appname</span>, <span class="ruby-identifier">location</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">location</span>)
    <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">add_app_entry</span>(<span class="ruby-identifier">appname</span>, <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">serialize</span>, <span class="ruby-identifier">location</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-string">&quot;success&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-node">&quot;The #{appname} app was not found at #{location}.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">result</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- done_uploading-source -->
          
        </div>

        

        
      </div><!-- done_uploading-method -->

    
      <div id="method-i-ensure_all_roles_are_running" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_all_roles_are_running</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Each node has a responsibility to check up on other nodes and make sure
they are still running, and if not, to remedy it somehow. Returns an Array
of the roles that this process started.</p>
          

          
          <div class="method-source-code" id="ensure_all_roles_are_running-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1804</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_all_roles_are_running</span>
  <span class="ruby-comment"># Open nodes should be given priority to take on roles from other nodes.</span>
  <span class="ruby-comment"># if my node isnt open and there are open nodes, return</span>
  <span class="ruby-comment">#are_open_nodes = false</span>
  <span class="ruby-comment">#@nodes.each { |node|</span>
  <span class="ruby-comment">#  if node.is_open?</span>
  <span class="ruby-comment">#    are_open_nodes = true</span>
  <span class="ruby-comment">#    break</span>
  <span class="ruby-comment">#  end</span>
  <span class="ruby-comment">#}</span>

  <span class="ruby-comment">#if !my_node.is_open? and are_open_nodes</span>
  <span class="ruby-comment">#  Djinn.log_debug(&quot;My node isn't open and other nodes are, so deferring &quot; +</span>
  <span class="ruby-comment">#    &quot;cloud healing to other nodes&quot;)</span>
  <span class="ruby-comment">#  return []</span>
  <span class="ruby-comment">#end</span>

  <span class="ruby-identifier">roles_to_add</span> = []
  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">lock_and_run</span> {
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Seeing if other roles need to be taken over&quot;</span>)

    <span class="ruby-identifier">ip_info</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_ip_info</span>()
    <span class="ruby-identifier">ip_info</span>[<span class="ruby-string">'ips'</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Looking at roles for IP #{ip}&quot;</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">is_node_done_loading?</span>(<span class="ruby-identifier">ip</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Node at IP #{ip} is not done loading yet, &quot;</span> <span class="ruby-operator">+</span>
          <span class="ruby-string">&quot;skipping...&quot;</span>)
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">is_node_live?</span>(<span class="ruby-identifier">ip</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Node at IP #{ip} appears to be up, skipping...&quot;</span>)
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Node at IP #{ip} has failed&quot;</span>)
          <span class="ruby-identifier">failed_job_data</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_job_data_for_ip</span>(<span class="ruby-identifier">ip</span>)
          <span class="ruby-identifier">failed_node</span> = <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">failed_job_data</span>)
          <span class="ruby-identifier">roles_to_add</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">failed_node</span>.<span class="ruby-identifier">jobs</span>

          <span class="ruby-identifier">instances_to_delete</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_app_instances_for_ip</span>(<span class="ruby-identifier">ip</span>)
          <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)
          <span class="ruby-identifier">instances_to_delete</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">instance</span><span class="ruby-operator">|</span>
            <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Deleting app instance for app &quot;</span> <span class="ruby-operator">+</span>
              <span class="ruby-node">&quot;#{instance['app_name']} located at #{instance['ip']}:&quot;</span> <span class="ruby-operator">+</span>
              <span class="ruby-node">&quot;#{instance['port']}&quot;</span>)
            <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">delete_instance</span>(<span class="ruby-identifier">instance</span>[<span class="ruby-string">'app_name'</span>], <span class="ruby-identifier">instance</span>[<span class="ruby-string">'ip'</span>], 
              <span class="ruby-identifier">instance</span>[<span class="ruby-string">'port'</span>])
          }

          <span class="ruby-identifier">remove_node_from_local_and_zookeeper</span>(<span class="ruby-identifier">ip</span>)
          <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Will recover [#{failed_node.jobs.join(', ')}] &quot;</span> <span class="ruby-operator">+</span>
            <span class="ruby-node">&quot; roles that were being run by the failed node at #{ip}&quot;</span>)
      <span class="ruby-keyword">end</span>
    }

    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">roles_to_add</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">start_new_roles_on_nodes</span>(<span class="ruby-identifier">roles_to_add</span>, <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'instance_type'</span>],
        <span class="ruby-identifier">@@secret</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Releasing ZK lock to see if other roles need to be &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;taken over&quot;</span>)
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">roles_to_add</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ensure_all_roles_are_running-source -->
          
        </div>

        

        
      </div><!-- ensure_all_roles_are_running-method -->

    
      <div id="method-i-find_me_in_locations" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_me_in_locations</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Searches through @nodes to try to find out which node is ours. Strictly
speaking, we assume that our node is identifiable by private IP.</p>
          

          
          <div class="method-source-code" id="find_me_in_locations-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1992</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_me_in_locations</span>()
  <span class="ruby-ivar">@my_index</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Searching for node index for #{HelperFunctions.local_ip}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;@nodes is #{@nodes.join(', ')}&quot;</span>)
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Am I #{@nodes[index].private_ip}?&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@nodes</span>[<span class="ruby-identifier">index</span>].<span class="ruby-identifier">private_ip</span> <span class="ruby-operator">==</span> <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">local_ip</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Yes!&quot;</span>)
      <span class="ruby-ivar">@my_index</span> = <span class="ruby-identifier">index</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;No...&quot;</span>)
  }
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@my_index</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;I am lost, could not find my node&quot;</span>) 
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_me_in_locations-source -->
          
        </div>

        

        
      </div><!-- find_me_in_locations-method -->

    
      <div id="method-i-get_all_appengine_nodes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_all_appengine_nodes</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_all_appengine_nodes-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1210</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_all_appengine_nodes</span>()
  <span class="ruby-identifier">ae_nodes</span> = []
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_appengine?</span>
      <span class="ruby-identifier">ae_nodes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ae_nodes</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_all_appengine_nodes-source -->
          
        </div>

        

        
      </div><!-- get_all_appengine_nodes-method -->

    
      <div id="method-i-get_all_public_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_all_public_ips</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_all_public_ips-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 746</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_all_public_ips</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">public_ips</span> = []
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">public_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>
  }
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;All public ips are [#{public_ips.join(', ')}]&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">public_ips</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_all_public_ips-source -->
          
        </div>

        

        
      </div><!-- get_all_public_ips-method -->

    
      <div id="method-i-get_db_master" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_db_master</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_db_master-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1171</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_db_master</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_db_master?</span>
  }

  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;No db master nodes found.&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_db_master-source -->
          
        </div>

        

        
      </div><!-- get_db_master-method -->

    
      <div id="method-i-get_load_balancer_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_load_balancer_ip</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_load_balancer_ip-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1220</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_load_balancer_ip</span>()
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_load_balancer?</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_load_balancer_ip-source -->
          
        </div>

        

        
      </div><!-- get_load_balancer_ip-method -->

    
      <div id="method-i-get_login" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_login</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_login-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1155</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_login</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_login?</span>
  }

  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;No login nodes found.&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_login-source -->
          
        </div>

        

        
      </div><!-- get_login-method -->

    
      <div id="method-i-get_online_users_list" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_online_users_list</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_online_users_list-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 887</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_online_users_list</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">online_users</span> = []

  <span class="ruby-identifier">login_node</span> = <span class="ruby-identifier">get_login</span>
  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">login_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">key</span> = <span class="ruby-identifier">login_node</span>.<span class="ruby-identifier">ssh_key</span>
  <span class="ruby-identifier">raw_list</span> = <span class="ruby-node">%xssh -i #{key} -o StrictHostkeyChecking=no root@#{ip} 'ejabberdctl connected-users'`</span>
  <span class="ruby-identifier">raw_list</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;\n&quot;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">userdata</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">online_users</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">userdata</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;/&quot;</span>)[<span class="ruby-value">0</span>]
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">online_users</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_online_users_list-source -->
          
        </div>

        

        
      </div><!-- get_online_users_list-method -->

    
      <div id="method-i-get_public_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_public_ip</span><span
            class="method-args">(private_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_public_ip-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1288</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_public_ip</span>(<span class="ruby-identifier">private_ip</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_cloud?</span>
  
  <span class="ruby-identifier">keyname</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
  <span class="ruby-identifier">infrastructure</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>]    

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_hybrid_cloud?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Getting hybrid ips with creds #{@creds.inspect}&quot;</span>)
    <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_hybrid_ips</span>(<span class="ruby-ivar">@creds</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Getting cloud ips for #{infrastructure} with keyname &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{keyname}&quot;</span>)
    <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_cloud_ips</span>(<span class="ruby-identifier">infrastructure</span>, 
      <span class="ruby-identifier">keyname</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Public ips are #{public_ips.join(', ')}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Private ips are #{private_ips.join(', ')}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Looking for #{private_ip}&quot;</span>)

  <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">node_private_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">private_ips</span>[<span class="ruby-identifier">index</span>])
    <span class="ruby-identifier">node_public_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">public_ips</span>[<span class="ruby-identifier">index</span>])

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node_private_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">node_public_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">private_ip</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Mapped private ip #{private_ip} to public ip &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;#{public_ips[index]}&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">public_ips</span>[<span class="ruby-identifier">index</span>]
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">unable_to_convert_msg</span> = <span class="ruby-string">&quot;[get public ip] Couldn't convert private IP &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;#{private_ip} to a public address. Public IPs are &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;[#{public_ips.join(', ')}], private IPs are [#{private_ips.join(', ')}]&quot;</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">unable_to_convert_msg</span>)
  <span class="ruby-identifier">abort</span>(<span class="ruby-identifier">unable_to_convert_msg</span>)  
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_public_ip-source -->
          
        </div>

        

        
      </div><!-- get_public_ip-method -->

    
      <div id="method-i-get_role_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_role_info</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>A SOAP-exposed method that callers can use to get information about what
roles each node in the AppScale deployment are running.</p>
          

          
          <div class="method-source-code" id="get_role_info-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 409</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_role_info</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">all_nodes</span> = []
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">all_nodes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">to_hash</span>()
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">all_nodes</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_role_info-source -->
          
        </div>

        

        
      </div><!-- get_role_info-method -->

    
      <div id="method-i-get_scaling_info_for_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_scaling_info_for_app</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Queries haproxy to see how many requests are queued for a given application
and how many requests are served at a given time. Based on this
information, this method reports whether or not AppServers should be added,
removed, or if no changes are needed.</p>
          

          
          <div class="method-source-code" id="get_scaling_info_for_app-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3044</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_scaling_info_for_app</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-identifier">autoscale_log</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">AUTOSCALE_LOG_FILE</span>, <span class="ruby-string">&quot;a+&quot;</span>)
  <span class="ruby-identifier">autoscale_log</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;Getting scaling info for application #{app_name}&quot;</span>)

  <span class="ruby-comment"># Average Request rates and queued requests set to 0</span>
  <span class="ruby-identifier">avg_req_rate</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">avg_req_in_queue</span> = <span class="ruby-value">0</span>

  <span class="ruby-comment"># Move all the old data over one spot in our arrays (basically making</span>
  <span class="ruby-comment"># these rotating buffers) and see the average number of requests received</span>
  <span class="ruby-comment"># and enqueued from the old data</span>
  (<span class="ruby-constant">NUM_DATA_POINTS</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>).<span class="ruby-identifier">times</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-ivar">@req_rate</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span>] = <span class="ruby-ivar">@req_rate</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>]
    <span class="ruby-ivar">@req_in_queue</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span>] = <span class="ruby-ivar">@req_in_queue</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>]
    <span class="ruby-identifier">avg_req_rate</span> <span class="ruby-operator">+=</span> <span class="ruby-ivar">@req_rate</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">avg_req_in_queue</span> <span class="ruby-operator">+=</span> <span class="ruby-ivar">@req_in_queue</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
  }

  <span class="ruby-comment"># Now see how many requests came in for our app and how many are enqueued</span>
  <span class="ruby-identifier">monitor_cmd</span> = <span class="ruby-string">&quot;echo \&quot;show info;show stat\&quot; | &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;socat stdio unix-connect:/etc/haproxy/stats | grep #{app_name}&quot;</span>

  <span class="ruby-node">%x#{monitor_cmd}`</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">parsed_info</span> = <span class="ruby-identifier">line</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">','</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">parsed_info</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">REQ_RATE_INDEX</span>  <span class="ruby-comment"># not a line with request info</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">service_name</span> = <span class="ruby-identifier">parsed_info</span>[<span class="ruby-constant">SERVICE_NAME_INDEX</span>]
    <span class="ruby-identifier">req_in_queue_present</span> = <span class="ruby-identifier">parsed_info</span>[<span class="ruby-constant">REQ_IN_QUEUE_INDEX</span>]
    <span class="ruby-identifier">req_rate_present</span> = <span class="ruby-identifier">parsed_info</span>[<span class="ruby-constant">REQ_RATE_INDEX</span>]
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">service_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;FRONTEND&quot;</span>
      <span class="ruby-identifier">autoscale_log</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;#{service_name} Request Rate #{req_rate_present}&quot;</span>)
      <span class="ruby-identifier">req_rate_present</span> = <span class="ruby-identifier">parsed_info</span>[<span class="ruby-constant">REQ_RATE_INDEX</span>]
      <span class="ruby-identifier">avg_req_rate</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">req_rate_present</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-ivar">@req_rate</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-constant">NUM_DATA_POINTS</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>] = <span class="ruby-identifier">req_rate_present</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">service_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;BACKEND&quot;</span>
      <span class="ruby-identifier">autoscale_log</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;#{service_name} Queued Currently &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;#{req_in_queue_present}&quot;</span>)
      <span class="ruby-identifier">req_in_queue_present</span> = <span class="ruby-identifier">parsed_info</span>[<span class="ruby-constant">REQ_IN_QUEUE_INDEX</span>]
      <span class="ruby-identifier">avg_req_in_queue</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">req_in_queue_present</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-ivar">@req_in_queue</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-constant">NUM_DATA_POINTS</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>] = <span class="ruby-identifier">req_in_queue_present</span>
    <span class="ruby-keyword">end</span>
  }
    
  <span class="ruby-identifier">total_req_in_queue</span> = <span class="ruby-identifier">avg_req_in_queue</span>

  <span class="ruby-identifier">avg_req_rate</span> <span class="ruby-operator">/=</span> <span class="ruby-constant">NUM_DATA_POINTS</span>
  <span class="ruby-identifier">avg_req_in_queue</span> <span class="ruby-operator">/=</span> <span class="ruby-constant">NUM_DATA_POINTS</span>

  <span class="ruby-identifier">autoscale_log</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;[#{app_name}] Average Request rate: #{avg_req_rate}&quot;</span>)
  <span class="ruby-identifier">autoscale_log</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;[#{app_name}] Average Queued requests: &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;#{avg_req_in_queue}&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">avg_req_rate</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SCALEDOWN_REQUEST_RATE_THRESHOLD</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-identifier">total_req_in_queue</span>.<span class="ruby-identifier">zero?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:scale_down</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">avg_req_rate</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">SCALEUP_REQUEST_RATE_THRESHOLD</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-identifier">avg_req_in_queue</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">SCALEUP_QUEUE_SIZE_THRESHOLD</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:scale_up</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-value">:no_change</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_scaling_info_for_app-source -->
          
        </div>

        

        
      </div><!-- get_scaling_info_for_app-method -->

    
      <div id="method-i-get_shadow" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_shadow</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_shadow-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_shadow</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_shadow?</span>
  }

  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;No shadow nodes found.&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_shadow-source -->
          
        </div>

        

        
      </div><!-- get_shadow-method -->

    
      <div id="method-i-get_stats" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_stats</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_stats-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 610</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">usage</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_usage</span>
  <span class="ruby-identifier">mem</span> = <span class="ruby-identifier">sprintf</span>(<span class="ruby-string">&quot;%3.2f&quot;</span>, <span class="ruby-identifier">usage</span>[<span class="ruby-string">'mem'</span>])

  <span class="ruby-identifier">jobs</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">jobs</span> <span class="ruby-keyword">or</span> [<span class="ruby-string">&quot;none&quot;</span>]
  <span class="ruby-comment"># don't use an actual % below, or it will cause a string format exception</span>
  <span class="ruby-identifier">stats</span> = {
    <span class="ruby-string">'ip'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>,
    <span class="ruby-string">'cpu'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">usage</span>[<span class="ruby-string">'cpu'</span>],
    <span class="ruby-string">'memory'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">mem</span>,
    <span class="ruby-string">'disk'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">usage</span>[<span class="ruby-string">'disk'</span>],
    <span class="ruby-string">'roles'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">jobs</span>,
    <span class="ruby-string">'db_location'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@userappserver_public_ip</span>,
    <span class="ruby-string">'cloud'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">cloud</span>,
    <span class="ruby-string">'state'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@state</span>
  }

  <span class="ruby-identifier">stats</span>[<span class="ruby-string">'apps'</span>] = {}
  <span class="ruby-ivar">@app_names</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">stats</span>[<span class="ruby-string">'apps'</span>][<span class="ruby-identifier">name</span>] = <span class="ruby-ivar">@apps_loaded</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">stats</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_stats-source -->
          
        </div>

        

        
      </div><!-- get_stats-method -->

    
      <div id="method-i-get_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_status</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_status-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1327</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_status</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">ssh_key</span>
  <span class="ruby-identifier">acc</span> = <span class="ruby-constant">AppControllerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">@@secret</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">acc</span>.<span class="ruby-identifier">is_done_loading?</span>()
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Node at #{ip} is not done loading yet - will try &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;again later.&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">acc</span>.<span class="ruby-identifier">get_status</span>(<span class="ruby-identifier">ok_to_fail</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;#{ip} returned [#{result}] - class is #{result.class}&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;#{ip} returned false - is it not running?&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">status_file</span> = <span class="ruby-node">&quot;/etc/appscale/status-#{ip}.json&quot;</span>
  <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">acc</span>.<span class="ruby-identifier">get_stats</span>()
  <span class="ruby-identifier">json_state</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">stats</span>) 
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">status_file</span>, <span class="ruby-identifier">json_state</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_login?</span>
    <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">private_ip</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">status_file</span>, <span class="ruby-identifier">status_file</span>, <span class="ruby-identifier">login_ip</span>, <span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># copy remote log over - handy for debugging</span>
  <span class="ruby-identifier">local_log</span> = <span class="ruby-node">&quot;/etc/appscale/logs/#{ip}.log&quot;</span>
  <span class="ruby-identifier">remote_log</span> = <span class="ruby-string">&quot;/tmp/*.log&quot;</span>

  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-string">&quot;/etc/appscale/logs/&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;scp -o StrictHostkeyChecking=no -i #{ssh_key} #{ip}:#{remote_log} #{local_log}&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_status-source -->
          
        </div>

        

        
      </div><!-- get_status-method -->

    
      <div id="method-i-got_all_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">got_all_data</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="got_all_data-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1943</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">got_all_data</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@nodes</span> <span class="ruby-operator">==</span> []
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span> <span class="ruby-operator">==</span> {}
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">==</span> []
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- got_all_data-source -->
          
        </div>

        

        
      </div><!-- got_all_data-method -->

    
      <div id="method-i-initialize_node" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_node</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="initialize_node-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2349</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize_node</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">copy_encryption_keys</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">validate_image</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">restore_db_state_if_needed</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">rsync_files</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">start_appcontroller</span>(<span class="ruby-identifier">node</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- initialize_node-source -->
          
        </div>

        

        
      </div><!-- initialize_node-method -->

    
      <div id="method-i-initialize_nodes_in_parallel" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_nodes_in_parallel</span><span
            class="method-args">(node_info)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="initialize_nodes_in_parallel-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2338</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize_nodes_in_parallel</span>(<span class="ruby-identifier">node_info</span>)
  <span class="ruby-identifier">threads</span> = []
  <span class="ruby-identifier">node_info</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">slave</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">threads</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { 
      <span class="ruby-identifier">initialize_node</span>(<span class="ruby-identifier">slave</span>)
    }
  }

  <span class="ruby-identifier">threads</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">join</span> }
<span class="ruby-keyword">end</span></pre>
          </div><!-- initialize_nodes_in_parallel-source -->
          
        </div>

        

        
      </div><!-- initialize_nodes_in_parallel-method -->

    
      <div id="method-i-initialize_scaling_info_for_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_scaling_info_for_app</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets up information about the request rate and number of requests in
haproxy’s queue for the given application.</p>
          

          
          <div class="method-source-code" id="initialize_scaling_info_for_app-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2986</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize_scaling_info_for_app</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@initialized_apps</span>[<span class="ruby-identifier">app_name</span>]

  <span class="ruby-ivar">@req_rate</span>[<span class="ruby-identifier">app_name</span>] = []
  <span class="ruby-ivar">@req_in_queue</span>[<span class="ruby-identifier">app_name</span>] = []

  <span class="ruby-comment"># Fill in req_rate and req_in_queue with dummy info for now</span>
  <span class="ruby-constant">NUM_DATA_POINTS</span>.<span class="ruby-identifier">times</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-ivar">@req_rate</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span>] = <span class="ruby-value">0</span>
    <span class="ruby-ivar">@req_in_queue</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-identifier">i</span>] = <span class="ruby-value">0</span>
  }

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@last_decision</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">app_name</span>)
    <span class="ruby-ivar">@last_decision</span>[<span class="ruby-identifier">app_name</span>] = <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@initialized_apps</span>[<span class="ruby-identifier">app_name</span>] = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- initialize_scaling_info_for_app-source -->
          
        </div>

        

        
      </div><!-- initialize_scaling_info_for_app-method -->

    
      <div id="method-i-initialize_server" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_server</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Perform any necessary initialization steps before we begin starting up
services</p>
          

          
          <div class="method-source-code" id="initialize_server-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2578</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize_server</span>
  <span class="ruby-identifier">my_public_ip</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">head_node_ip</span> = <span class="ruby-identifier">get_public_ip</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">'hostname'</span>])

  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">initialize_config</span>
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">initialize_config</span>
  <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">initialize_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">head_node_ip</span>)
  <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">reset</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- initialize_server-source -->
          
        </div>

        

        
      </div><!-- initialize_server-method -->

    
      <div id="method-i-is_app_running" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_app_running</span><span
            class="method-args">(appname, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_app_running-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 921</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_app_running</span>(<span class="ruby-identifier">appname</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">hosters</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_app_hosters</span>(<span class="ruby-identifier">appname</span>)
  <span class="ruby-identifier">hosters_w_appengine</span> = []
  <span class="ruby-identifier">hosters</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">hosters_w_appengine</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_appengine?</span>
  }
 
  <span class="ruby-identifier">app_running</span> = <span class="ruby-operator">!</span><span class="ruby-identifier">hosters_w_appengine</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Is app #{appname} running? #{app_running}&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">app_running</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_app_running-source -->
          
        </div>

        

        
      </div><!-- is_app_running-method -->

    
      <div id="method-i-is_cloud-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_cloud?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_cloud-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2275</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_cloud?</span>
  <span class="ruby-operator">!</span><span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>].<span class="ruby-identifier">nil?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_cloud-3F-source -->
          
        </div>

        

        
      </div><!-- is_cloud-3F-method -->

    
      <div id="method-i-is_cpu_or_mem_maxed_out-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_cpu_or_mem_maxed_out?</span><span
            class="method-args">(language)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Looks at how much CPU and memory is being used system-wide, to determine if
a new AppServer should be added. As AppServers in different languages
consume different amounts of CPU and memory, we consult the global
variables that indicate what the maximum CPU and memory limits are for a
new AppServer in the given language.</p>
          

          
          <div class="method-source-code" id="is_cpu_or_mem_maxed_out-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3011</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_cpu_or_mem_maxed_out?</span>(<span class="ruby-identifier">language</span>)
  <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">@@secret</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;CPU used: #{stats['cpu']}, mem used: #{stats['memory']}&quot;</span>)

  <span class="ruby-identifier">current_cpu</span> = <span class="ruby-identifier">stats</span>[<span class="ruby-string">'cpu'</span>]
  <span class="ruby-identifier">max_cpu</span> = <span class="ruby-constant">MAX_CPU_FOR_APPSERVERS</span>[<span class="ruby-identifier">language</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_cpu</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max_cpu</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Not enough CPU is free to spawn up a new #{language} &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;AppServer (#{current_cpu} CPU used &gt; #{max_cpu} maximum)&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">current_mem</span> = <span class="ruby-constant">Float</span>(<span class="ruby-identifier">stats</span>[<span class="ruby-string">'memory'</span>])
  <span class="ruby-identifier">max_mem</span> = <span class="ruby-constant">MAX_MEM_FOR_APPSERVERS</span>[<span class="ruby-identifier">language</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_mem</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max_mem</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Not enough memory is free to spawn up a new &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{language} AppServer (#{current_mem} memory used &gt; #{max_mem} &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;maximum)&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Enough CPU and memory are free on this machine to &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;support a new #{language} AppServer&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_cpu_or_mem_maxed_out-3F-source -->
          
        </div>

        

        
      </div><!-- is_cpu_or_mem_maxed_out-3F-method -->

    
      <div id="method-i-is_done_initializing" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_done_initializing</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>A SOAP-exposed method that callers can use to determine if this node has
received information from another node and is starting up.</p>
          

          
          <div class="method-source-code" id="is_done_initializing-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 387</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_done_initializing</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-ivar">@done_initializing</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_done_initializing-source -->
          
        </div>

        

        
      </div><!-- is_done_initializing-method -->

    
      <div id="method-i-is_done_loading" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_done_loading</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>A SOAP-exposed method that callers use to determine if this node has
finished starting all the roles it should run when it initially starts.</p>
          

          
          <div class="method-source-code" id="is_done_loading-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 398</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_done_loading</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-ivar">@done_loading</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_done_loading-source -->
          
        </div>

        

        
      </div><!-- is_done_loading-method -->

    
      <div id="method-i-is_hybrid_cloud-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_hybrid_cloud?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_hybrid_cloud-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2267</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_hybrid_cloud?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;hybrid&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_hybrid_cloud-3F-source -->
          
        </div>

        

        
      </div><!-- is_hybrid_cloud-3F-method -->

    
      <div id="method-i-is_running-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_running?</span><span
            class="method-args">(name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_running-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2627</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_running?</span>(<span class="ruby-identifier">name</span>)
  <span class="ruby-operator">!</span><span class="ruby-node">%xps ax | grep #{name} | grep -v grep`</span>.<span class="ruby-identifier">empty?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_running-3F-source -->
          
        </div>

        

        
      </div><!-- is_running-3F-method -->

    
      <div id="method-i-job_start" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">job_start</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="job_start-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 759</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">job_start</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">start_infrastructure_manager</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">restore_appcontroller_state</span> 
    <span class="ruby-identifier">parse_creds</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">wait_for_data</span>
    <span class="ruby-identifier">parse_creds</span>
    <span class="ruby-identifier">change_job</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">start_neptune_manager</span>
  
  <span class="ruby-ivar">@done_loading</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">write_our_node_info</span>
  <span class="ruby-identifier">wait_for_nodes_to_finish_loading</span>(<span class="ruby-ivar">@nodes</span>)

  <span class="ruby-keyword">while</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@kill_sig_received</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Done starting up AppScale, now in heartbeat mode&quot;</span>
    <span class="ruby-identifier">write_database_info</span>
    <span class="ruby-identifier">write_zookeeper_locations</span>
    <span class="ruby-identifier">write_neptune_info</span> 
    <span class="ruby-identifier">update_api_status</span>
    <span class="ruby-identifier">send_logs_to_sisyphus</span>

    <span class="ruby-identifier">update_local_nodes</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_shadow?</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;my node is #{my_node}&quot;</span>)

      <span class="ruby-comment"># Since we now backup state to ZK, don't make everyone do it.</span>
      <span class="ruby-comment"># The Shadow has the most up-to-date info, so let it handle this</span>
      <span class="ruby-identifier">backup_appcontroller_state</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Login nodes host the AppLoadBalancer app, which has links to each</span>
    <span class="ruby-comment"># of the apps running in AppScale. Update the files it reads to</span>
    <span class="ruby-comment"># reflect the most up-to-date info.</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_login?</span>
      <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">get_status</span>(<span class="ruby-identifier">node</span>)
      }
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">ensure_all_roles_are_running</span>

    <span class="ruby-comment"># TODO: consider only calling this if new apps are found</span>
    <span class="ruby-identifier">start_appengine</span>
    <span class="ruby-identifier">scale_appservers</span>
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">20</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- job_start-source -->
          
        </div>

        

        
      </div><!-- job_start-method -->

    
      <div id="method-i-kill" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">kill</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="kill-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 423</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">kill</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@kill_sig_received</span> = <span class="ruby-keyword">true</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_hybrid_cloud?</span> 
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">terminate_hybrid_vms</span>(<span class="ruby-identifier">creds</span>)
    }
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_cloud?</span>
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-identifier">infrastructure</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>]
      <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">terminate_all_vms</span>(<span class="ruby-identifier">infrastructure</span>, <span class="ruby-identifier">keyname</span>)
    }
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># in xen/kvm deployments we actually want to keep the boxes</span>
    <span class="ruby-comment"># turned on since that was the state they started in</span>

    <span class="ruby-identifier">stop_ejabberd</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_login?</span>
    <span class="ruby-identifier">stop_sisyphus</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
    <span class="ruby-constant">Repo</span>.<span class="ruby-identifier">stop</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_shadow?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>

    <span class="ruby-identifier">jobs_to_run</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">jobs</span>
    <span class="ruby-identifier">commands</span> = {
      <span class="ruby-string">&quot;load_balancer&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;stop_load_balancer&quot;</span>,
      <span class="ruby-string">&quot;appengine&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;stop_appengine&quot;</span>,
      <span class="ruby-string">&quot;db_master&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;stop_db_master&quot;</span>,
      <span class="ruby-string">&quot;db_slave&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;stop_db_slave&quot;</span>,
      <span class="ruby-string">&quot;zookeeper&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;stop_zookeeper&quot;</span>
    }

    <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">job</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">commands</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">job</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;About to run [#{commands[job]}]&quot;</span>)
        <span class="ruby-identifier">send</span>(<span class="ruby-identifier">commands</span>[<span class="ruby-identifier">job</span>].<span class="ruby-identifier">to_sym</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Unable to find command for job #{job}. Skipping it.&quot;</span>)
      <span class="ruby-keyword">end</span>
    }

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_soap_server?</span>(<span class="ruby-identifier">my_node</span>)
      <span class="ruby-identifier">stop_soap_server</span>
      <span class="ruby-identifier">stop_pbserver</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">stop_neptune_manager</span>
    <span class="ruby-identifier">stop_infrastructure_manager</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">shutdown</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span>(<span class="ruby-constant">STATE_FILE</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;OK&quot;</span>  
<span class="ruby-keyword">end</span></pre>
          </div><!-- kill-source -->
          
        </div>

        

        
      </div><!-- kill-method -->

    
      <div id="method-i-load_neptune_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_neptune_info</span><span
            class="method-args">(file_to_load=NEPTUNE_INFO)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Loads Neptune data (stored in JSON format) into the instance variable
@neptune_info. Used to restore Neptune job data from a previously running
AppScale instance.</p>
          

          
          <div class="method-source-code" id="load_neptune_info-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1414</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_neptune_info</span>(<span class="ruby-identifier">file_to_load</span>=<span class="ruby-constant">NEPTUNE_INFO</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">file_to_load</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;No neptune data found - no need to restore&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Restoring neptune data!&quot;</span>)
  <span class="ruby-identifier">jobs_info</span> = (<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file_to_load</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span> }).<span class="ruby-identifier">chomp</span>
  <span class="ruby-identifier">jobs</span> = []

  <span class="ruby-identifier">json_data</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">jobs_info</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">json_data</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">num_jobs</span> = <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&quot;num_jobs&quot;</span>]

  <span class="ruby-identifier">num_jobs</span>.<span class="ruby-identifier">times</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">info</span> = <span class="ruby-identifier">json_data</span>[<span class="ruby-node">&quot;job_#{i}&quot;</span>]
    <span class="ruby-identifier">this_job</span> = <span class="ruby-constant">NeptuneJobData</span>.<span class="ruby-identifier">from_hash</span>(<span class="ruby-identifier">info</span>)
    <span class="ruby-identifier">job_name</span> = <span class="ruby-identifier">this_job</span>.<span class="ruby-identifier">name</span>

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@neptune_jobs</span>[<span class="ruby-identifier">job_name</span>].<span class="ruby-identifier">nil?</span>
      <span class="ruby-ivar">@neptune_jobs</span>[<span class="ruby-identifier">job_name</span>] = [<span class="ruby-identifier">this_job</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@neptune_jobs</span>[<span class="ruby-identifier">job_name</span>] = [<span class="ruby-identifier">this_job</span>]
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- load_neptune_info-source -->
          
        </div>

        

        
      </div><!-- load_neptune_info-method -->

    
      <div id="method-i-my_node" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">my_node</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="my_node-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2558</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">my_node</span>()
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@my_index</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">find_me_in_locations</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@my_index</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;My index is nil - is nodes nil? #{@nodes.nil?}&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;My nodes is nil also, timing error? race condition?&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Setting it to 0 position, even though it was not found&quot;</span>)
      <span class="ruby-comment"># pray its in the 0 position</span>
      <span class="ruby-keyword">return</span> <span class="ruby-ivar">@nodes</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@nodes</span>[<span class="ruby-ivar">@my_index</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- my_node-source -->
          
        </div>

        

        
      </div><!-- my_node-method -->

    
      <div id="method-i-parse_creds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parse_creds</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="parse_creds-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1906</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parse_creds</span>
  <span class="ruby-identifier">got_data_msg</span> = <span class="ruby-string">&quot;Got data from another node! DLoc = &quot;</span> <span class="ruby-operator">+</span>        <span class="ruby-node">&quot;#{@nodes.join(', ')}, #{@creds.inspect}, AppsToLoad = &quot;</span> <span class="ruby-operator">+</span>        <span class="ruby-node">&quot;#{@app_names.join(', ')}&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">got_data_msg</span>)
      
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;appengine&quot;</span>]
    <span class="ruby-ivar">@num_appengines</span> = <span class="ruby-constant">Integer</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;appengine&quot;</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Keypath is #{@creds['keypath']}, keyname is #{@creds['keyname']}&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;keypath&quot;</span>].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">my_key_dir</span> = <span class="ruby-node">&quot;/etc/appscale/keys/#{my_node.cloud}&quot;</span>
    <span class="ruby-identifier">my_key_loc</span> = <span class="ruby-node">&quot;#{my_key_dir}/#{@creds['keypath']}&quot;</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Creating directory #{my_key_dir} for my ssh key #{my_key_loc}&quot;</span>)
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">my_key_dir</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;cp /etc/appscale/ssh.key #{my_key_loc}&quot;</span>)
  <span class="ruby-keyword">end</span>
      
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_cloud?</span>
    <span class="ruby-comment"># for euca</span>
    <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_ACCESS_KEY'</span>] = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;ec2_access_key&quot;</span>]
    <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_SECRET_KEY'</span>] = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;ec2_secret_key&quot;</span>]
    <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_URL'</span>] = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;ec2_url&quot;</span>]

    <span class="ruby-comment"># for ec2</span>
    <span class="ruby-identifier">cloud_keys_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&quot;/etc/appscale/keys/cloud1&quot;</span>)
    <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_PRIVATE_KEY'</span>] = <span class="ruby-node">&quot;#{cloud_keys_dir}/mykey.pem&quot;</span>
    <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_CERT'</span>] = <span class="ruby-node">&quot;#{cloud_keys_dir}/mycert.pem&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">write_database_info</span>
  <span class="ruby-identifier">load_neptune_info</span>
  <span class="ruby-identifier">write_neptune_info</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parse_creds-source -->
          
        </div>

        

        
      </div><!-- parse_creds-method -->

    
      <div id="method-i-perform_scaling_for_appservers" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">perform_scaling_for_appservers</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Adds or removes AppServers within a node based on the number of requests
that each application has received as well as the number of requests that
are sitting in haproxy’s queue, waiting to be served.</p>
          

          
          <div class="method-source-code" id="perform_scaling_for_appservers-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2958</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">perform_scaling_for_appservers</span>()
  <span class="ruby-ivar">@apps_loaded</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">app_name</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">RESTRICTED_APPS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">app_name</span>)

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Deciding whether to scale AppServers for #{app_name}&quot;</span>)
      
    <span class="ruby-identifier">initialize_scaling_info_for_app</span>(<span class="ruby-identifier">app_name</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_cpu_or_mem_maxed_out?</span>(<span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:language</span>])
      <span class="ruby-comment"># TODO(cgb): This seems like a good condition to scale down</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Too much CPU or memory is being used - don't scale&quot;</span>)
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">get_scaling_info_for_app</span>(<span class="ruby-identifier">app_name</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">:scale_up</span>
      <span class="ruby-identifier">try_to_scale_up</span>(<span class="ruby-identifier">app_name</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">:scale_down</span>
      <span class="ruby-identifier">try_to_scale_down</span>(<span class="ruby-identifier">app_name</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;No change. Keeping the same number of AppServers&quot;</span>)
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- perform_scaling_for_appservers-source -->
          
        </div>

        

        
      </div><!-- perform_scaling_for_appservers-method -->

    
      <div id="method-i-post_logs_to_sisyphus" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">post_logs_to_sisyphus</span><span
            class="method-args">(host, logs_to_push)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="post_logs_to_sisyphus-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1689</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">post_logs_to_sisyphus</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">logs_to_push</span>)
  <span class="ruby-identifier">this_component</span> = {<span class="ruby-string">&quot;name&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;AppController&quot;</span>, <span class="ruby-string">&quot;ip&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>,
    <span class="ruby-string">&quot;logs&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">logs_to_push</span>}
  <span class="ruby-identifier">payload</span> = {<span class="ruby-value">:body</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:payload</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">this_component</span>)}}

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">send_response</span> = <span class="ruby-constant">JSONClient</span>.<span class="ruby-identifier">post</span>(<span class="ruby-node">&quot;http://#{host}/log&quot;</span>, <span class="ruby-identifier">payload</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Posting to Sisyphus saw an exception of class &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{e.class}&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Done pushing logs to Sisyphus, received a response&quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot; of #{send_response.inspect}&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- post_logs_to_sisyphus-source -->
          
        </div>

        

        
      </div><!-- post_logs_to_sisyphus-method -->

    
      <div id="method-i-remove_appserver_process" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_appserver_process</span><span
            class="method-args">(app)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Terminates a random AppServer that hosts the specified App Engine app.</p>
          

          
          <div class="method-source-code" id="remove_appserver_process-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3252</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_appserver_process</span>(<span class="ruby-identifier">app</span>)
  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Stopping an AppServer to free unused resources&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Deleting appserver instance to free up unused resources&quot;</span>)

  <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)
  <span class="ruby-identifier">warmup_url</span> = <span class="ruby-string">&quot;/&quot;</span>

  <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">app_number</span> = <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:nginx</span>] <span class="ruby-operator">-</span> <span class="ruby-constant">Nginx</span><span class="ruby-operator">::</span><span class="ruby-constant">START_PORT</span>

  <span class="ruby-identifier">app_data</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_app_data</span>(<span class="ruby-identifier">app</span>)

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Get app data for #{app} said [#{app_data}]&quot;</span>)

  <span class="ruby-identifier">app_is_enabled</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">does_app_exist?</span>(<span class="ruby-identifier">app</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;is app #{app} enabled? #{app_is_enabled}&quot;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_is_enabled</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;false&quot;</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Select a random AppServer to kill.</span>
  <span class="ruby-identifier">ports</span> = <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>]
  <span class="ruby-identifier">port</span> = <span class="ruby-identifier">ports</span>[<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">ports</span>.<span class="ruby-identifier">length</span>)]
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">stop_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">port</span>)

  <span class="ruby-comment"># Get PID for the AppServer to kill.</span>
  <span class="ruby-identifier">pid_file</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/#{app}-#{port}.pid&quot;</span>
  <span class="ruby-identifier">pid</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-identifier">pid_file</span>)

  <span class="ruby-comment"># Kill the AppServer in case god wasn't able to.</span>
  <span class="ruby-identifier">cmd</span> = <span class="ruby-node">&quot;kill -9 #{pid}&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">cmd</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Explicitly killed #{pid} for #{app} on port #{port}&quot;</span>)

  <span class="ruby-comment"># Finally, remove the PID file corresponding to that AppServer.</span>
  <span class="ruby-identifier">cmd</span> = <span class="ruby-node">&quot;rm #{pid_file}&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">cmd</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Deleted pid file #{pid_file}&quot;</span>)

  <span class="ruby-comment"># Delete the port number from the app_info_map</span>
  <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">port</span>)

  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">update_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>],
    <span class="ruby-identifier">my_public</span>)
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_appserver_process-source -->
          
        </div>

        

        
      </div><!-- remove_appserver_process-method -->

    
      <div id="method-i-remove_node_from_local_and_zookeeper" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_node_from_local_and_zookeeper</span><span
            class="method-args">(ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Removes information associated with the given IP address from our local
cache (@nodes) as well as the remote node storage mechanism (in ZooKeeper).</p>
          

          
          <div class="method-source-code" id="remove_node_from_local_and_zookeeper-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1874</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_node_from_local_and_zookeeper</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-comment"># First, remove our local copy</span>
  <span class="ruby-identifier">index_to_remove</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@nodes</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">public_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ip</span>
      <span class="ruby-identifier">index_to_remove</span> = <span class="ruby-identifier">i</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@nodes</span>[<span class="ruby-identifier">index_to_remove</span>])

  <span class="ruby-comment"># Then remove the remote copy</span>
  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">remove_node_information</span>(<span class="ruby-identifier">ip</span>)
  <span class="ruby-ivar">@last_updated</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">remove_ip_from_ip_list</span>(<span class="ruby-identifier">ip</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_node_from_local_and_zookeeper-source -->
          
        </div>

        

        
      </div><!-- remove_node_from_local_and_zookeeper-method -->

    
      <div id="method-i-remove_role" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_role</span><span
            class="method-args">(old_role, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_role-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 964</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_role</span>(<span class="ruby-identifier">old_role</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">remove_roles</span>(<span class="ruby-identifier">old_role</span>)
  <span class="ruby-identifier">stop_roles</span> = <span class="ruby-identifier">old_role</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
  <span class="ruby-identifier">stop_roles</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Removing and stopping role #{role}&quot;</span>)
    <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;stop_#{role}&quot;</span>.<span class="ruby-identifier">to_sym</span>)
  }
  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;OK&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_role-source -->
          
        </div>

        

        
      </div><!-- remove_role-method -->

    
      <div id="method-i-restore_appcontroller_state" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restore_appcontroller_state</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Restores the state of each of the instance variables that the AppController
holds by pulling it from ZooKeeper (previously populated by the Shadow
node, who always has the most up-to-date version of this data).</p>
          

          
          <div class="method-source-code" id="restore_appcontroller_state-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1470</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">restore_appcontroller_state</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Restoring AppController state from local file&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">ZK_LOCATIONS_FILE</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;No recovery data found - skipping recovery process&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">zookeeper_data</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">read_json_file</span>(<span class="ruby-constant">ZK_LOCATIONS_FILE</span>)
  <span class="ruby-identifier">json_state</span> = {}
  <span class="ruby-identifier">zookeeper_data</span>[<span class="ruby-string">'locations'</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Restoring AppController state from ZK at #{ip}&quot;</span>)
      <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">init_to_ip</span>(<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">ip</span>)
      <span class="ruby-identifier">json_state</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_appcontroller_state</span>()
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Saw exception of class #{e.class} from #{ip}, &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;trying next ZooKeeper node&quot;</span>)
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Got data #{json_state.inspect} successfully from #{ip}&quot;</span>)
    <span class="ruby-keyword">break</span>
  }

  <span class="ruby-identifier">@@secret</span> = <span class="ruby-identifier">json_state</span>[<span class="ruby-string">'@@secret'</span>]
  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">json_state</span>[<span class="ruby-string">'@creds'</span>][<span class="ruby-string">'keyname'</span>]

  <span class="ruby-identifier">json_state</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;@@secret&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;@nodes&quot;</span>
      <span class="ruby-identifier">v</span> = <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">convert_location_array_to_class</span>(<span class="ruby-identifier">v</span>, <span class="ruby-identifier">keyname</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;@neptune_nodes&quot;</span>
      <span class="ruby-identifier">new_v</span> = []

      <span class="ruby-identifier">v</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">new_v</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">NeptuneJobData</span>.<span class="ruby-identifier">from_hash</span>(<span class="ruby-identifier">data</span>)
      }        

      <span class="ruby-identifier">v</span> = <span class="ruby-identifier">new_v</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>)
  }

  <span class="ruby-comment"># Now that we've restored our state, update the pointer that indicates</span>
  <span class="ruby-comment"># which node in @nodes is ours</span>
  <span class="ruby-identifier">find_me_in_locations</span>

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- restore_appcontroller_state-source -->
          
        </div>

        

        
      </div><!-- restore_appcontroller_state-method -->

    
      <div id="method-i-restore_db_state_if_needed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restore_db_state_if_needed</span><span
            class="method-args">(dest_node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="restore_db_state_if_needed-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2364</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">restore_db_state_if_needed</span>(<span class="ruby-identifier">dest_node</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">is_db_master?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;restore_from_tar&quot;</span>]

  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">ssh_key</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Restoring DB, copying data to DB master at #{ip}&quot;</span>)
  <span class="ruby-identifier">db_tar_loc</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;restore_from_tar&quot;</span>]
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">scp_file</span>(<span class="ruby-identifier">db_tar_loc</span>, <span class="ruby-identifier">db_tar_loc</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- restore_db_state_if_needed-source -->
          
        </div>

        

        
      </div><!-- restore_db_state_if_needed-method -->

    
      <div id="method-i-restore_from_db-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restore_from_db?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="restore_from_db-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2279</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">restore_from_db?</span>
  <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'restore_from_tar'</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'restore_from_ebs'</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- restore_from_db-3F-source -->
          
        </div>

        

        
      </div><!-- restore_from_db-3F-method -->

    
      <div id="method-i-rsync_files" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rsync_files</span><span
            class="method-args">(dest_node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="rsync_files-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2430</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">rsync_files</span>(<span class="ruby-identifier">dest_node</span>)
  <span class="ruby-identifier">controller</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppController&quot;</span>
  <span class="ruby-identifier">server</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppServer&quot;</span>
  <span class="ruby-identifier">loadbalancer</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppLoadBalancer&quot;</span>
  <span class="ruby-identifier">appdb</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppDB&quot;</span>
  <span class="ruby-identifier">neptune</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/Neptune&quot;</span>
  <span class="ruby-identifier">loki</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/Loki&quot;</span>
  <span class="ruby-identifier">iaas_manager</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/InfrastructureManager&quot;</span>

  <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">ssh_key</span>
  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">dest_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">options</span> = <span class="ruby-node">&quot;-e 'ssh -i #{ssh_key}' -arv --filter '- *.pyc'&quot;</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} #{controller}/* root@#{ip}:#{controller}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} #{server}/* root@#{ip}:#{server}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} #{loadbalancer}/* root@#{ip}:#{loadbalancer}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} --exclude='logs/*' --exclude='hadoop-*' --exclude='hbase/hbase-*' --exclude='voldemort/voldemort/*' --exclude='cassandra/cassandra/*' #{appdb}/* root@#{ip}:#{appdb}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} #{neptune}/* root@#{ip}:#{neptune}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} #{loki}/* root@#{ip}:#{loki}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rsync #{options} #{iaas_manager}/* root@#{ip}:#{iaas_manager}&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- rsync_files-source -->
          
        </div>

        

        
      </div><!-- rsync_files-method -->

    
      <div id="method-i-run_neptune_in_cloud-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">run_neptune_in_cloud?</span><span
            class="method-args">(neptune_info)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>TODO: add neptune file, which will have this function</p>
          

          
          <div class="method-source-code" id="run_neptune_in_cloud-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1365</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">run_neptune_in_cloud?</span>(<span class="ruby-identifier">neptune_info</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Activecloud_info = #{neptune_info}&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_cloud?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">neptune_info</span>[<span class="ruby-string">&quot;nodes&quot;</span>].<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_cloud?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">neptune_info</span>[<span class="ruby-string">&quot;nodes&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">neptune_info</span>[<span class="ruby-string">&quot;machine&quot;</span>].<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- run_neptune_in_cloud-3F-source -->
          
        </div>

        

        
      </div><!-- run_neptune_in_cloud-3F-method -->

    
      <div id="method-i-sanitize_credentials" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sanitize_credentials</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="sanitize_credentials-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2024</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sanitize_credentials</span>()
  <span class="ruby-identifier">newcreds</span> = {}
  <span class="ruby-ivar">@creds</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">val</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">newkey</span> = <span class="ruby-identifier">key</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r[^\w\d_@-]/</span>, <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">key</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">newkey</span>.<span class="ruby-identifier">include?</span> <span class="ruby-string">&quot;_key&quot;</span>
      <span class="ruby-identifier">newval</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r[^\w\d\.\+:\/_-]/</span>, <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">newval</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r[^\w\d\.:\/_-]/</span>, <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">newcreds</span>[<span class="ruby-identifier">newkey</span>] = <span class="ruby-identifier">newval</span>
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">newcreds</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- sanitize_credentials-source -->
          
        </div>

        

        
      </div><!-- sanitize_credentials-method -->

    
      <div id="method-i-scale_appservers" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">scale_appservers</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method guards access to <a
href="Djinn.html#method-i-perform_scaling_for_appservers">#perform_scaling_for_appservers</a>
so that only  one thread call it at a time. We also only perform scaling if
the user  wants us to, and simply return otherwise.</p>
          

          
          <div class="method-source-code" id="scale_appservers-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2940</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">scale_appservers</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Not autoscaling, because we aren't an AppServer&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;autoscale&quot;</span>]
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Examining AppServers to autoscale them&quot;</span>)
    <span class="ruby-identifier">perform_scaling_for_appservers</span>()
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Not autoscaling AppServers - disallowed by the user&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- scale_appservers-source -->
          
        </div>

        

        
      </div><!-- scale_appservers-method -->

    
      <div id="method-i-send_logs_to_sisyphus" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">send_logs_to_sisyphus</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method empties the logs buffer that this AppController has accumulated
and pushes the logs to Sisyphus, an App Engine app that displays logs from
various components. IMPORTANT: Don’t write logs in the loop below,
otherwise an infinite loop will be created (since you’re pulling off
items at the same rate that you’re pushing items onto it).</p>
          

          
          <div class="method-source-code" id="send_logs_to_sisyphus-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1593</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">send_logs_to_sisyphus</span>
  <span class="ruby-keyword">return</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Popping logs off of @@log_buffer to send to Sisyphus&quot;</span>)

  <span class="ruby-identifier">retries_left</span> = <span class="ruby-value">3</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-ivar">@userappserver_private_ip</span>,  
      <span class="ruby-constant">UserAppClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SERVER_PORT</span>, <span class="ruby-constant">HelperFunctions</span><span class="ruby-operator">::</span><span class="ruby-constant">USE_SSL</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">except</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">retries_left</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Saw an exception of class #{except.class} when &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;trying to connect to UserAppServer - trying again shortly&quot;</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-identifier">retries_left</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">retry</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;UserAppServer at #{@userappserver_private_ip} &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;does not appear to be up - will try again later.&quot;</span>)
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)

  <span class="ruby-identifier">host</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">hosts</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_hosts_for_app</span>(<span class="ruby-string">&quot;sisyphus&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">zero?</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Nobody is currently hosting the Sisyphus app - &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;will try again later&quot;</span>)
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">host</span> = <span class="ruby-identifier">hosts</span>[<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">length</span>)]
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">retries_left</span> = <span class="ruby-value">3</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">host</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>, 
      <span class="ruby-constant">HelperFunctions</span><span class="ruby-operator">::</span><span class="ruby-constant">DONT_USE_SSL</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">except</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">retries_left</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Saw an exception of class #{except.class} when &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;trying to connect to Sisyphus (#{ip}:#{port}) - trying again &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;shortly&quot;</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-identifier">retries_left</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">retry</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Sisyphus at #{ip}:#{port} does not appear to be &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;up - will try again later.&quot;</span>)
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
 
  <span class="ruby-comment"># The first time around, we may not be registered with Sisyphus, so do</span>
  <span class="ruby-comment"># so now.</span>
  <span class="ruby-identifier">this_component</span> = {<span class="ruby-string">&quot;name&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;AppController&quot;</span>, <span class="ruby-string">&quot;ip&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>}
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@registered_with_sisyphus</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Not registered with Sisyphus, doing so now&quot;</span>)
    <span class="ruby-identifier">payload</span> = {<span class="ruby-string">&quot;payload&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>({<span class="ruby-string">&quot;components&quot;</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">this_component</span>]})}
    <span class="ruby-identifier">register_response</span> = <span class="ruby-constant">JSONClient</span>.<span class="ruby-identifier">post</span>(<span class="ruby-node">&quot;http://#{host}/component&quot;</span>, 
      <span class="ruby-value">:body</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">''</span>, <span class="ruby-value">:query</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">payload</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Done registering with Sisyphus, received a response&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot; of #{register_response.inspect}&quot;</span>)
    <span class="ruby-ivar">@registered_with_sisyphus</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># If Sisyphus isn't ready for requests, it may reject requests, so send</span>
  <span class="ruby-comment"># it a dummy log to see if it's ready for us</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">post_logs_to_sisyphus</span>(<span class="ruby-identifier">host</span>, [{<span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Dummy log message&quot;</span>, 
    <span class="ruby-value">:timestamp</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>}])
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Saw a problem pushing dummy log to Sisyphus - &quot;</span> <span class="ruby-operator">+</span> 
      <span class="ruby-string">&quot; will try again later.&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Now that we know that the Sisyphus app is up, dump our logs to it.</span>
  <span class="ruby-identifier">logs_to_push</span> = []
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">@@log_buffer</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">logs_to_push</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">@@log_buffer</span>.<span class="ruby-identifier">pop</span>
  }
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Sending #{logs_to_push.length} logs to Sisyphus&quot;</span>)
 
  <span class="ruby-comment"># do a POST /logs</span>
  <span class="ruby-identifier">post_logs_to_sisyphus</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">logs_to_push</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- send_logs_to_sisyphus-source -->
          
        </div>

        

        
      </div><!-- send_logs_to_sisyphus-method -->

    
      <div id="method-i-set_apps" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_apps</span><span
            class="method-args">(app_names, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Validates and sets the list of applications that should be loaded on this
node.</p>
          

          
          <div class="method-source-code" id="set_apps-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 560</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_apps</span>(<span class="ruby-identifier">app_names</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_names</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
    <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;app names was not an Array but was a #{app_names.class}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@app_names</span> = <span class="ruby-identifier">app_names</span>
  <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;App names is now #{@app_names.join(', ')}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_apps-source -->
          
        </div>

        

        
      </div><!-- set_apps-method -->

    
      <div id="method-i-set_parameters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_parameters</span><span
            class="method-args">(djinn_locations, database_credentials, app_names, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Validates and sets the instance variables that <a
href="Djinn.html">Djinn</a> needs before it can begin configuring and
deploying services on a given node (and if it is the first <a
href="Djinn.html">Djinn</a>, starting up the other Djinns).</p>
          

          
          <div class="method-source-code" id="set_parameters-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 485</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_parameters</span>(<span class="ruby-identifier">djinn_locations</span>, <span class="ruby-identifier">database_credentials</span>, <span class="ruby-identifier">app_names</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Djinn locations class: #{djinn_locations.class}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;DB Credentials class: #{database_credentials.class}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Apps to load class: #{app_names.class}&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">djinn_locations</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
    <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;Error: djinn_locations wasn't an Array, but was a &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-identifier">djinn_locations</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">msg</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">database_credentials</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
    <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;Error: database_credentials wasn't an Array, but was a &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-identifier">database_credentials</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">msg</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_names</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
    <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;Error: app_names wasn't an Array, but was a &quot;</span> <span class="ruby-operator">+</span> 
      <span class="ruby-identifier">app_names</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">msg</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># credentials is an array that we're converting to</span>
  <span class="ruby-comment"># hash tables, so we need to make sure that every key maps to a value</span>
  <span class="ruby-comment"># e.g., ['foo', 'bar'] becomes {'foo' =&gt; 'bar'}</span>
  <span class="ruby-comment"># so we need to make sure that the array has an even number of elements</span>
      
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">database_credentials</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">%</span> <span class="ruby-value">2</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">error_msg</span> = <span class="ruby-string">&quot;Error: DB Credentials wasn't of even length: Len = &quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-node">&quot;#{database_credentials.length}&quot;</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">error_msg</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">error_msg</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">possible_credentials</span> = <span class="ruby-constant">Hash</span>[*<span class="ruby-identifier">database_credentials</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_format_for_credentials</span>(<span class="ruby-identifier">possible_credentials</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;Error: Credential format wrong&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Parameters were valid&quot;</span>)

  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">possible_credentials</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
  <span class="ruby-ivar">@nodes</span> = <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">convert_location_array_to_class</span>(<span class="ruby-identifier">djinn_locations</span>, <span class="ruby-identifier">keyname</span>)
  <span class="ruby-ivar">@creds</span> = <span class="ruby-identifier">possible_credentials</span>
  <span class="ruby-ivar">@app_names</span> = <span class="ruby-identifier">app_names</span>
  
  <span class="ruby-identifier">convert_fqdns_to_ips</span>
  <span class="ruby-ivar">@creds</span> = <span class="ruby-identifier">sanitize_credentials</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;(set_parameters) locations: #{@nodes.join(', ')}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;(set_parameters) DB Credentials: #{HelperFunctions.obscure_creds(@creds).inspect}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Apps to load: #{@app_names.join(', ')}&quot;</span>)

  <span class="ruby-identifier">find_me_in_locations</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@my_index</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;Error: Couldn't find me in the node map&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;(set_parameters) My index = #{@my_index}&quot;</span>)

  <span class="ruby-constant">ENV</span>[<span class="ruby-string">'EC2_URL'</span>] = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'ec2_url'</span>]
  
  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;OK&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_parameters-source -->
          
        </div>

        

        
      </div><!-- set_parameters-method -->

    
      <div id="method-i-set_uaserver_ips" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_uaserver_ips</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="set_uaserver_ips-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1238</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_uaserver_ips</span>()
  <span class="ruby-identifier">ip_addr</span> = <span class="ruby-identifier">get_uaserver_ip</span>()
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_cloud?</span>
    <span class="ruby-ivar">@userappserver_public_ip</span> = <span class="ruby-identifier">ip_addr</span>
    <span class="ruby-ivar">@userappserver_private_ip</span> = <span class="ruby-identifier">ip_addr</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;\n\nUAServer is at [#{@userappserver_public_ip}]\n\n&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">keyname</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
  <span class="ruby-identifier">infrastructure</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;infrastructure&quot;</span>]    
 
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_hybrid_cloud?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Getting hybrid ips with creds #{@creds.inspect}&quot;</span>)
    <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_hybrid_ips</span>(<span class="ruby-ivar">@creds</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Getting cloud ips for #{infrastructure} with keyname &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{keyname}&quot;</span>)
    <span class="ruby-identifier">public_ips</span>, <span class="ruby-identifier">private_ips</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_cloud_ips</span>(<span class="ruby-identifier">infrastructure</span>, 
      <span class="ruby-identifier">keyname</span>)
  <span class="ruby-keyword">end</span>
 
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Public ips are #{public_ips.join(', ')}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Private ips are #{private_ips.join(', ')}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Looking for #{ip_addr}&quot;</span>)

  <span class="ruby-identifier">public_ips</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">node_public_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">public_ips</span>[<span class="ruby-identifier">index</span>])
    <span class="ruby-identifier">node_private_ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">convert_fqdn_to_ip</span>(<span class="ruby-identifier">private_ips</span>[<span class="ruby-identifier">index</span>])

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node_public_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ip_addr</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">node_private_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ip_addr</span>
      <span class="ruby-comment"># don't set the uaserver_public_ip to node_public_ip, as then the tools</span>
      <span class="ruby-comment"># won't be able to resolve that ip (it may be the same as the </span>
      <span class="ruby-comment"># unresolvable private ip)</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Setting uaserver public ip to #{public_ips[index]}&quot;</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Setting uaserver private ip to #{node_private_ip}&quot;</span>)
      <span class="ruby-ivar">@userappserver_public_ip</span> = <span class="ruby-identifier">public_ips</span>[<span class="ruby-identifier">index</span>]
      <span class="ruby-ivar">@userappserver_private_ip</span> = <span class="ruby-identifier">node_private_ip</span>
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">unable_to_convert_msg</span> = <span class="ruby-string">&quot;[get uaserver ip] Couldn't find out whether &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;#{ip_addr} was a public or private IP address. Public IPs are &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;[#{public_ips.join(', ')}], private IPs are [#{private_ips.join(', ')}]&quot;</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">unable_to_convert_msg</span>)
  <span class="ruby-identifier">abort</span>(<span class="ruby-identifier">unable_to_convert_msg</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_uaserver_ips-source -->
          
        </div>

        

        
      </div><!-- set_uaserver_ips-method -->

    
      <div id="method-i-setup_config_files" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">setup_config_files</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="setup_config_files-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2452</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">setup_config_files</span>()
    <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Setting up database configuration files&quot;</span>

    <span class="ruby-identifier">master_ip</span> = []
    <span class="ruby-identifier">slave_ips</span> = []

    <span class="ruby-comment"># load datastore helper</span>
    <span class="ruby-comment"># TODO: this should be the class or module</span>
    <span class="ruby-identifier">table</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]
    <span class="ruby-comment"># require db_file</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">require</span> <span class="ruby-node">&quot;#{APPSCALE_HOME}/AppDB/#{table}/#{table}_helper&quot;</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-identifier">backtrace</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
      <span class="ruby-identifier">bad_datastore_msg</span> = <span class="ruby-node">&quot;Unable to find #{table} helper.&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-node">&quot; Please verify datastore type: #{e}\n#{backtrace}&quot;</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">bad_datastore_msg</span>)
      <span class="ruby-identifier">abort</span>(<span class="ruby-identifier">bad_datastore_msg</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/AppDB/logs&quot;</span>)

    <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span> 
      <span class="ruby-identifier">master_ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;db_master&quot;</span>)
      <span class="ruby-identifier">slave_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;db_slave&quot;</span>)
    }

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Master is at #{master_ip}, slaves are at #{slave_ips.join(', ')}&quot;</span>)

    <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/my_public_ip&quot;</span>, <span class="ruby-node">&quot;#{my_public}\n&quot;</span>)

    <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/my_private_ip&quot;</span>, <span class="ruby-node">&quot;#{my_private}\n&quot;</span>)
   
    <span class="ruby-identifier">head_node_ip</span> = <span class="ruby-identifier">get_public_ip</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">'hostname'</span>])
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/head_node_ip&quot;</span>, <span class="ruby-node">&quot;#{head_node_ip}\n&quot;</span>)

    <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/login_ip&quot;</span>, <span class="ruby-node">&quot;#{login_ip}\n&quot;</span>)
    
    <span class="ruby-identifier">masters_file</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/masters&quot;</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">masters_file</span>, <span class="ruby-node">&quot;#{master_ip}\n&quot;</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@total_boxes</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">slave_ips</span> = [ <span class="ruby-identifier">my_private</span> ]
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-identifier">slave_ips_newlined</span> = <span class="ruby-identifier">slave_ips</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/slaves&quot;</span>, <span class="ruby-node">&quot;#{slave_ips_newlined}\n&quot;</span>)

    <span class="ruby-comment"># n = @creds[&quot;replication&quot;]</span>

    <span class="ruby-comment"># setup_hadoop_config(template_loc, hadoop_hbase_loc, master_ip, slave_ips, n)</span>

    <span class="ruby-comment"># Invoke datastore helper function</span>
    <span class="ruby-identifier">setup_db_config_files</span>(<span class="ruby-identifier">master_ip</span>, <span class="ruby-identifier">slave_ips</span>, <span class="ruby-ivar">@creds</span>)

    <span class="ruby-identifier">all_nodes</span> = <span class="ruby-string">&quot;&quot;</span>
    <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each_with_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">all_nodes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{node.private_ip} appscale-image#{index}\n&quot;</span>
    }
    
    <span class="ruby-identifier">etc_hosts</span> = <span class="ruby-string">&quot;/etc/hosts&quot;</span>
    <span class="ruby-identifier">my_hostname</span> = <span class="ruby-node">&quot;appscale-image#{@my_index}&quot;</span>
    <span class="ruby-identifier">etc_hostname</span> = <span class="ruby-string">&quot;/etc/hostname&quot;</span>

    <span class="ruby-identifier">new_etc_hosts</span> = <span class="ruby-string">&quot;127.0.0.1 localhost.localdomain localhost
127.0.1.1 localhost
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts
#{all_nodes}
&quot;</span>

    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">etc_hosts</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">new_etc_hosts</span>) }    
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">etc_hostname</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">my_hostname</span>) }

    <span class="ruby-comment"># on ubuntu jaunty, we can change the hostname by running hostname.sh</span>
    <span class="ruby-comment"># on karmic, this file doesn't exist - run /bin/hostname instead</span>
    <span class="ruby-comment"># TODO: does the fix for karmic hold for lucid?</span>

    <span class="ruby-identifier">jaunty_hostname_file</span> = <span class="ruby-string">&quot;/etc/init.d/hostname.sh&quot;</span>

    <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">jaunty_hostname_file</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;/etc/init.d/hostname.sh&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;/bin/hostname #{my_hostname}&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># use iptables to lock down outside traffic</span>
    <span class="ruby-comment"># nodes can talk to each other on any port</span>
    <span class="ruby-comment"># but only the outside world on certain ports</span>
    <span class="ruby-comment">#`iptables --flush`</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">FIREWALL_IS_ON</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;bash #{APPSCALE_HOME}/firewall.conf&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- setup_config_files-source -->
          
        </div>

        

        
      </div><!-- setup_config_files-method -->

    
      <div id="method-i-setup_hadoop_config_org" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">setup_hadoop_config_org</span><span
            class="method-args">(source_dir, dest_dir, master_ip, slave_ips, n)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>TODO: this function should use hadoop_helper</p>
          

          
          <div class="method-source-code" id="setup_hadoop_config_org-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2692</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">setup_hadoop_config_org</span>(<span class="ruby-identifier">source_dir</span>, <span class="ruby-identifier">dest_dir</span>, <span class="ruby-identifier">master_ip</span>, <span class="ruby-identifier">slave_ips</span>, <span class="ruby-identifier">n</span>)
  [<span class="ruby-string">&quot;source_dir&quot;</span>, <span class="ruby-string">&quot;dest_dir&quot;</span>, <span class="ruby-string">&quot;master_ip&quot;</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">param_name</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">param</span> = <span class="ruby-identifier">eval</span>(<span class="ruby-identifier">param_name</span>)
    <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;#{param_name} wasn't a String. It was a/an #{param.class}&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">param</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">String</span>
  }

  <span class="ruby-identifier">source_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">source_dir</span>)
  <span class="ruby-identifier">dest_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">dest_dir</span>)

  <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;Source dir [#{source_dir}] didn't exist&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">source_dir</span>)
  <span class="ruby-identifier">abort</span>(<span class="ruby-node">&quot;Dest dir [#{dest_dir}] didn't exist&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">dest_dir</span>)

  <span class="ruby-identifier">files_to_config</span> = <span class="ruby-node">%xls #{source_dir}`</span>.<span class="ruby-identifier">split</span>
  <span class="ruby-identifier">files_to_config</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">filename</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">full_path_to_read</span> = <span class="ruby-identifier">source_dir</span> <span class="ruby-operator">+</span> <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-constant">Separator</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">filename</span>
    <span class="ruby-identifier">full_path_to_write</span> = <span class="ruby-identifier">dest_dir</span> <span class="ruby-operator">+</span> <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-constant">Separator</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">filename</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">full_path_to_read</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">source_file</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">contents</span> = <span class="ruby-identifier">source_file</span>.<span class="ruby-identifier">read</span>
      <span class="ruby-identifier">contents</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">%rAPPSCALE-MASTER/</span>, <span class="ruby-identifier">master_ip</span>)
      <span class="ruby-identifier">contents</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">%rAPPSCALE-SLAVES/</span>, <span class="ruby-identifier">slave_ips</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>))
      <span class="ruby-identifier">contents</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">%rREPLICATION/</span>, <span class="ruby-identifier">n</span>)

      <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">full_path_to_write</span>, <span class="ruby-identifier">contents</span>)
    }
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- setup_hadoop_config_org-source -->
          
        </div>

        

        
      </div><!-- setup_hadoop_config_org-method -->

    
      <div id="method-i-spawn_and_setup_appengine" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">spawn_and_setup_appengine</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="spawn_and_setup_appengine-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2283</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">spawn_and_setup_appengine</span>()
  <span class="ruby-comment"># should also make sure the tools are on the vm and the envvars are set</span>

  <span class="ruby-identifier">table</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]

  <span class="ruby-identifier">nodes</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">deserialize_info_from_tools</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;ips&quot;</span>])
  <span class="ruby-identifier">appengine_info</span> = <span class="ruby-identifier">spawn_appengine</span>(<span class="ruby-identifier">nodes</span>)

  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Copying over needed files and starting the AppController on the other VMs&quot;</span>
  
  <span class="ruby-identifier">keyname</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>] 
  <span class="ruby-identifier">appengine_info</span> = <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">convert_location_array_to_class</span>(<span class="ruby-identifier">appengine_info</span>, <span class="ruby-identifier">keyname</span>)
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">appengine_info</span>)
  <span class="ruby-identifier">write_database_info</span>
  
  <span class="ruby-identifier">creds</span> = <span class="ruby-ivar">@creds</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">flatten</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Djinn locations: #{@nodes.join(', ')}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;DB Credentials: #{@creds.inspect}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Apps to load: #{@app_names.join(', ')}&quot;</span>)

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Appengine info: #{appengine_info}&quot;</span>)
  <span class="ruby-identifier">initialize_nodes_in_parallel</span>(<span class="ruby-identifier">appengine_info</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- spawn_and_setup_appengine-source -->
          
        </div>

        

        
      </div><!-- spawn_and_setup_appengine-method -->

    
      <div id="method-i-spawn_appengine" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">spawn_appengine</span><span
            class="method-args">(nodes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="spawn_appengine-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2307</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">spawn_appengine</span>(<span class="ruby-identifier">nodes</span>)
  <span class="ruby-identifier">appengine_info</span> = []
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_hybrid_cloud?</span>
      <span class="ruby-identifier">num_of_vms_needed</span> = <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">length</span>
      <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Spawning up hybrid virtual machines&quot;</span>
      <span class="ruby-identifier">appengine_info</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">spawn_hybrid_vms</span>(<span class="ruby-ivar">@creds</span>, <span class="ruby-identifier">nodes</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_cloud?</span>
      <span class="ruby-ivar">@state</span> = <span class="ruby-node">&quot;Spawning up #{nodes.length} virtual machines&quot;</span>
      <span class="ruby-identifier">roles</span> = <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">values</span>

      <span class="ruby-comment"># since there's only one cloud, call it cloud1 to tell us</span>
      <span class="ruby-comment"># to use the first ssh key (the only key)</span>
      <span class="ruby-identifier">imc</span> = <span class="ruby-constant">InfrastructureManagerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">@@secret</span>)
      <span class="ruby-identifier">appengine_info</span> = <span class="ruby-identifier">imc</span>.<span class="ruby-identifier">spawn_vms</span>(<span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">length</span>, <span class="ruby-ivar">@creds</span>, <span class="ruby-identifier">roles</span>, <span class="ruby-string">&quot;cloud1&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span>,<span class="ruby-identifier">roles</span><span class="ruby-operator">|</span>
        <span class="ruby-comment"># for xen the public and private ips are the same</span>
        <span class="ruby-comment"># and we call it cloud1 since the first key (only key)</span>
        <span class="ruby-comment"># is the key to use</span>

        <span class="ruby-identifier">info</span> = <span class="ruby-node">&quot;#{ip}:#{ip}:#{roles}:i-SGOOBARZ:cloud1&quot;</span>
        <span class="ruby-identifier">appengine_info</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">info</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Received appengine info: #{info}&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">appengine_info</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- spawn_appengine-source -->
          
        </div>

        

        
      </div><!-- spawn_appengine-method -->

    
      <div id="method-i-start_appcontroller" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_appcontroller</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_appcontroller-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2588</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_appcontroller</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">ssh_key</span>

  <span class="ruby-identifier">remote_home</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_remote_appscale_home</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-identifier">env</span> = {<span class="ruby-string">'APPSCALE_HOME'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">remote_home</span>}

  <span class="ruby-identifier">start</span> = <span class="ruby-node">&quot;ruby #{remote_home}/AppController/djinnServer.rb&quot;</span>
  <span class="ruby-identifier">stop</span> = <span class="ruby-node">&quot;ruby #{remote_home}/AppController/terminate.rb&quot;</span>

  <span class="ruby-comment"># remove any possible appcontroller state that may not have been</span>
  <span class="ruby-comment"># properly removed in non-cloud runs</span>
  <span class="ruby-identifier">remove_state</span> = <span class="ruby-string">&quot;rm -rf /etc/appscale/appcontroller-state.json&quot;</span>
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">run_remote_command</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">remove_state</span>, <span class="ruby-identifier">ssh_key</span>, <span class="ruby-constant">NO_OUTPUT</span>)

  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start_god</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">1</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">:controller</span>, <span class="ruby-identifier">start</span>, <span class="ruby-identifier">stop</span>, <span class="ruby-constant">SERVER_PORT</span>, <span class="ruby-identifier">env</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">ssh_key</span>)
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-constant">SERVER_PORT</span>, <span class="ruby-constant">USE_SSL</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">except</span>
    <span class="ruby-identifier">backtrace</span> = <span class="ruby-identifier">except</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
    <span class="ruby-identifier">remote_start_msg</span> = <span class="ruby-string">&quot;[remote_start] Unforeseen exception when &quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-node">&quot;talking to #{ip}: #{except}\nBacktrace: #{backtrace}&quot;</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">remote_start_msg</span>)
    <span class="ruby-keyword">retry</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Sending data to #{ip}&quot;</span>)
  <span class="ruby-identifier">acc</span> = <span class="ruby-constant">AppControllerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">@@secret</span>)

  <span class="ruby-identifier">loc_array</span> = <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">convert_location_class_to_array</span>(<span class="ruby-ivar">@nodes</span>)
  <span class="ruby-identifier">credentials</span> = <span class="ruby-ivar">@creds</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">flatten</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">acc</span>.<span class="ruby-identifier">set_parameters</span>(<span class="ruby-identifier">loc_array</span>, <span class="ruby-identifier">credentials</span>, <span class="ruby-ivar">@app_names</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;#{ip} responded with #{result}&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_appcontroller-source -->
          
        </div>

        

        
      </div><!-- start_appcontroller-method -->

    
      <div id="method-i-start_appengine" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_appengine</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_appengine-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2743</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_appengine</span>()
  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Preparing to run AppEngine apps if needed&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Starting appengine - pbserver is at [#{@userappserver_private_ip}]&quot;</span>)

  <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@restored</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-comment">#and restore_from_db?</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Need to restore&quot;</span>)
    <span class="ruby-identifier">app_list</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_all_apps</span>()
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;All apps are [#{app_list.join(', ')}]&quot;</span>)
    <span class="ruby-identifier">app_list</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">app</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">does_app_exist?</span>(<span class="ruby-identifier">app</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-constant">RESTRICTED_APPS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">app</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;App #{app} is enabled, so restoring it&quot;</span>)
        <span class="ruby-ivar">@app_names</span> = <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">app</span>]
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;App #{app} is not enabled, moving on&quot;</span>)
      <span class="ruby-keyword">end</span>
    }

    <span class="ruby-ivar">@app_names</span>.<span class="ruby-identifier">uniq!</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Decided to restore these apps: [#{@app_names.join(', ')}]&quot;</span>)
    <span class="ruby-ivar">@restored</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Don't need to restore&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">apps_to_load</span> = <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@apps_loaded</span> <span class="ruby-operator">-</span> [<span class="ruby-string">&quot;none&quot;</span>]
  <span class="ruby-identifier">apps_to_load</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">app</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">app_data</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_app_data</span>(<span class="ruby-identifier">app</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Get app data for #{app} said [#{app_data}]&quot;</span>)

    <span class="ruby-identifier">loop</span> {
      <span class="ruby-identifier">app_version</span> = <span class="ruby-identifier">app_data</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rversion:(\d+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Waiting for app data to have instance info for app named #{app}: #{app_data}&quot;</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;The app's version is #{app_version}, and its class is #{app_version.class}&quot;</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_data</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">4</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;Error&quot;</span>
        <span class="ruby-identifier">app_version</span> = <span class="ruby-string">&quot;0&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_version</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>
        <span class="ruby-identifier">app_version</span> = <span class="ruby-constant">Integer</span>(<span class="ruby-identifier">app_version</span>)
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">app_version</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">app_data</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_app_data</span>(<span class="ruby-identifier">app</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
    }

    <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
    <span class="ruby-identifier">app_version</span> = <span class="ruby-identifier">app_data</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rversion:(\d+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">app_language</span> = <span class="ruby-identifier">app_data</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%rlanguage:(\w+)/</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">to_s</span>
    
    <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>] = {}
    <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:language</span>] = <span class="ruby-identifier">app_language</span>

    <span class="ruby-comment"># TODO: merge these </span>
    <span class="ruby-identifier">shadow</span> = <span class="ruby-identifier">get_shadow</span>
    <span class="ruby-identifier">shadow_ip</span> = <span class="ruby-identifier">shadow</span>.<span class="ruby-identifier">private_ip</span>
    <span class="ruby-identifier">ssh_key</span> = <span class="ruby-identifier">shadow</span>.<span class="ruby-identifier">ssh_key</span>
    <span class="ruby-identifier">app_dir</span> = <span class="ruby-node">&quot;/var/apps/#{app}/app&quot;</span>
    <span class="ruby-identifier">app_path</span> = <span class="ruby-node">&quot;#{app_dir}/#{app}.tar.gz&quot;</span>
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">app_dir</span>)
     
    <span class="ruby-identifier">copy_app_to_local</span>(<span class="ruby-identifier">app</span>)
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">setup_app</span>(<span class="ruby-identifier">app</span>)

     
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_shadow?</span>
      <span class="ruby-constant">CronHelper</span>.<span class="ruby-identifier">update_cron</span>(<span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">app_language</span>, <span class="ruby-identifier">app</span>)
      <span class="ruby-identifier">start_xmpp_for_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_language</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">app_number</span> = <span class="ruby-ivar">@nginx_port</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Nginx</span><span class="ruby-operator">::</span><span class="ruby-constant">START_PORT</span>
    <span class="ruby-identifier">proxy_port</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
    <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_login?</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
      <span class="ruby-identifier">success</span> = <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">write_fullproxy_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">my_public</span>,
        <span class="ruby-identifier">my_private</span>, <span class="ruby-identifier">proxy_port</span>, <span class="ruby-identifier">login_ip</span>, <span class="ruby-identifier">get_all_appengine_nodes</span>())
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">success</span>
        <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;ERROR: Failure to create valid nginx config file for application #{app} full proxy.&quot;</span>)
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@nginx_port</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-ivar">@haproxy_port</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>


    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
      <span class="ruby-identifier">app_number</span> = <span class="ruby-ivar">@nginx_port</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Nginx</span><span class="ruby-operator">::</span><span class="ruby-constant">START_PORT</span>
      <span class="ruby-identifier">start_port</span> = <span class="ruby-constant">HelperFunctions</span><span class="ruby-operator">::</span><span class="ruby-constant">APP_START_PORT</span>
      <span class="ruby-identifier">static_handlers</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">parse_static_data</span>(<span class="ruby-identifier">app</span>)
      <span class="ruby-identifier">proxy_port</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
      <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>
      <span class="ruby-identifier">success</span> = <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">my_public</span>, 
        <span class="ruby-identifier">proxy_port</span>, <span class="ruby-identifier">static_handlers</span>, <span class="ruby-identifier">login_ip</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">success</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;ERROR: Failure to create valid nginx config file for application #{app}.&quot;</span>)
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app</span>)

      <span class="ruby-comment"># send a warmup request to the app to get it loaded - can shave a</span>
      <span class="ruby-comment"># number of seconds off the initial request if it's java or go</span>
      <span class="ruby-comment"># go provides a default warmup route</span>
      <span class="ruby-comment"># TODO: if the user specifies a warmup route, call it instead of /</span>
      <span class="ruby-identifier">warmup_url</span> = <span class="ruby-string">&quot;/&quot;</span>

      <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>] = []
      <span class="ruby-ivar">@num_appengines</span>.<span class="ruby-identifier">times</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Starting #{app_language} app #{app} on &quot;</span> <span class="ruby-operator">+</span>
          <span class="ruby-node">&quot;#{HelperFunctions.local_ip}:#{@appengine_port}&quot;</span>)
        <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@appengine_port</span>

        <span class="ruby-identifier">xmpp_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>
        <span class="ruby-identifier">pid</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">run_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-ivar">@appengine_port</span>, 
          <span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">get_load_balancer_ip</span>(), <span class="ruby-identifier">my_private</span>, 
          <span class="ruby-identifier">app_version</span>, <span class="ruby-identifier">app_language</span>, <span class="ruby-ivar">@nginx_port</span>, <span class="ruby-identifier">xmpp_ip</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">pid</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span>
          <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;ERROR: Unable to start application #{app}.&quot;</span>) 
          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">pid_file_name</span> = <span class="ruby-node">&quot;/etc/appscale/#{app}-#{@appengine_port}.pid&quot;</span>
        <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">pid_file_name</span>, <span class="ruby-identifier">pid</span>)

        <span class="ruby-identifier">location</span> = <span class="ruby-node">&quot;http://#{my_public}:#{@appengine_port}#{warmup_url}&quot;</span>
        <span class="ruby-identifier">wget_cmd</span> = <span class="ruby-node">&quot;wget #{WGET_OPTIONS} #{location}&quot;</span>
 
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">wget_cmd</span>)

        <span class="ruby-ivar">@appengine_port</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      }

      <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">update_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, 
        <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:appengine</span>], <span class="ruby-identifier">my_public</span>)
      <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
      <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">reload</span>
      <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">restart</span>

      <span class="ruby-identifier">loop</span> {
        <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
        <span class="ruby-identifier">success</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">add_instance</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">my_public</span>, <span class="ruby-ivar">@nginx_port</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Add instance returned #{success}&quot;</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">success</span>  
          <span class="ruby-comment"># tell ZK that we are hosting the app in case we die, so that</span>
          <span class="ruby-comment"># other nodes can update the UserAppServer on its behalf</span>
          <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">add_app_instance</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">my_public</span>, <span class="ruby-ivar">@nginx_port</span>)
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      }

      <span class="ruby-identifier">nginx</span> = <span class="ruby-ivar">@nginx_port</span>
      <span class="ruby-identifier">haproxy</span> = <span class="ruby-ivar">@haproxy_port</span>

      <span class="ruby-comment"># Update our local information so that we know later what ports</span>
      <span class="ruby-comment"># we're using to host this app on for nginx and haproxy</span>
      <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:nginx</span>] = <span class="ruby-ivar">@nginx_port</span>
      <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app</span>][<span class="ruby-value">:haproxy</span>] = <span class="ruby-ivar">@haproxy_port</span>

      <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>

      <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
        <span class="ruby-identifier">haproxy_location</span> = <span class="ruby-node">&quot;http://#{my_public}:#{haproxy}#{warmup_url}&quot;</span>
        <span class="ruby-identifier">nginx_location</span> = <span class="ruby-node">&quot;http://#{my_public}:#{nginx}#{warmup_url}&quot;</span>

        <span class="ruby-identifier">wget_haproxy</span> = <span class="ruby-node">&quot;wget #{WGET_OPTIONS} #{haproxy_location}&quot;</span>
        <span class="ruby-identifier">wget_nginx</span> = <span class="ruby-node">&quot;wget #{WGET_OPTIONS} #{nginx_location}&quot;</span>

        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">wget_haproxy</span>)
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-identifier">wget_nginx</span>)
      }

      <span class="ruby-ivar">@nginx_port</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-ivar">@haproxy_port</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

      <span class="ruby-comment"># now doing this at the real end so that the tools will</span>
      <span class="ruby-comment"># wait for the app to actually be running before returning</span>
      <span class="ruby-identifier">done_uploading</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_path</span>, <span class="ruby-identifier">@@secret</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">restart</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_shadow?</span>

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@app_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;none&quot;</span>)
      <span class="ruby-ivar">@apps_loaded</span> = <span class="ruby-ivar">@apps_loaded</span> <span class="ruby-operator">-</span> [<span class="ruby-string">&quot;none&quot;</span>]
      <span class="ruby-ivar">@app_names</span> = <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">-</span> [<span class="ruby-string">&quot;none&quot;</span>]
    <span class="ruby-keyword">end</span>
      
    <span class="ruby-ivar">@apps_loaded</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">app</span>
  }

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;#{apps_to_load.size} apps loaded&quot;</span>)  
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_appengine-source -->
          
        </div>

        

        
      </div><!-- start_appengine-method -->

    
      <div id="method-i-start_blobstore_server" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_blobstore_server</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_blobstore_server-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2177</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_blobstore_server</span>
  <span class="ruby-identifier">db_local_ip</span> = <span class="ruby-ivar">@userappserver_private_ip</span>
  <span class="ruby-identifier">my_ip</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-constant">BlobServer</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">db_local_ip</span>, <span class="ruby-constant">PbServer</span><span class="ruby-operator">::</span><span class="ruby-constant">LISTEN_PORT_NO_SSL</span>, <span class="ruby-identifier">my_ip</span>)
  <span class="ruby-constant">BlobServer</span>.<span class="ruby-identifier">is_running</span>(<span class="ruby-identifier">db_local_ip</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_blobstore_server-source -->
          
        </div>

        

        
      </div><!-- start_blobstore_server-method -->

    
      <div id="method-i-start_ejabberd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_ejabberd</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_ejabberd-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2643</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_ejabberd</span>()
  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Starting up XMPP server&quot;</span>
  <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-constant">Ejabberd</span>.<span class="ruby-identifier">stop</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;rm -f /var/lib/ejabberd/*&quot;</span>)
  <span class="ruby-constant">Ejabberd</span>.<span class="ruby-identifier">write_auth_script</span>(<span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">@@secret</span>)
  <span class="ruby-constant">Ejabberd</span>.<span class="ruby-identifier">write_config_file</span>(<span class="ruby-identifier">my_public</span>)
  <span class="ruby-constant">Ejabberd</span>.<span class="ruby-identifier">start</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_ejabberd-source -->
          
        </div>

        

        
      </div><!-- start_ejabberd-method -->

    
      <div id="method-i-start_hadoop_org" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_hadoop_org</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>TODO: this function should use hadoop_helper</p>
          

          
          <div class="method-source-code" id="start_hadoop_org-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2720</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_hadoop_org</span>()
  <span class="ruby-identifier">i</span> = <span class="ruby-identifier">my_node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">is_shadow?</span> <span class="ruby-comment"># change this later to db_master</span>
  <span class="ruby-identifier">hadoop_home</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/AppDB/hadoop-0.20.2/&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;#{hadoop_home}/bin/hadoop namenode -format 2&gt;&amp;1&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;#{hadoop_home}/bin/start-dfs.sh 2&gt;&amp;1&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;python #{hadoop_home}/../wait_on_hadoop.py 2&gt;&amp;1&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;#{hadoop_home}/bin/start-mapred.sh 2&gt;&amp;1&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_hadoop_org-source -->
          
        </div>

        

        
      </div><!-- start_hadoop_org-method -->

    
      <div id="method-i-start_infrastructure_manager" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_infrastructure_manager</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts the InfrastructureManager service on this machine, which exposes a
SOAP interface by which we can dynamically add and remove nodes in this
AppScale deployment.</p>
          

          
          <div class="method-source-code" id="start_infrastructure_manager-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 820</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_infrastructure_manager</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-string">&quot;localhost&quot;</span>, 
    <span class="ruby-constant">InfrastructureManagerClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SERVER_PORT</span>, <span class="ruby-constant">HelperFunctions</span><span class="ruby-operator">::</span><span class="ruby-constant">USE_SSL</span>)

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;InfrastructureManager is already running locally - &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;don't start it again.&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">start_cmd</span> = <span class="ruby-node">&quot;ruby #{APPSCALE_HOME}/InfrastructureManager/infrastructure_manager_server.rb&quot;</span>
  <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-string">&quot;pkill -9 infrastructure_manager_server&quot;</span>
  <span class="ruby-identifier">port</span> = [<span class="ruby-constant">InfrastructureManagerClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SERVER_PORT</span>]

  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">:iaas_manager</span>, <span class="ruby-identifier">start_cmd</span>, <span class="ruby-identifier">stop_cmd</span>, <span class="ruby-identifier">port</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Started InfrastructureManager successfully!&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_infrastructure_manager-source -->
          
        </div>

        

        
      </div><!-- start_infrastructure_manager-method -->

    
      <div id="method-i-start_load_balancer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_load_balancer</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_load_balancer-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2657</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_load_balancer</span>()
  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Starting up Load Balancer&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Starting up Load Balancer&quot;</span>)

  <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">create_app_load_balancer_config</span>(<span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">my_private</span>, 
    <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">proxy_port</span>)
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">create_app_load_balancer_config</span>(<span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">my_private</span>, 
    <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">proxy_port</span>)
  <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">start</span>
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">restart</span>
  <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">restart</span>

  <span class="ruby-identifier">head_node_ip</span> = <span class="ruby-identifier">get_public_ip</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">'hostname'</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_public</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">head_node_ip</span>
    <span class="ruby-comment"># Only start monitoring on the head node</span>
    <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">create_app_monitoring_config</span>(<span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">my_private</span>, 
      <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">proxy_port</span>)
    <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">create_app_monitoring_config</span>(<span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">my_private</span>, 
      <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">proxy_port</span>)
    <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">restart</span>
    <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">start</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">server_ports</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">port</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">sleep_until_port_is_open</span>(<span class="ruby-string">&quot;localhost&quot;</span>, <span class="ruby-identifier">port</span>)
    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">get_response</span>(<span class="ruby-node">&quot;localhost:#{port}&quot;</span>, <span class="ruby-string">'/'</span>)
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">SocketError</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_load_balancer-source -->
          
        </div>

        

        
      </div><!-- start_load_balancer-method -->

    
      <div id="method-i-start_memcache" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_memcache</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_memcache-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2631</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_memcache</span>()
  <span class="ruby-ivar">@state</span> = <span class="ruby-string">&quot;Starting up memcache&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Starting up memcache&quot;</span>)
  <span class="ruby-identifier">start_cmd</span> = <span class="ruby-string">&quot;/usr/bin/memcached -d -m 32 -p 11211 -u root&quot;</span>
  <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-string">&quot;pkill memcached&quot;</span>
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">:memcached</span>, <span class="ruby-identifier">start_cmd</span>, <span class="ruby-identifier">stop_cmd</span>, [<span class="ruby-value">11211</span>])
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_memcache-source -->
          
        </div>

        

        
      </div><!-- start_memcache-method -->

    
      <div id="method-i-start_neptune_manager" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_neptune_manager</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts the NeptuneManager service on this machine, which exposes a SOAP
interface by which we can run programs in arbitrary languages  in this
AppScale deployment.</p>
          

          
          <div class="method-source-code" id="start_neptune_manager-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 847</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_neptune_manager</span>
  <span class="ruby-identifier">write_cloud_info</span>()

  <span class="ruby-keyword">if</span> <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">is_port_open?</span>(<span class="ruby-string">&quot;localhost&quot;</span>, 
    <span class="ruby-constant">NeptuneManagerClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SERVER_PORT</span>, <span class="ruby-constant">HelperFunctions</span><span class="ruby-operator">::</span><span class="ruby-constant">USE_SSL</span>)

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;NeptuneManager is already running locally - &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;don't start it again.&quot;</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">start_cmd</span> = <span class="ruby-node">&quot;ruby #{APPSCALE_HOME}/Neptune/neptune_manager_server.rb&quot;</span>
  <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-string">&quot;pkill -9 neptune_manager_server&quot;</span>
  <span class="ruby-identifier">port</span> = [<span class="ruby-constant">NeptuneManagerClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SERVER_PORT</span>]
  <span class="ruby-identifier">env_vars</span> = {
    <span class="ruby-string">'APPSCALE_HOME'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">APPSCALE_HOME</span>,
    <span class="ruby-string">'DATABASE_USED'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]
  }

  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">:neptune_manager</span>, <span class="ruby-identifier">start_cmd</span>, <span class="ruby-identifier">stop_cmd</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">env_vars</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Started NeptuneManager successfully!&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_neptune_manager-source -->
          
        </div>

        

        
      </div><!-- start_neptune_manager-method -->

    
      <div id="method-i-start_new_roles_on_nodes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_new_roles_on_nodes</span><span
            class="method-args">(nodes_needed, instance_type, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Starts the given roles by using open nodes, spawning new nodes, or some
combination of the two. ‘nodes_needed’ should be an Array, where each 
item is an Array of the roles to start on each node.</p>
          

          
          <div class="method-source-code" id="start_new_roles_on_nodes-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 982</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_new_roles_on_nodes</span>(<span class="ruby-identifier">nodes_needed</span>, <span class="ruby-identifier">instance_type</span>, <span class="ruby-identifier">secret</span>)
   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">nodes_needed</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Was expecting nodes_needed to be an Array, not &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;a #{nodes_needed.class}&quot;</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_INPUT_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Received a request to acquire nodes with roles &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;#{nodes_needed.join(', ')}, with instance type #{instance_type} for &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot;new nodes&quot;</span>)

  <span class="ruby-identifier">vms_to_use</span> = []
  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">lock_and_run</span> {
    <span class="ruby-identifier">num_of_vms_needed</span> = <span class="ruby-identifier">nodes_needed</span>.<span class="ruby-identifier">length</span>

    <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_open?</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Will use node #{node} to run new roles&quot;</span>)
        <span class="ruby-identifier">vms_to_use</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">vms_to_use</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">nodes_needed</span>.<span class="ruby-identifier">length</span>
          <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Only using open nodes to run new roles&quot;</span>)
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    }

    <span class="ruby-identifier">vms_to_spawn</span> = <span class="ruby-identifier">nodes_needed</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vms_to_use</span>.<span class="ruby-identifier">length</span>
  
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">vms_to_spawn</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_cloud?</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Still need #{vms_to_spawn} more nodes, but we &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;aren't in a cloud environment, so we can't acquire more nodes - &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;failing the caller's request.&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-constant">NOT_ENOUGH_OPEN_NODES</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">vms_to_spawn</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Need to spawn up #{vms_to_spawn} VMs&quot;</span>)
      <span class="ruby-comment"># start up vms_to_spawn vms as open</span>
      <span class="ruby-identifier">imc</span> = <span class="ruby-constant">InfrastructureManagerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">@@secret</span>)
      <span class="ruby-identifier">new_nodes_info</span> = <span class="ruby-identifier">imc</span>.<span class="ruby-identifier">spawn_vms</span>(<span class="ruby-identifier">vms_to_spawn</span>, <span class="ruby-ivar">@creds</span>, <span class="ruby-string">&quot;open&quot;</span>, <span class="ruby-string">&quot;cloud1&quot;</span>)

      <span class="ruby-comment"># initialize them and wait for them to start up</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;info about new nodes is &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;[#{new_nodes_info.join(', ')}]&quot;</span>)
      <span class="ruby-identifier">add_nodes</span>(<span class="ruby-identifier">new_nodes_info</span>) 

      <span class="ruby-comment"># add information about the VMs we spawned to our list, which may</span>
      <span class="ruby-comment"># already have info about the open nodes we want to use</span>
      <span class="ruby-identifier">new_nodes</span> = <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">convert_location_array_to_class</span>(<span class="ruby-identifier">new_nodes_info</span>,
        <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'keyname'</span>])
      <span class="ruby-identifier">vms_to_use</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">new_nodes</span>
      <span class="ruby-identifier">vms_to_use</span>.<span class="ruby-identifier">flatten!</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">wait_for_nodes_to_finish_loading</span>(<span class="ruby-identifier">vms_to_use</span>)
  
  <span class="ruby-identifier">nodes_needed</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Adding roles #{nodes_needed[i].join(', ')} &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;to virtual machine #{vms_to_use[i]}&quot;</span>)
    <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">add_roles_to_node</span>(<span class="ruby-identifier">nodes_needed</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">vms_to_use</span>[<span class="ruby-identifier">i</span>])
  }

  <span class="ruby-identifier">wait_for_nodes_to_finish_loading</span>(<span class="ruby-identifier">vms_to_use</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;OK&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_new_roles_on_nodes-source -->
          
        </div>

        

        
      </div><!-- start_new_roles_on_nodes-method -->

    
      <div id="method-i-start_open" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_open</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_open-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3497</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_open</span>
  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_open-source -->
          
        </div>

        

        
      </div><!-- start_open-method -->

    
      <div id="method-i-start_pbserver" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_pbserver</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_pbserver-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2235</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_pbserver</span>
  <span class="ruby-identifier">db_master_ip</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">my_ip</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">db_master_ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_db_master?</span>
  }
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;db master ip was nil&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">db_master_ip</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">table</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]
  <span class="ruby-identifier">zoo_connection</span> = <span class="ruby-identifier">get_zk_connection_string</span>(<span class="ruby-ivar">@nodes</span>)
  <span class="ruby-constant">PbServer</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">db_master_ip</span>, <span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">my_ip</span>, <span class="ruby-identifier">table</span>, <span class="ruby-identifier">zoo_connection</span>)
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">create_pbserver_config</span>(<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>, <span class="ruby-constant">PbServer</span><span class="ruby-operator">::</span><span class="ruby-constant">PROXY_PORT</span>, <span class="ruby-identifier">table</span>)
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">create_pbserver_config</span>(<span class="ruby-identifier">my_ip</span>, <span class="ruby-constant">PbServer</span><span class="ruby-operator">::</span><span class="ruby-constant">PROXY_PORT</span>)
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">restart</span>()

  <span class="ruby-comment"># TODO check the return value</span>
  <span class="ruby-constant">PbServer</span>.<span class="ruby-identifier">is_running</span>(<span class="ruby-identifier">my_ip</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_pbserver-source -->
          
        </div>

        

        
      </div><!-- start_pbserver-method -->

    
      <div id="method-i-start_rabbitmq_master" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_rabbitmq_master</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_rabbitmq_master-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2187</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_rabbitmq_master</span>
  <span class="ruby-constant">RabbitMQ</span>.<span class="ruby-identifier">start_master</span>()      
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_rabbitmq_master-source -->
          
        </div>

        

        
      </div><!-- start_rabbitmq_master-method -->

    
      <div id="method-i-start_rabbitmq_slave" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_rabbitmq_slave</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_rabbitmq_slave-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2193</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_rabbitmq_slave</span>
  <span class="ruby-comment"># All slaves connect to the master to start</span>
  <span class="ruby-identifier">master_ip</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">master_ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_rabbitmq_master?</span>
  }

  <span class="ruby-constant">RabbitMQ</span>.<span class="ruby-identifier">start_slave</span>(<span class="ruby-identifier">master_ip</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_rabbitmq_slave-source -->
          
        </div>

        

        
      </div><!-- start_rabbitmq_slave-method -->

    
      <div id="method-i-start_shadow" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_shadow</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_shadow-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2735</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_shadow</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Starting Shadow role&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_shadow-source -->
          
        </div>

        

        
      </div><!-- start_shadow-method -->

    
      <div id="method-i-start_sisyphus" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_sisyphus</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_sisyphus-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3417</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_sisyphus</span>
  <span class="ruby-comment"># its just another app engine app - but since numbering starts</span>
  <span class="ruby-comment"># at zero, this app has to be app neg two</span>

  <span class="ruby-comment"># TODO: tell the tools to disallow uploading apps called 'sisyphus'</span>
  <span class="ruby-comment"># and start_appengine to do the same</span>
  <span class="ruby-comment"># TODO: this code is copy-pasted from repo - should be a way to</span>
  <span class="ruby-comment"># extract this code to a helper function of some kind</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Starting Sisyphus&quot;</span>)

  <span class="ruby-identifier">num_servers</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">app_number</span> = <span class="ruby-value">-2</span>
  <span class="ruby-identifier">nginx_port</span> = <span class="ruby-value">8078</span>
  <span class="ruby-identifier">start_port</span> = <span class="ruby-value">19994</span>
  <span class="ruby-identifier">app</span> = <span class="ruby-string">&quot;sisyphus&quot;</span>
  <span class="ruby-identifier">app_language</span> = <span class="ruby-string">&quot;python&quot;</span>
  <span class="ruby-identifier">app_version</span> = <span class="ruby-string">&quot;1&quot;</span>

  <span class="ruby-identifier">app_location</span> = <span class="ruby-node">&quot;/var/apps/#{app}/app&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;mkdir -p #{app_location}&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;cp -r #{APPSCALE_HOME}/AppServer/demos/sisyphus/* #{app_location}&quot;</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">setup_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">untar</span>=<span class="ruby-keyword">false</span>)

  <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">my_private</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>

  <span class="ruby-identifier">static_handlers</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">parse_static_data</span>(<span class="ruby-identifier">app</span>)
  <span class="ruby-identifier">proxy_port</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">proxy_port</span>, <span class="ruby-identifier">static_handlers</span>, <span class="ruby-identifier">login_ip</span>)
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">num_servers</span>, <span class="ruby-identifier">my_private</span>)
  <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app</span>)

  [<span class="ruby-value">19994</span>, <span class="ruby-value">19995</span>, <span class="ruby-value">19996</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">port</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Starting #{app_language} app #{app} on &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{HelperFunctions.local_ip}:#{port}&quot;</span>)
    <span class="ruby-identifier">pid</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">run_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">port</span>, <span class="ruby-ivar">@userappserver_private_ip</span>, 
      <span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">my_private</span>, <span class="ruby-identifier">app_version</span>, <span class="ruby-identifier">app_language</span>, <span class="ruby-identifier">nginx_port</span>, <span class="ruby-identifier">login_ip</span>)
    <span class="ruby-identifier">pid_file_name</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/#{app}-#{port}.pid&quot;</span>
    <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">pid_file_name</span>, <span class="ruby-identifier">pid</span>)
  }

  <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">restart</span>

  <span class="ruby-comment"># Register the application with the UserAppServer so that we can use the</span>
  <span class="ruby-comment"># AppLoadBalancer to route traffic to it, or let clients query the UAServer</span>
  <span class="ruby-comment"># to see where it's hosted.</span>
  <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)

  <span class="ruby-identifier">cloud_admin</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">cloud_admin</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_cloud_admin</span>()
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Registering Sisyphus with cloud admin #{cloud_admin}&quot;</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;No cloud admin found - waiting for the tools to &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;register one.&quot;</span>) 
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
    <span class="ruby-keyword">retry</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">commit_new_app_name</span>(<span class="ruby-identifier">cloud_admin</span>, <span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_language</span>)

  <span class="ruby-identifier">loop</span> {
    <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
    <span class="ruby-identifier">success</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">add_instance</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">my_public</span>, <span class="ruby-identifier">nginx_port</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Add instance returned #{success}&quot;</span>)
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">success</span>
  }

  <span class="ruby-ivar">@apps_loaded</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;sisyphus&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Done starting Sisyphus!&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_sisyphus-source -->
          
        </div>

        

        
      </div><!-- start_sisyphus-method -->

    
      <div id="method-i-start_soap_server" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_soap_server</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_soap_server-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2205</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_soap_server</span>
  <span class="ruby-identifier">db_master_ip</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">db_master_ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_db_master?</span>
  }
  <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;db master ip was nil&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">db_master_ip</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">db_local_ip</span> = <span class="ruby-ivar">@userappserver_private_ip</span>
          
  <span class="ruby-identifier">table</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]

  <span class="ruby-identifier">env_vars</span> = {}

  <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'APPSCALE_HOME'</span>] = <span class="ruby-constant">APPSCALE_HOME</span>
  <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'MASTER_IP'</span>] = <span class="ruby-identifier">db_master_ip</span>
  <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'LOCAL_DB_IP'</span>] = <span class="ruby-identifier">db_local_ip</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">table</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;simpledb&quot;</span>
    <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'SIMPLEDB_ACCESS_KEY'</span>] = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'SIMPLEDB_ACCESS_KEY'</span>]
    <span class="ruby-identifier">env_vars</span>[<span class="ruby-string">'SIMPLEDB_SECRET_KEY'</span>] = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">'SIMPLEDB_SECRET_KEY'</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">start_cmd</span> = [<span class="ruby-node">&quot;/usr/bin/python2.6 #{APPSCALE_HOME}/AppDB/soap_server.py&quot;</span>,
          <span class="ruby-node">&quot;-t #{table} -s #{HelperFunctions.get_secret}&quot;</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
  <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-string">&quot;pkill -9 soap_server&quot;</span>
  <span class="ruby-identifier">port</span> = [<span class="ruby-value">4343</span>]

  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">:uaserver</span>, <span class="ruby-identifier">start_cmd</span>, <span class="ruby-identifier">stop_cmd</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">env_vars</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_soap_server-source -->
          
        </div>

        

        
      </div><!-- start_soap_server-method -->

    
      <div id="method-i-start_xmpp_for_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_xmpp_for_app</span><span
            class="method-args">(app, app_language)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="start_xmpp_for_app-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3383</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_xmpp_for_app</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_language</span>)
  <span class="ruby-comment"># create xmpp account for the app</span>
  <span class="ruby-comment"># for app named baz, this translates to baz@login_ip</span>

  <span class="ruby-identifier">login_ip</span> = <span class="ruby-identifier">get_login</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">login_uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">login_ip</span>, <span class="ruby-identifier">@@secret</span>)
  <span class="ruby-identifier">xmpp_user</span> = <span class="ruby-node">&quot;#{app}@#{login_ip}&quot;</span>
  <span class="ruby-identifier">xmpp_pass</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">encrypt_password</span>(<span class="ruby-identifier">xmpp_user</span>, <span class="ruby-identifier">@@secret</span>)
  <span class="ruby-identifier">login_uac</span>.<span class="ruby-identifier">commit_new_user</span>(<span class="ruby-identifier">xmpp_user</span>, <span class="ruby-identifier">xmpp_pass</span>, <span class="ruby-string">&quot;app&quot;</span>)

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Created user [#{xmpp_user}] with password [#{@@secret}] and hashed password [#{xmpp_pass}]&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-constant">Ejabberd</span>.<span class="ruby-identifier">does_app_need_receive?</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">app_language</span>)
    <span class="ruby-identifier">start_cmd</span> = <span class="ruby-node">&quot;python #{APPSCALE_HOME}/AppController/xmpp_receiver.py #{app} #{login_ip} #{@@secret}&quot;</span>
    <span class="ruby-identifier">stop_cmd</span> = <span class="ruby-node">&quot;ps ax | grep '#{start_cmd}' | grep -v grep | awk '{print $1}' | xargs -d '\n' kill -9&quot;</span>
    <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">start_cmd</span>, <span class="ruby-identifier">stop_cmd</span>, <span class="ruby-value">9999</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;App #{app} does need xmpp receive functionality&quot;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;App #{app} does not need xmpp receive functionality&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_xmpp_for_app-source -->
          
        </div>

        

        
      </div><!-- start_xmpp_for_app-method -->

    
      <div id="method-i-status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">status</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="status-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 573</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">status</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">secret</span>)

    <span class="ruby-identifier">stats_str</span> = <span class="ruby-string">&quot;    Currently using #{stats['cpu']} Percent CPU and #{stats['memory']} Percent Memory
    Hard disk is #{stats['disk']} Percent full
    Is currently: #{stats['roles'].join(', ')}
    Database is at #{stats['db_location']}
    Is in cloud: #{stats['cloud']}
    Current State: #{stats['state']}
&quot;</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
      <span class="ruby-identifier">app_names</span> = []
      <span class="ruby-identifier">stats</span>[<span class="ruby-string">'apps'</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">app_names</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">k</span>
      }

      <span class="ruby-identifier">stats_str</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;    Hosting the following apps: #{app_names.join(', ')}\n&quot;</span>

      <span class="ruby-identifier">stats</span>[<span class="ruby-string">'apps'</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">is_loaded</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_loaded</span>

        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">nil?</span>
          <span class="ruby-identifier">stats_str</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;    The number of AppServers for app #{app_name} is: &quot;</span> <span class="ruby-operator">+</span>
            <span class="ruby-node">&quot;#{@app_info_map[app_name][:appengine].length}\n&quot;</span>
        <span class="ruby-keyword">end</span>
      }
    <span class="ruby-keyword">end</span>
 
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">stats_str</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- status-source -->
          
        </div>

        

        
      </div><!-- status-method -->

    
      <div id="method-i-stop_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_app</span><span
            class="method-args">(app_name, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_app-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 639</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_app</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">app_name</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">%r[^\w\d\-]/</span>, <span class="ruby-string">&quot;&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;(stop_app): Shutting down app named [#{app_name}]&quot;</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;rm -rf /var/apps/#{app_name}&quot;</span>)
 
  <span class="ruby-comment"># app shutdown process can take more than 30 seconds</span>
  <span class="ruby-comment"># so run it in a new thread to avoid 'execution expired'</span>
  <span class="ruby-comment"># error messages and have the tools poll it </span>
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-comment"># Tell other nodes to shutdown this application</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@app_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">app_name</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
      <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_appengine?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_login?</span>
          <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span>
          <span class="ruby-identifier">acc</span> = <span class="ruby-constant">AppControllerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">@@secret</span>)
          <span class="ruby-identifier">result</span> = <span class="ruby-identifier">acc</span>.<span class="ruby-identifier">stop_app</span>(<span class="ruby-identifier">app_name</span>)
          <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;(stop_app): Removing application #{app_name} --- #{ip} returned #{result} (#{result.class})&quot;</span>)
        <span class="ruby-keyword">end</span>
      }
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Contact the soap server and remove the application</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@app_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">app_name</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>) <span class="ruby-keyword">or</span> <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">ip</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/masters&quot;</span>)
      <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">@@secret</span>)
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">delete_app</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;(stop_app) Delete app: #{ip} returned #{result} (#{result.class})&quot;</span>)
    <span class="ruby-keyword">end</span>
   
    <span class="ruby-comment"># may need to stop XMPP listener</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_login?</span> 
      <span class="ruby-identifier">pid_files</span> = <span class="ruby-node">%xls #{APPSCALE_HOME}/.appscale/xmpp-#{app_name}.pid`</span>.<span class="ruby-identifier">split</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">pid_files</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># not an error here - XMPP is optional</span>
        <span class="ruby-identifier">pid_files</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pid_file</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">pid</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">read_file</span>(<span class="ruby-identifier">pid_file</span>)
          <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;kill -9 #{pid}&quot;</span>)
        }

        <span class="ruby-identifier">result</span> = <span class="ruby-string">&quot;true&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>    

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
      <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">remove</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">remove_app</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">remove_app</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">remove_app</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
      <span class="ruby-constant">Collectd</span>.<span class="ruby-identifier">restart</span>
      <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">remove_app_entry</span>(<span class="ruby-identifier">app_name</span>)

      <span class="ruby-comment"># If this node has any information about AppServers for this app,</span>
      <span class="ruby-comment"># clear that information out.</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>].<span class="ruby-identifier">nil?</span>
        <span class="ruby-ivar">@app_info_map</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">app_name</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># TODO God does not shut down the application, so do it here for </span>
      <span class="ruby-comment"># A temp fix.</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;ps -ef | grep dev_appserver | grep #{app_name} | grep -v grep | grep cookie_secret | awk '{print $2}' | xargs kill -9&quot;</span>)
      <span class="ruby-identifier">result</span> = <span class="ruby-string">&quot;true&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@apps_loaded</span> = <span class="ruby-ivar">@apps_loaded</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">app_name</span>]    
    <span class="ruby-ivar">@app_names</span> = <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">app_name</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@apps_loaded</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-ivar">@apps_loaded</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;none&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@app_names</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;none&quot;</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;true&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_app-source -->
          
        </div>

        

        
      </div><!-- stop_app-method -->

    
      <div id="method-i-stop_appengine" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_appengine</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_appengine-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3301</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_appengine</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Shutting down AppEngine&quot;</span>)

  <span class="ruby-identifier">uac</span> = <span class="ruby-constant">UserAppClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@userappserver_private_ip</span>, <span class="ruby-identifier">@@secret</span>)
  <span class="ruby-identifier">app_list</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_all_apps</span>()
  <span class="ruby-identifier">my_public</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;All apps are [#{app_list.join(', ')}]&quot;</span>)
  <span class="ruby-identifier">app_list</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">app</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">does_app_exist?</span>(<span class="ruby-identifier">app</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;App #{app} is enabled, so stopping it.&quot;</span>)
      <span class="ruby-identifier">hosts</span> = <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">get_hosts_for_app</span>(<span class="ruby-identifier">app</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;[Stop appengine] hosts for #{app} is [#{hosts.join(', ')}]&quot;</span>)
      <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">host</span><span class="ruby-operator">|</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;[Stop appengine] deleting instance for app #{app} at #{host}&quot;</span>)
        <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">host</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
        <span class="ruby-identifier">uac</span>.<span class="ruby-identifier">delete_instance</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>)
      }

      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Finished deleting instances for app #{app}&quot;</span>)
      <span class="ruby-comment">#Djinn.log_run(&quot;rm -fv /etc/nginx/#{app}.conf&quot;)</span>
      <span class="ruby-constant">Nginx</span>.<span class="ruby-identifier">reload</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;App #{app} wasnt enabled, skipping it&quot;</span>)
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-ivar">@app_names</span> = []
  <span class="ruby-ivar">@apps_loaded</span> = []
  <span class="ruby-ivar">@restored</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;pkill -f dev_appserver&quot;</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;pkill -f DevAppServerMain&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_appengine-source -->
          
        </div>

        

        
      </div><!-- stop_appengine-method -->

    
      <div id="method-i-stop_blob_server" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_blob_server</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_blob_server-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2254</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_blob_server</span>
  <span class="ruby-constant">BlobServer</span>.<span class="ruby-identifier">stop</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-string">&quot;pkill -f blobstore_server&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_blob_server-source -->
          
        </div>

        

        
      </div><!-- stop_blob_server-method -->

    
      <div id="method-i-stop_ejabberd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_ejabberd</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_ejabberd-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2653</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_ejabberd</span>()
  <span class="ruby-constant">Ejabberd</span>.<span class="ruby-identifier">stop</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_ejabberd-source -->
          
        </div>

        

        
      </div><!-- stop_ejabberd-method -->

    
      <div id="method-i-stop_infrastructure_manager" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_infrastructure_manager</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_infrastructure_manager-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 838</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_infrastructure_manager</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Stopping InfrastructureManager&quot;</span>)
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-value">:iaas_manager</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_infrastructure_manager-source -->
          
        </div>

        

        
      </div><!-- stop_infrastructure_manager-method -->

    
      <div id="method-i-stop_load_balancer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_load_balancer</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_load_balancer-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2730</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_load_balancer</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Shutting down Load Balancer&quot;</span>)
  <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">stop</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_load_balancer-source -->
          
        </div>

        

        
      </div><!-- stop_load_balancer-method -->

    
      <div id="method-i-stop_memcache" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_memcache</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_memcache-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2639</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_memcache</span>()
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-value">:memcached</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_memcache-source -->
          
        </div>

        

        
      </div><!-- stop_memcache-method -->

    
      <div id="method-i-stop_neptune_manager" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_neptune_manager</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_neptune_manager-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 881</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_neptune_manager</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Stopping NeptuneManager&quot;</span>)
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-value">:neptune_manager</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_neptune_manager-source -->
          
        </div>

        

        
      </div><!-- stop_neptune_manager-method -->

    
      <div id="method-i-stop_open" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_open</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_open-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3501</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_open</span>
  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_open-source -->
          
        </div>

        

        
      </div><!-- stop_open-method -->

    
      <div id="method-i-stop_pbserver" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_pbserver</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_pbserver-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2263</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_pbserver</span>
  <span class="ruby-constant">PbServer</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-ivar">@creds</span>[<span class="ruby-string">'table'</span>]) 
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_pbserver-source -->
          
        </div>

        

        
      </div><!-- stop_pbserver-method -->

    
      <div id="method-i-stop_shadow" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_shadow</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_shadow-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2739</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_shadow</span>()
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Stopping Shadow role&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_shadow-source -->
          
        </div>

        

        
      </div><!-- stop_shadow-method -->

    
      <div id="method-i-stop_sisyphus" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_sisyphus</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_sisyphus-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3492</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_sisyphus</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Stopping Sisyphus&quot;</span>)
  <span class="ruby-identifier">stop_app</span>(<span class="ruby-string">&quot;sisyphus&quot;</span>, <span class="ruby-identifier">@@secret</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_sisyphus-source -->
          
        </div>

        

        
      </div><!-- stop_sisyphus-method -->

    
      <div id="method-i-stop_soap_server" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop_soap_server</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop_soap_server-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2259</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">stop_soap_server</span>
  <span class="ruby-constant">GodInterface</span>.<span class="ruby-identifier">stop</span>(<span class="ruby-value">:uaserver</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop_soap_server-source -->
          
        </div>

        

        
      </div><!-- stop_soap_server-method -->

    
      <div id="method-i-try_to_scale_down" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_to_scale_down</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="try_to_scale_down-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3139</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_to_scale_down</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Considering whether we should scale down&quot;</span>)
  <span class="ruby-identifier">time_since_last_decision</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@last_decision</span>[<span class="ruby-identifier">app_name</span>]
  <span class="ruby-identifier">appservers_running</span> = <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">length</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_since_last_decision</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">SCALEDOWN_TIME_THRESHOLD</span> <span class="ruby-keyword">and</span>
    <span class="ruby-operator">!</span><span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-identifier">appservers_running</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">MIN_APPSERVERS_ON_THIS_NODE</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Removing an AppServer on this node for #{app_name}&quot;</span>)
    <span class="ruby-identifier">remove_appserver_process</span>(<span class="ruby-identifier">app_name</span>)
    <span class="ruby-ivar">@last_decision</span>[<span class="ruby-identifier">app_name</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-identifier">appservers_running</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">MIN_APPSERVERS_ON_THIS_NODE</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Only #{MIN_APPSERVERS_ON_THIS_NODE} AppServer(s) &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;running - don't kill&quot;</span>)
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">time_since_last_decision</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SCALEDOWN_TIME_THRESHOLD</span> 
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Last decision was taken within the time threshold&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- try_to_scale_down-source -->
          
        </div>

        

        
      </div><!-- try_to_scale_down-method -->

    
      <div id="method-i-try_to_scale_up" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_to_scale_up</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="try_to_scale_up-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 3115</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_to_scale_up</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Considering whether we should scale up&quot;</span>)
  <span class="ruby-identifier">time_since_last_decision</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@last_decision</span>[<span class="ruby-identifier">app_name</span>]
  <span class="ruby-identifier">appservers_running</span> = <span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">length</span>
        
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_since_last_decision</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">SCALEUP_TIME_THRESHOLD</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-operator">!</span><span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-identifier">appservers_running</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MAX_APPSERVERS_ON_THIS_NODE</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Adding a new AppServer on this node for #{app_name}&quot;</span>)
    <span class="ruby-identifier">add_appserver_process</span>(<span class="ruby-identifier">app_name</span>)
    <span class="ruby-ivar">@last_decision</span>[<span class="ruby-identifier">app_name</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">time_since_last_decision</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SCALEUP_TIME_THRESHOLD</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Not enough time has passed since when the last &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;scaling decision was made for #{app_name}&quot;</span>)
  <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@app_info_map</span>[<span class="ruby-identifier">app_name</span>][<span class="ruby-value">:appengine</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> 
    <span class="ruby-identifier">appservers_running</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">MAX_APPSERVERS_ON_THIS_NODE</span> 

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;The maximum number of AppServers for this app &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;are already running, so don't add any more&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- try_to_scale_up-source -->
          
        </div>

        

        
      </div><!-- try_to_scale_up-method -->

    
      <div id="method-i-update" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update</span><span
            class="method-args">(app_names, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="update-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 724</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>(<span class="ruby-identifier">app_names</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">BAD_SECRET_MSG</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">apps</span> = <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">app_names</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">app_names</span>
  
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">ip</span> = <span class="ruby-ivar">@nodes</span>[<span class="ruby-identifier">index</span>].<span class="ruby-identifier">private_ip</span>
    <span class="ruby-identifier">acc</span> = <span class="ruby-constant">AppControllerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">@@secret</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">acc</span>.<span class="ruby-identifier">set_apps</span>(<span class="ruby-identifier">apps</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Update #{ip} returned #{result} (#{result.class})&quot;</span>)
    <span class="ruby-ivar">@everyone_else_is_done</span> = <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
  }

  <span class="ruby-comment"># now that another app is running we can take out 'none' from the list</span>
  <span class="ruby-comment"># if it was there (e.g., run-instances with no app given)</span>
  <span class="ruby-ivar">@app_names</span> = <span class="ruby-ivar">@app_names</span> <span class="ruby-operator">-</span> [<span class="ruby-string">&quot;none&quot;</span>]
  
  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;OK&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update-source -->
          
        </div>

        

        
      </div><!-- update-method -->

    
      <div id="method-i-update_api_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_api_status</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="update_api_status-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1542</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_api_status</span>()
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">is_appengine?</span>
    <span class="ruby-identifier">repo_host</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">repo_host</span> = <span class="ruby-identifier">get_shadow</span>.<span class="ruby-identifier">private_ip</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">repo_url</span> = <span class="ruby-node">&quot;http://#{repo_host}:#{Repo::SERVER_PORT}/health/all&quot;</span>

  <span class="ruby-identifier">retries_left</span> = <span class="ruby-value">3</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">response</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">get_response</span>(<span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">repo_url</span>))
    <span class="ruby-identifier">data</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Update API was successful&quot;</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Update API status on host #{repo_host} saw exception #{e.class}&quot;</span>)
    <span class="ruby-identifier">data</span> = {}

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">retries_left</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
      <span class="ruby-identifier">retries_left</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">retry</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Repo at #{repo_host} appears to be down - will &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;try again later.&quot;</span>)
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Data received is #{data.inspect}&quot;</span>)

  <span class="ruby-identifier">majorities</span> = {}

  <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-ivar">@api_status</span>[<span class="ruby-identifier">k</span>] = [] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@api_status</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-ivar">@api_status</span>[<span class="ruby-identifier">k</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">v</span>
    <span class="ruby-ivar">@api_status</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">shorten_to_n_items</span>(<span class="ruby-value">10</span>, <span class="ruby-ivar">@api_status</span>[<span class="ruby-identifier">k</span>])
    <span class="ruby-identifier">majorities</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">find_majority_item</span>(<span class="ruby-ivar">@api_status</span>[<span class="ruby-identifier">k</span>])
  }

  <span class="ruby-identifier">json_state</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">majorities</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-constant">HEALTH_FILE</span>, <span class="ruby-identifier">json_state</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_api_status-source -->
          
        </div>

        

        
      </div><!-- update_api_status-method -->

    
      <div id="method-i-update_local_nodes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_local_nodes</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Queries ZooKeeper to see if our local copy of @nodes is out of date and
should be regenerated with up to date data from ZooKeeper. If data on our
node has changed, this starts or stops the necessary roles.</p>
          

          
          <div class="method-source-code" id="update_local_nodes-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1728</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_local_nodes</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Getting ZK lock to update @nodes&quot;</span>)

  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">lock_and_run</span> {
    <span class="ruby-comment"># See if the ZooKeeper data is newer than ours - if not, don't</span>
    <span class="ruby-comment"># update anything and return.</span>
    <span class="ruby-identifier">zk_ips_info</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_ip_info</span>()
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">zk_ips_info</span>[<span class="ruby-string">&quot;last_updated&quot;</span>] <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@last_updated</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Latest ZooKeeper data does not have newer data &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;than us. ZK timestamp is #{zk_ips_info['last_updated']}, our&quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot; timestamp  is #{@last_updated}&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;NOT UPDATED&quot;</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Updating data from ZK. Our timestamp, &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;#{@last_updated}, was older than the ZK timestamp, &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;#{zk_ips_info['last_updated']}&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">all_ips</span> = <span class="ruby-identifier">zk_ips_info</span>[<span class="ruby-string">&quot;ips&quot;</span>]
    <span class="ruby-identifier">new_nodes</span> = []
    <span class="ruby-identifier">all_ips</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ip</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">new_nodes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DjinnJobData</span>.<span class="ruby-identifier">deserialize</span>(
        <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">get_job_data_for_ip</span>(<span class="ruby-identifier">ip</span>))
    }

    <span class="ruby-identifier">old_roles</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">jobs</span>
    <span class="ruby-ivar">@nodes</span> = <span class="ruby-identifier">new_nodes</span>
    <span class="ruby-identifier">find_me_in_locations</span>
    <span class="ruby-identifier">new_roles</span> = <span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">jobs</span>

    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;My new nodes are [#{@nodes.join(', ')}], and my new &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;node is #{my_node}&quot;</span>)

    <span class="ruby-comment"># Since we're about to possibly load and unload roles, set done_loading</span>
    <span class="ruby-comment"># for our node to false, so that other nodes don't erroneously send us</span>
    <span class="ruby-comment"># additional roles to do while we're in this state where lots of side</span>
    <span class="ruby-comment"># effects are happening.</span>
    <span class="ruby-ivar">@done_loading</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">set_done_loading</span>(<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-keyword">false</span>)
 
    <span class="ruby-identifier">roles_to_start</span> = <span class="ruby-identifier">new_roles</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">old_roles</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">roles_to_start</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Need to start [#{roles_to_start.join(', ')}] &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;roles on this node&quot;</span>)
      <span class="ruby-identifier">roles_to_start</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
        <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Starting role #{role}&quot;</span>)
        <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;start_#{role}&quot;</span>.<span class="ruby-identifier">to_sym</span>)
      }
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">roles_to_stop</span> = <span class="ruby-identifier">old_roles</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">new_roles</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">roles_to_stop</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Need to stop [#{roles_to_stop.join(', ')}] &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;roles on this node&quot;</span>)
      <span class="ruby-identifier">roles_to_stop</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;stop_#{role}&quot;</span>.<span class="ruby-identifier">to_sym</span>)
      }
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># And now that we're done loading/unloading roles, set done_loading for</span>
    <span class="ruby-comment"># our node back to true.</span>
    <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">set_done_loading</span>(<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>, <span class="ruby-keyword">true</span>)
    <span class="ruby-ivar">@done_loading</span> = <span class="ruby-keyword">true</span>

    <span class="ruby-ivar">@last_updated</span> = <span class="ruby-identifier">zk_ips_info</span>[<span class="ruby-string">'last_updated'</span>]
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Releasing ZK lock to update @nodes, and updated &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;@last_updated to #{@last_updated}&quot;</span>)
  }

  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;UPDATED&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_local_nodes-source -->
          
        </div>

        

        
      </div><!-- update_local_nodes-method -->

    
      <div id="method-i-valid_format_for_credentials" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">valid_format_for_credentials</span><span
            class="method-args">(possible_credentials)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks to see if the credentials given to us (a Hash) have all the keys
that other methods expect to see.</p>
          

          
          <div class="method-source-code" id="valid_format_for_credentials-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2013</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">valid_format_for_credentials</span>(<span class="ruby-identifier">possible_credentials</span>)
  <span class="ruby-identifier">required_fields</span> = [<span class="ruby-string">&quot;table&quot;</span>, <span class="ruby-string">&quot;hostname&quot;</span>, <span class="ruby-string">&quot;ips&quot;</span>, <span class="ruby-string">&quot;keyname&quot;</span>]
  <span class="ruby-identifier">required_fields</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">possible_credentials</span>[<span class="ruby-identifier">field</span>]
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- valid_format_for_credentials-source -->
          
        </div>

        

        
      </div><!-- valid_format_for_credentials-method -->

    
      <div id="method-i-valid_secret-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">valid_secret?</span><span
            class="method-args">(secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="valid_secret-3F-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1228</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">valid_secret?</span>(<span class="ruby-identifier">secret</span>)
  <span class="ruby-identifier">@@secret</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">get_secret</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">secret</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">@@secret</span>
    <span class="ruby-identifier">failed_match_msg</span> = <span class="ruby-node">&quot;Incoming secret [#{secret}] failed to match &quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-node">&quot; known secret [#{@@secret}]&quot;</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">failed_match_msg</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">secret</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">@@secret</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- valid_secret-3F-source -->
          
        </div>

        

        
      </div><!-- valid_secret-3F-method -->

    
      <div id="method-i-validate_image" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate_image</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="validate_image-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2357</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">validate_image</span>(<span class="ruby-identifier">node</span>)
  <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>
  <span class="ruby-identifier">key</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">ssh_key</span>
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">ensure_image_is_appscale</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">ensure_db_is_supported</span>(<span class="ruby-identifier">ip</span>, <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;table&quot;</span>], <span class="ruby-identifier">key</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- validate_image-source -->
          
        </div>

        

        
      </div><!-- validate_image-method -->

    
      <div id="method-i-wait_for_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wait_for_data</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="wait_for_data-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1891</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">wait_for_data</span>()
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">got_all_data</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@kill_sig_received</span>
      <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;Received kill signal, aborting startup&quot;</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-identifier">msg</span>)
      <span class="ruby-identifier">abort</span>(<span class="ruby-identifier">msg</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Waiting for data from the load balancer or cmdline tools&quot;</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
    <span class="ruby-keyword">end</span>
  }

<span class="ruby-keyword">end</span></pre>
          </div><!-- wait_for_data-source -->
          
        </div>

        

        
      </div><!-- wait_for_data-method -->

    
      <div id="method-i-wait_for_nodes_to_finish_loading" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wait_for_nodes_to_finish_loading</span><span
            class="method-args">(nodes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="wait_for_nodes_to_finish_loading-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1056</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">wait_for_nodes_to_finish_loading</span>(<span class="ruby-identifier">nodes</span>)
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Waiting for nodes to finish loading&quot;</span>)

  <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">is_node_done_loading?</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>)
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Node at #{node.public_ip} has finished loading.&quot;</span>)
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Node at #{node.public_ip} has not yet finished &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;loading - will wait for it to finish.&quot;</span>)
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-value">30</span>)
      <span class="ruby-keyword">retry</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Nodes have finished loading&quot;</span>)
  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- wait_for_nodes_to_finish_loading-source -->
          
        </div>

        

        
      </div><!-- wait_for_nodes_to_finish_loading-method -->

    
      <div id="method-i-write_cloud_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_cloud_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_cloud_info-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 871</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">write_cloud_info</span>()
  <span class="ruby-identifier">cloud_info</span> = {
    <span class="ruby-string">'is_cloud?'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">is_cloud?</span>(), 
    <span class="ruby-string">'is_hybrid_cloud?'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">is_hybrid_cloud?</span>()
  }

  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_json_file</span>(<span class="ruby-string">&quot;/etc/appscale/cloud_info.json&quot;</span>, <span class="ruby-identifier">cloud_info</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_cloud_info-source -->
          
        </div>

        

        
      </div><!-- write_cloud_info-method -->

    
      <div id="method-i-write_database_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_database_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_database_info-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1372</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">write_database_info</span>()
  <span class="ruby-identifier">table</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;table&quot;</span>]
  <span class="ruby-identifier">replication</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;replication&quot;</span>]
  <span class="ruby-identifier">keyname</span> = <span class="ruby-ivar">@creds</span>[<span class="ruby-string">&quot;keyname&quot;</span>]
  
  <span class="ruby-identifier">tree</span> = { <span class="ruby-value">:table</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">table</span>, <span class="ruby-value">:replication</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">replication</span>, <span class="ruby-value">:keyname</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">keyname</span> }
  <span class="ruby-identifier">db_info_path</span> = <span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/database_info.yaml&quot;</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">db_info_path</span>, <span class="ruby-string">&quot;w&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">tree</span>, <span class="ruby-identifier">file</span>) }
  
  <span class="ruby-identifier">num_of_nodes</span> = <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/num_of_nodes&quot;</span>, <span class="ruby-node">&quot;#{num_of_nodes}\n&quot;</span>)
  
  <span class="ruby-identifier">all_ips</span> = []
  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Letting #{node.private_ip} through the firewall&quot;</span>)
    <span class="ruby-identifier">all_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">private_ip</span>
  }
  <span class="ruby-identifier">all_ips</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n&quot;</span>
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/all_ips&quot;</span>, <span class="ruby-identifier">all_ips</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>))

  <span class="ruby-comment"># Re-run the filewall script here since we just wrote the all_ips file</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">FIREWALL_IS_ON</span>
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_run</span>(<span class="ruby-node">&quot;bash #{APPSCALE_HOME}/firewall.conf&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_database_info-source -->
          
        </div>

        

        
      </div><!-- write_database_info-method -->

    
      <div id="method-i-write_hypersoap" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_hypersoap</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_hypersoap-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 2554</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">write_hypersoap</span>()
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-node">&quot;#{APPSCALE_HOME}/.appscale/hypersoap&quot;</span>, <span class="ruby-ivar">@userappserver_private_ip</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_hypersoap-source -->
          
        </div>

        

        
      </div><!-- write_hypersoap-method -->

    
      <div id="method-i-write_neptune_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_neptune_info</span><span
            class="method-args">(file_to_write=NEPTUNE_INFO)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Dumps all the info about Neptune jobs that have executed into a file, that
can be recovered later via load_neptune_info.</p>
          

          
          <div class="method-source-code" id="write_neptune_info-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1400</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">write_neptune_info</span>(<span class="ruby-identifier">file_to_write</span>=<span class="ruby-constant">NEPTUNE_INFO</span>)
  <span class="ruby-identifier">info</span> = { <span class="ruby-string">&quot;num_jobs&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@neptune_jobs</span>.<span class="ruby-identifier">length</span> }
  <span class="ruby-ivar">@neptune_jobs</span>.<span class="ruby-identifier">each_with_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">job</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">info</span>[<span class="ruby-node">&quot;job_#{index}&quot;</span>] = <span class="ruby-identifier">job</span>.<span class="ruby-identifier">to_hash</span>
  }

  <span class="ruby-identifier">json_info</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">info</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_file</span>(<span class="ruby-identifier">file_to_write</span>, <span class="ruby-identifier">json_info</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">json_info</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_neptune_info-source -->
          
        </div>

        

        
      </div><!-- write_neptune_info-method -->

    
      <div id="method-i-write_our_node_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_our_node_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Backs up information about what this node is doing (roles, apps it is
running) to ZooKeeper, for later recovery or updates by other nodes.</p>
          

          
          <div class="method-source-code" id="write_our_node_info-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1710</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">write_our_node_info</span>
  <span class="ruby-comment"># Since more than one AppController could write its data at the same </span>
  <span class="ruby-comment"># time, get a lock before we write to it.</span>
  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Getting ZK Lock&quot;</span>)

  <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">lock_and_run</span> {
    <span class="ruby-ivar">@last_updated</span> = <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">add_ip_to_ip_list</span>(<span class="ruby-identifier">my_node</span>.<span class="ruby-identifier">public_ip</span>)
    <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-string">&quot;Saving our node's information to ZooKeeper&quot;</span>)
    <span class="ruby-constant">ZKInterface</span>.<span class="ruby-identifier">write_node_information</span>(<span class="ruby-identifier">my_node</span>, <span class="ruby-ivar">@done_loading</span>)
  }

  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_our_node_info-source -->
          
        </div>

        

        
      </div><!-- write_our_node_info-method -->

    
      <div id="method-i-write_zookeeper_locations" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_zookeeper_locations</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Updates the file that says where all the ZooKeeper nodes are located so
that this node has the most up-to-date info if it needs to restore the data
down the line.</p>
          

          
          <div class="method-source-code" id="write_zookeeper_locations-source">
            <pre><span class="ruby-comment"># File AppController/djinn.rb, line 1526</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">write_zookeeper_locations</span>
  <span class="ruby-identifier">zookeeper_data</span> = { <span class="ruby-string">'last_updated_at'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@last_updated</span>,
    <span class="ruby-string">'locations'</span> =<span class="ruby-operator">&gt;</span> []
  }

  <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">is_zookeeper?</span>
      <span class="ruby-identifier">zookeeper_data</span>[<span class="ruby-string">'locations'</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">public_ip</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-constant">Djinn</span>.<span class="ruby-identifier">log_debug</span>(<span class="ruby-node">&quot;Writing ZooKeeper backup data #{zookeeper_data.inspect}&quot;</span>)
  <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">write_json_file</span>(<span class="ruby-constant">ZK_LOCATIONS_FILE</span>, <span class="ruby-identifier">zookeeper_data</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_zookeeper_locations-source -->
          
        </div>

        

        
      </div><!-- write_zookeeper_locations-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

